<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TDR DPA & 待ち時間 通知アプリ</title>
<link rel="manifest" href="/manifest.json">
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --mute:#94a3b8; --line:#1f2937; --accent:#38bdf8; --good:#22c55e; --bad:#ef4444; --warn:#fbbf24; }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  a{color:var(--accent)} header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .g{display:grid;gap:12px} .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:var(--ink);outline:none}
  button{cursor:pointer} .cta{background:var(--accent);color:#00111a;border:0;font-weight:800}
  .mut{color:var(--mute)} .mono{font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:middle}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:8px;color:var(--mute)}
  .tag.dpa{color:#93c5fd;border-color:#1e3a8a}.tag.pp{color:#a7f3d0;border-color:#064e3b}
  .good{color:var(--good)} .bad{color:var(--bad)} .fav{cursor:pointer}
  .plan{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;padding:10px;border-radius:12px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .w120{width:120px}
  .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center}
  .modal.on{display:flex}
  .card{background:#0b1220;border:1px solid var(--line);border-radius:16px;padding:18px;min-width:320px;max-width:420px}

  /* 待ち時間による色分け */
  .wait-low { color: var(--good); }
  .wait-med { color: var(--warn); }
  .wait-high { color: var(--bad); }

  /* フィルタボタンのトグル表示 */
  .filter-btn {
    background: var(--panel);
    border: 1px solid var(--line);
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  .filter-btn.active {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }
  .filter-btn input[type="checkbox"] { display: none; }

  /* お気に入りクイックアクセス */
  .favorites-quick {
    background: linear-gradient(135deg, #1e3a8a 0%, #111827 100%);
    border: 1px solid #2563eb;
  }
  .fav-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .fav-item {
    background: #0b1220;
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .fav-item .name {
    font-size: 12px;
    font-weight: 600;
  }
  .fav-item .wait-time {
    font-size: 18px;
    font-weight: 700;
  }
  .fav-item .status {
    font-size: 10px;
    color: var(--mute);
  }

  /* 混雑度インジケーター */
  .crowd-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #0b1220;
    border-radius: 12px;
    border: 1px solid var(--line);
  }
  .crowd-level {
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 8px;
  }
  .crowd-low { background: rgba(34, 197, 94, 0.2); color: var(--good); }
  .crowd-med { background: rgba(251, 191, 36, 0.2); color: var(--warn); }
  .crowd-high { background: rgba(239, 68, 68, 0.2); color: var(--bad); }

  /* スケルトンローディング */
  .skeleton {
    background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    height: 20px;
    margin: 4px 0;
  }
  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* DPAカウントダウン */
  .dpa-countdown {
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 6px;
    background: rgba(56, 189, 248, 0.2);
    color: var(--accent);
  }

  /* モバイル用下部ナビ */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #0b1220;
    border-top: 2px solid var(--line);
    display: none;
    grid-template-columns: repeat(4, 1fr);
    padding: 8px;
    z-index: 100;
  }
  .bottom-nav.show { display: grid; }
  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .nav-item:active { background: var(--panel); }
  .nav-icon { font-size: 20px; }
  .nav-label { font-size: 10px; color: var(--mute); }

  @media (max-width: 720px){
    .g2{ grid-template-columns: 1fr; }
    header .row{ gap:6px; flex-wrap:wrap; }
    header{ position: static !important; top:auto !important; }
    .row{ gap:6px; }
    input,select,button{ font-size:16px; }
    table{ display:block; overflow-x:auto; white-space:nowrap; font-size:14px; }
    th,td{ padding:6px 4px; }
    .bottom-nav { display: grid; }
    body { padding-bottom: 80px; }
  }

  /* デフォルトでカードを非表示 */
  .qt-cards { display: none; }
  
  /* モバイルのみカード表示 */
  @media (max-width: 480px) {
    #qt table { display: none !important; }
    .qt-cards { display: block !important; }
  }
  
  /* PCではテーブルのみ表示 */
  @media (min-width: 481px) {
    #qt table { display: table !important; }
    .qt-cards { display: none !important; }
  }

  .qt-cards { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .qt-card {
    background:#0b1220; border:1px solid var(--line); border-radius:12px; padding:12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .qt-card .title { font-weight:600; }
  .qt-card .meta { font-size:12px; }
  .qt-card .meta.open { color:var(--good); }
  .qt-card .meta.closed { color:var(--bad); }
  .qt-card .wait { font: 700 18px/1 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
  .qt-card .star { font-size:20px; cursor:pointer; }

  /* DPA/PP カード */
  .dpa-cards { display: none; }                /* デフォは非表示（PC） */
  .dpa-card {
    background:#0b1220; border:1px solid var(--line); border-radius:12px; padding:12px;
    display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
  }
  .dpa-card .title { font-weight:600; }
  .dpa-card .badges { display:flex; gap:6px; flex-wrap:wrap; }
  .dpa-card .when { font-size:12px; color:var(--mute); }
  .tag.good { color: var(--good);  border-color: #14532d; }
  .tag.bad  { color: var(--bad);   border-color: #7f1d1d; }
  .tag.warn { color: var(--warn);  border-color: #713f12; }
  
  /* スマホではカード表示、テーブル非表示 */
  @media (max-width: 480px) {
    #dpa table { display:none !important; }
    .dpa-cards { display:grid !important; grid-template-columns:1fr; gap:8px; }
  }

  .tag.stale{ border-color:#7f1d1d; color:#fca5a5 }
  .tag.fresh{ border-color:#1e3a8a; color:#93c5fd }

  /* プルリフレッシュ */
  .pull-refresh {
    position: fixed;
    top: -80px;
    left: 0;
    right: 0;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
    transition: transform 0.2s;
    z-index: 9;
  }
  .pull-refresh.show { transform: translateY(80px); }
  .pull-refresh.pulling { transition: none; }
  .pull-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid var(--line);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .pull-text { margin-left: 12px; color: var(--mute); }
  /* ==== UI: 一貫化テーマ & タブ/強調色 強化 ==== */

  /* 統一トーン（既存カラー変えずにアクセントだけ調整） */
  .badge { border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:12px; }
  .badge.on   { color: var(--good);  border-color:#14532d; background: rgba(34,197,94,.10); }
  .badge.off  { color: #9ca3af;     border-color:#374151; background: rgba(156,163,175,.10); }
  .badge.warn { color: var(--warn);  border-color:#713f12; background: rgba(251,191,36,.10); }
  
  .status-chip { font-weight:700; padding:2px 8px; border-radius:8px; }
  .status-open   { color: var(--good);  background: rgba(34,197,94,.15); }
  .status-closed { color: var(--bad);   background: rgba(239,68,68,.15); }
  
  /* DPA/PP 統一表示 */
  .dpa-on  { color: var(--good);  border-color:#14532d; }
  .dpa-end { color: #9ca3af;      border-color:#374151; }
  .pp-on   { color: #a78bfa;      border-color:#4c1d95; } /* PPは紫系で統一 */
  
  /* 見出し下にタブ（PC向け） */
  .tabs {
    display:flex; gap:8px; padding:8px 0; position:sticky; top:52px; z-index:9;
    background:#0b1220; border-bottom:1px solid var(--line);
  }
  .tab-btn {
    border:1px solid var(--line); border-radius:999px; padding:8px 14px; cursor:pointer;
    background:var(--panel); color:var(--ink); font-weight:600; transition:.2s;
  }
  .tab-btn.active { background: var(--accent); color:#000; border-color:var(--accent); }
  
  /* 下部ナビのアクティブ強調（モバイル） */
  .bottom-nav .nav-item.active { background: var(--panel); border:1px solid var(--accent); }
  
  /* カード影・角丸をやや強調 */
  .panel, .qt-card, .dpa-card, .card {
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    border-radius:16px;
  }
  
  /* テーブルのヘッダ強調 */
  thead th { color:#cbd5e1; font-weight:700; }
  
  /* 便利トグル（チップ風） */
  .pill.toggle { cursor:pointer; user-select:none; }
  .pill.toggle input[type="checkbox"]{ display:none; }
  .pill.toggle.active{ border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
  
  /* セクション間の余白 微調整 */
  .panel h3 { display:flex; align-items:center; gap:8px; }
  /* タイムライン表 */
  .timeline { border-collapse: collapse; width:100%; font-size: 12px; }
  .timeline th, .timeline td { border:1px solid #273244; padding:4px 6px; text-align:center; }
  .timeline .on  { background:#164e63; color:#a7f3d0; font-weight:700; }
  .timeline .off { background:#0b1220; color:#64748b; }
  .timeline .head { position:sticky; top:0; background:#0b1220; z-index:2; }
  /* タイムライン横スクロール用ラッパ */
  .timeline-wrap{
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* iOSなめらか */
    border: 1px solid var(--line);
    border-radius: 12px;
  }
  
  /* テーブルを“必要なだけ横に広げる” */
  .timeline{
    width: max-content;  /* 列数に応じて横方向へ拡張 */
    table-layout: fixed; /* セル折り返しを抑える */
    white-space: nowrap;
  }
  
  /* 先頭列（時刻）を固定して見やすく */
  .timeline th:first-child,
  .timeline td:first-child{
    position: sticky;
    left: 0;
    z-index: 1;
    background: #0b1220;
  }
  
  /* 列幅をコンパクトに */
  .timeline th, .timeline td{
    min-width: 80px;         /* 列幅（必要なら調整） */
    padding: 6px 8px;
    text-align: center;
  }
  
  /* モバイル時はさらに詰める＆スクロールバー見やすく */
  @media (max-width: 720px){
    .timeline th, .timeline td{ min-width: 72px; padding: 6px 6px; font-size: 12px; }
    .timeline-wrap{ margin: 0 -8px; padding: 0 8px; } /* 端までドラッグしやすく */
  }
  /* モバイル(PWA)は上タブを隠し、下のボトムナビだけにする */
  @media (max-width: 720px){
    .tabs{ display: none !important; }
  }
  /* ページ全体は横幅固定（表のはみ出しで画面幅が広がらないように） */
  html, body { max-width: 100%; overflow-x: hidden; }
  
  /* タイムライン横スクロール用ラッパ（ここが“横スクロール領域”） */
  .timeline-wrap{
    width: 100%;
    max-width: 100vw;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* iOSなめらか */
    border: 1px solid var(--line);
    border-radius: 12px;
  }
  
  /* テーブル自体は“必要なだけ横に広がる”。列が少ない時は100%を維持 */
  .timeline{
    width: max-content;     /* 列数に応じて横へ拡張 */
    min-width: 100%;        /* 少ない時はコンテナいっぱい */
    table-layout: fixed;    /* 折返し抑制＋高速描画 */
    white-space: nowrap;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  /* 先頭の「時刻」列は固定。leftの代わりに論理プロパティで描画崩れ回避 */
  .timeline th:first-child,
  .timeline td:first-child{
    position: sticky;
    inset-inline-start: 0;  /* left:0 相当（RTLでも安全） */
    background: #0b1220;
    z-index: 1;
  }
  
  /* 列幅をコンパクトに（必要に応じて数値調整） */
  .timeline th, .timeline td{
    min-width: 80px;
    padding: 6px 8px;
    text-align: center;
  }
  
  /* モバイル最適化：さらに詰める＆ドラッグしやすい余白 */
  @media (max-width: 720px){
    .timeline th, .timeline td{ min-width: 72px; padding: 6px 6px; font-size: 12px; }
    .timeline-wrap{ margin: 0 -8px; padding: 0 8px; } /* 端までドラッグOK */
  }
  /* 汎用：横スクロールする箱（中身だけ横に流れる） */
  .hscroll{
    width:100%;
    max-width:100vw;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    border:1px solid var(--line);
    border-radius:12px;
  }
  
  /* 汎用：箱の中の横に広がる表 */
  .hscroll-table{
    width:max-content;      /* 列が多いほど横へ拡張 */
    min-width:100%;         /* 列が少ない時は箱いっぱい */
    table-layout:fixed;
    white-space:nowrap;
    border-collapse:separate;
    border-spacing:0;
  }
  
  /* 先頭列を固定したい表に付与（sticky-first） */
  .sticky-first th:first-child,
  .sticky-first td:first-child{
    position:sticky;
    inset-inline-start:0;   /* left:0 相当 */
    background:#0b1220;
    z-index:1;
  }
  
  /* ページ幅は固定（表のはみ出しで画面幅を広げない） */
  html,body{ max-width:100%; overflow-x:hidden; }
  
  @media (max-width:720px){
    .hscroll{ margin:0 -8px; padding:0 8px; } /* 端までドラッグしやすく */
    .hscroll-table th,.hscroll-table td{ min-width:72px; padding:6px 6px; font-size:12px; }
  }

  /* 重要：モバイルでも hscroll-table はテーブル挙動のまま */
  .hscroll-table{ display: table !important; }

</style>
</head>
<body>
<div class="pull-refresh" id="pullRefresh">
  <div class="pull-spinner" id="pullSpinner" style="display:none"></div>
  <div class="pull-text" id="pullText">下に引っ張って更新</div>
</div>

<header><div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div><strong>🧭 TDR DPA & 待ち時間 通知</strong></div>
    <div class="row">
      <span id="userEmail" class="mut"></span>
      <button id="btnOpenLogin" class="cta">ログイン / 新規登録</button>
      <button id="btnLogout">ログアウト</button>
      <button id="btnInstall">アプリをインストール</button>
    </div>
  </div>
</div></header>
  
<nav class="tabs" id="topTabs">
  <button class="tab-btn active" data-target="qt">⏱ 待ち時間</button>
  <button class="tab-btn" data-target="dpa">🎫 DPA/PP</button>
  <button class="tab-btn" data-target="favs">⭐ お気に入り</button>
  <button class="tab-btn" data-target="schedule">📅 スケジュール</button>
</nav>

<main class="wrap g">
  <!-- 混雑度インジケーター -->
  <div class="crowd-indicator" id="crowdIndicator">
    <span>現在の混雑度:</span>
    <span class="crowd-level" id="crowdLevel">計測中...</span>
    <span id="avgWaitTime" class="mut"></span>
  </div>

  <!-- お気に入りクイックアクセス -->
  <section class="panel favorites-quick" id="favoritesQuick" style="display:none">
    <h3 style="margin-top:0">⭐ お気に入り施設</h3>
    <div class="fav-grid" id="favGrid"></div>
  </section>

  <section class="panel">
    <div class="row">
      <label>パーク：</label>
      <select id="park"><option value="274">東京ディズニーランド</option><option value="275">東京ディズニーシー</option></select>
      <button id="btnNotify" class="cta">プッシュ通知を有効化</button>
      <span class="mut">（ブラウザの通知を許可してください）</span>
    </div>
    <div class="row">
      <span class="pill">フィルタ：</span>
      <label class="filter-btn" id="filterDpaOnly"><input type="checkbox" id="fDpaOnly"> DPA対象のみ</label>
      <label class="filter-btn" id="filterKids"><input type="checkbox" id="fKids"> こども向け</label>
      <label class="filter-btn" id="filterFavOnly"><input type="checkbox" id="fFavOnly"> ★ お気に入りのみ</label>
      
      <label class="pill">待ち時間 ≤ <input type="number" id="fMaxWait" value="999" class="w120"> 分</label>
      
      <!-- 追加: ステータス / エリア / クイック -->
      <label class="pill toggle" id="tgOpenOnly"><input type="checkbox" id="fOpenOnly">運営中のみ</label>
      <label class="pill toggle" id="tgClosedOnly"><input type="checkbox" id="fClosedOnly">休止中のみ</label>
      <label class="pill">エリア
        <select id="areaSel"><option value="">すべて</option></select>
      </label>
      <button type="button" id="btnQuickEasy" class="pill">空いてる(≤20分)</button>
      <button type="button" id="btnQuickFavDpa" class="pill">★&DPA販売中</button>
      
      <label class="pill">並び順：
        <select id="sortBy">
          <option value="name">名前</option>
          <option value="wait">待ち時間（短い順）</option>
          <option value="wait_desc">待ち時間（長い順）</option>
          <option value="open">運営中を先に</option>
          <option value="fav_first">★を先に</option>
          <option value="dpa_first">DPA販売中を先に</option>
        </select>
      </label>
    </div>
  </section>

  <section class="g g2">
    <div class="panel">
      <h3 style="margin-top:0">⏱ 最新待ち時間</h3>
      <div class="row">
        <button id="btnRefresh" class="cta">最新の待ち時間を表示</button>
        <label class="pill"><input type="checkbox" id="autoRefresh" checked> 自動更新</label>
        <span id="qtUpdated" class="tag"></span>
        <span class="mut">サーバは1〜2分ごと保存</span>
      </div>
      <div id="qtLoading" style="display:none">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
      <div id="qt"></div>
      <div style="margin-top:10px">
        <strong>🎯 いま行くなら（お気に入りから）</strong>
        <div id="nowTips" class="mut">お気に入り（★）が未選択です。</div>
      </div>
    </div>
    <div class="panel">
      <h3 style="margin-top:0">🎫 DPA / PP ステータス</h3>
      <div class="row">
        <button id="btnFetchDpa" class="cta">最新を取得（約15秒）</button>
        <span class="pill">自動更新</span>
        <label class="pill"><input type="checkbox" id="fFavOnlyDpa"> お気に入りのみ</label>
        <label class="pill"><input type="checkbox" id="fDpaOnSale"> DPA販売中のみ</label>
        <label class="pill"><input type="checkbox" id="fPpOnSale"> PP発行中のみ</label>
        <label class="pill"><input type="checkbox" id="fShowAllDpa"> すべて表示</label>
        <span id="dpaUpdated" class="tag"></span>
        <label class="pill">並び順：
          <select id="sortByDpa">
            <option value="smart">販売/発行中を先に（既定）</option>
            <option value="name">名前</option>
            <option value="dpa">DPA販売中を先に</option>
            <option value="pp">PP発行中を先に</option>
            <option value="recent">更新が新しい順</option>
          </select>
        </label>
      </div>
      <div id="dpa"></div>
    </div>
  </section>
  <section class="panel" id="timelinePanel">
  <h3 style="margin-top:0">📊 今日の販売タイムライン（8:00–21:00 / 15分刻み）</h3>
  <div class="row" style="gap:8px;align-items:center">
    <label class="pill">対象
      <select id="tlKind">
        <option value="dpa">DPA（販売中）</option>
        <option value="pp">PP（発行中）</option>
      </select>
    </label>
    <span id="tlUpdated" class="tag"></span>
    </div>
    <div class="timeline-wrap" id="timelineWrap">
      <div id="timeline"></div>
    </div>
  </section>
  <section class="panel">
    <h3 style="margin-top:0">🔔 通知ルール</h3>
    <div class="row">
      <label class="pill"><input type="checkbox" id="rCloseReopen" checked> 休止/再開</label>
      <label class="pill"><input type="checkbox" id="rDpaSale" checked> DPA販売の変化（開始/終了）</label>
      <label class="pill">スパイク閾値（急変判定幅）±<input type="number" id="rSpike" value="20" class="w120"> 分</label>
      <label class="pill">DPA開始の <input type="number" id="rWindow" value="10" class="w120"> 分前に通知</label>
      <button id="btnSaveRules" class="cta">保存</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill">Pushover User Key</label>
      <input id="poKey" placeholder="例：uQiRzpo4DXghDmr9QzzfQu27cmVRsG" style="min-width:320px">
      <input id="poLabel" placeholder="端末名(任意)">
      <button id="btnSavePushover" class="cta">Pushoverキーを保存</button>
      <span class="mut">※登録するとネイティブ通知も受け取れます</span>
    </div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">⭐ お気に入り / プリセット</h3>
    <div class="row">
      <input id="presetName" placeholder="プリセット名">
      <button id="btnSavePreset" class="cta">現在の★をプリセット保存</button>
      <select id="presetSelect"></select>
      <button id="btnLoadPreset">プリセット読込</button>
    </div>
    <div id="favs" class="mut">★をクリックするとお気に入りに追加/解除できます。</div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">🧾 DPA購入管理（開始→終了は自動で+1時間 / スケジュールに自動反映）</h3>
    <div class="grid3">
      <div><label>施設</label><input id="buyName" list="dpaNames" placeholder="（候補からクリックでも入力）"></div>
      <div><label>開始</label><input id="buyStart" type="datetime-local"></div>
      <div><label>終了</label><input id="buyEnd" type="datetime-local"></div>
      <div><label>枚数</label><input id="buyQty" type="number" value="1"></div>
      <div><label>メモ</label><input id="buyNote"></div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAddPurchase" class="cta">登録</button>
        <span class="mut">※その日の「自動スケジュール」に即時追加されます</span>
      </div>
    </div>
    <div id="purchases"></div>
    <div id="autoSchedLink" class="mut" style="margin-top:8px"></div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">📅 手動スケジュール作成（回数指定＆固定イベント・簡易エリア最適化）</h3>
    <div class="row">
      <label>開始時刻</label><input id="startTime" type="time" value="09:00">
      <label>徒歩/移動(分)</label><input id="walk" type="number" value="10" class="w120">
      <button id="btnPlan" class="cta">生成して保存</button>
      <span id="shareLink" class="mut"></span>
    </div>

    <h4 style="margin:12px 0 6px">🎉 固定イベント（パレード/ショー）</h4>
    <div class="grid3" style="margin-bottom:8px">
      <div>
        <label>名称</label>
        <input id="evName" list="paradeNames" placeholder="例：デイ・パレード">
      </div>
      <div>
        <label>開始</label>
        <input id="evStart" type="datetime-local">
      </div>
      <div>
        <label>所要(分)</label>
        <input id="evDur" type="number" value="30">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAddEvent" class="cta">追加</button>
        <span class="mut">※固定イベントはこの時間を優先。待ち時間計算は使いません。</span>
      </div>
    </div>
    <div id="eventsList"></div>

    <h4 style="margin:12px 0 6px">🔢 回数指定（★が対象）</h4>
    <div id="counts"></div>

    <div id="planOut" class="plan" style="margin-top:10px"></div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">🔔 通知フィード</h3>
    <div id="feed"></div>
  </section>
</main>

<!-- モバイル用下部ナビ -->
<div class="bottom-nav" id="bottomNav">
  <div class="nav-item" data-target="qt">
    <span class="nav-icon">⏱</span>
    <span class="nav-label">待ち時間</span>
  </div>
  <div class="nav-item" data-target="dpa">
    <span class="nav-icon">🎫</span>
    <span class="nav-label">DPA/PP</span>
  </div>
  <div class="nav-item" data-target="favs">
    <span class="nav-icon">⭐</span>
    <span class="nav-label">お気に入り</span>
  </div>
  <div class="nav-item" data-target="schedule">
    <span class="nav-icon">📅</span>
    <span class="nav-label">スケジュール</span>
  </div>
</div>

<datalist id="dpaNames"></datalist>
<datalist id="paradeNames"></datalist>

<div class="modal" id="loginModal">
  <div class="card">
    <h3 style="margin-top:0">ログイン / 新規登録</h3>
    <p class="mut">メールアドレスを入力すると、ログイン用のリンクをお送りします。</p>

    <div class="row" id="emailRow">
      <input id="loginEmail" type="email" placeholder="your@email.com" style="flex:1">
    </div>

    <div class="row" style="gap:6px;margin-top:8px">
      <label class="pill"><input type="radio" name="loginMode" id="modeEmail" checked> メールリンク</label>
      <label class="pill"><input type="radio" name="loginMode" id="modePw"> ID/パスワード</label>
    </div>

    <div id="pwBox" style="display:none;margin-top:8px">
      <div class="row"><input id="loginId" placeholder="メール or ユーザーID" style="flex:1"></div>
      <div class="row"><input id="loginPw" type="password" placeholder="パスワード" style="flex:1"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnSigninPw" class="cta">ログイン</button>
        <button id="btnSignupPw">新規登録</button>
      </div>
    </div>

    <div class="row" id="emailActionRow" style="justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="btnCloseLogin">閉じる</button>
      <button id="btnSendLink" class="cta">リンクを送信</button>
    </div>
  </div>
</div>

<script src="/.netlify/functions/env"></script>
<script type="module">
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
  navigator.serviceWorker.getRegistration().then(reg => {
    if (!reg || !reg.waiting) return;
    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    reg.waiting.addEventListener('statechange', e => {
      if (e.target.state === 'activated') location.reload();
    });
  });
}

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

const ENV = window.ENV || {};
const ALIAS_DOMAIN = (ENV.ALIAS_EMAIL_DOMAIN || 'user.local').toLowerCase();
const emailFromId = (id)=> id.toLowerCase() + '@' + ALIAS_DOMAIN;

const safeStorage = (()=> {
  try { const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
  catch(e){ let mem={}; return { getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=v}, removeItem:k=>{delete mem[k]} }; }
})();

const supabase = createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: safeStorage, storageKey: 'tdr-sb' }
});
await supabase.auth.getSession();
supabase.auth.onAuthStateChange((event) => {
  if (event === 'SIGNED_IN' && location.hash.includes('access_token')) {
    history.replaceState({}, '', location.pathname + location.search);
  }
});

let deferredPrompt=null;
const btnInstall = document.getElementById('btnInstall');
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.disabled=false; });
btnInstall.disabled = isIOS ? false : true;
btnInstall.onclick = async()=>{
  if (isIOS && !isStandalone) { alert('iPhoneは「共有」→「ホーム画面に追加」でインストール'); return; }
  if (!deferredPrompt){ alert('インストール条件が未満です。しばらくして再試行してください。'); return; }
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
};

const userEmail = document.getElementById('userEmail');
const btnOpenLogin = document.getElementById('btnOpenLogin');
const btnLogout = document.getElementById('btnLogout');
const loginModal = document.getElementById('loginModal');

const loginEmail = document.getElementById('loginEmail');
const emailRow = document.getElementById('emailRow');
const emailActionRow = document.getElementById('emailActionRow');
const btnSendLink = document.getElementById('btnSendLink');

const modeEmail = document.getElementById('modeEmail');
const modePw    = document.getElementById('modePw');
const pwBox     = document.getElementById('pwBox');
const loginId   = document.getElementById('loginId');
const loginPw   = document.getElementById('loginPw');
const btnSigninPw = document.getElementById('btnSigninPw');
const btnSignupPw = document.getElementById('btnSignupPw');

const poKey = document.getElementById('poKey');
const poLabel = document.getElementById('poLabel');
const btnSavePushover = document.getElementById('btnSavePushover');

document.getElementById('btnCloseLogin').onclick = () => loginModal.classList.remove('on');
btnLogout.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

// Pushover の User Key を保存（ログイン時= user_id / 未ログイン= device_id）
async function savePushoverKey() {
  const key = (poKey?.value || '').trim();
  const label = (poLabel?.value || '').trim();
  if (!key) { alert('User Key を入力してください'); return; }

  const { data:{ user } } = await supabase.auth.getUser();
  const row = user
    ? { user_id: user.id, user_key: key, label }
    : { device_id: deviceId, user_key: key, label };

  // まず INSERT
  let { error } = await supabase.from('pushover_profiles').insert(row);
  // 一意制約違反(23505)なら UPDATE に切替
  if (error && /23505/.test(error.code || '') ) {
    if (user) {
      ({ error } = await supabase.from('pushover_profiles')
        .update({ user_key: key, label })
        .eq('user_id', user.id));
    } else {
      ({ error } = await supabase.from('pushover_profiles')
        .update({ user_key: key, label })
        .eq('device_id', deviceId));
    }
  }
  if (error) { alert('保存に失敗: ' + (error.message || 'unknown')); return; }
  alert('Pushoverキーを保存しました');
}


btnSavePushover?.addEventListener('click', savePushoverKey);


function applyLoginMode(){
  const usePw = modePw?.checked;
  if (pwBox) pwBox.style.display = usePw ? 'block' : 'none';
  if (emailRow) emailRow.style.display = usePw ? 'none' : 'flex';
  if (emailActionRow) emailActionRow.style.display = usePw ? 'none' : 'flex';
}
if (modeEmail && modePw) { modeEmail.onchange = modePw.onchange = applyLoginMode; }
btnOpenLogin.onclick = () => {
  if (modePw) modePw.checked = true;
  if (modeEmail) modeEmail.checked = false;
  applyLoginMode();
  loginModal.classList.add('on');
  if (loginId) loginId.focus();
};
btnSendLink.onclick = async () => {
  const email = (loginEmail?.value || '').trim();
  if (!email) return alert('メールを入力');
  let { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.origin + '/app.html', shouldCreateUser: false } });
  if (error && /user.*not.*found|invalid login|No account/i.test(error.message)) {
    const r1 = await supabase.auth.signUp({ email, options: { emailRedirectTo: location.origin + '/app.html' } });
    if (r1.error) return alert(r1.error.message);
    error = null;
  }
  if (error && /Database error saving new user|duplicate key|partial_key/i.test(error.message)) {
    const r2 = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.origin + '/app.html', shouldCreateUser: false } });
    if (r2.error) return alert(r2.error.message);
  }
  alert('ログイン用メールを送信しました。'); loginModal.classList.remove('on');
};
btnSigninPw.onclick = async ()=>{
  const id=(loginId?.value||'').trim(); const pw=(loginPw?.value||'').trim();
  if(!id || !pw) return alert('ID/パスワードを入力してください');
  const email = id.includes('@') ? id : id.toLowerCase() + '@' + (ENV.ALIAS_EMAIL_DOMAIN||'user.local').toLowerCase();
  let { error } = await supabase.auth.signInWithPassword({ email, password: pw });
  if (error){
    const s = await supabase.auth.signUp({ email, password: pw });
    if (s.error && !/already|exists/i.test(s.error.message)) return alert(s.error.message);
    try{ const { data:{ user } } = await supabase.auth.getUser(); if (user) await supabase.from('profiles').upsert({ id:user.id, username:id }).select().single(); }catch(_){}
    const r2 = await supabase.auth.signInWithPassword({ email, password: pw });
    if (r2.error) return alert(r2.error.message);
  }
  loginModal.classList.remove('on');
};
btnSignupPw.onclick = async ()=>{
  const id=(loginId?.value||'').trim(), pw=(loginPw?.value||'').trim();
  if(!id || !pw) return alert('ID/パスワードを入力してください');
  const email = id.includes('@') ? id : id.toLowerCase() + '@' + (ENV.ALIAS_EMAIL_DOMAIN||'user.local').toLowerCase();
  const s = await supabase.auth.signUp({ email, password: pw });
  if (s.error && !/already|exists/i.test(s.error.message)) return alert(s.error.message);
  try{ const { data:{user} }=await supabase.auth.getUser(); if(user) await supabase.from('profiles').upsert({ id:user.id, username:id }); }catch(_){}
  const r2 = await supabase.auth.signInWithPassword({ email, password: pw });
  if (r2.error) return alert(r2.error.message);
  loginModal.classList.remove('on');
};
async function refreshAuthUI(){
  const { data:{ user } } = await supabase.auth.getUser();
  if (user){
    let label = user.email || '(ログイン中)';
    try{
      const { data: prof } = await supabase.from('profiles').select('username').eq('id', user.id).maybeSingle();
      if (prof?.username) label = '@' + prof.username;
    }catch(_){}
    userEmail.textContent = label;
    btnOpenLogin.style.display = 'none'; btnLogout.style.display   = 'inline-block';
  }else{
    userEmail.textContent = '';
    btnOpenLogin.style.display = 'inline-block'; btnLogout.style.display   = 'none';
  }
}
await refreshAuthUI();
supabase.auth.onAuthStateChange(()=>refreshAuthUI());

const DEVICE_ID_KEY = 'tdr-device-id';
function uuidv4(){
  if (crypto?.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
  });
}
const deviceId = safeStorage.getItem(DEVICE_ID_KEY) || (safeStorage.setItem(DEVICE_ID_KEY, uuidv4()), safeStorage.getItem(DEVICE_ID_KEY));

const LS = {
  favKey: (park)=> `fav:${park}`,
  rulesKey: (park)=> `rules:${park}`,
  readFavs(park){ try{ return new Set(JSON.parse(safeStorage.getItem(this.favKey(park))||'[]')); }catch{ return new Set(); } },
  writeFavs(park, set){ safeStorage.setItem(this.favKey(park), JSON.stringify([...set])); },
  readRules(park){
    try{ return JSON.parse(safeStorage.getItem(this.rulesKey(park))||''); }catch{ return null; }
  },
  writeRules(park, obj){ safeStorage.setItem(this.rulesKey(park), JSON.stringify(obj||{})); }
};

const VAPID_PUBLIC_KEY = "BB4nzfXHR4VZfr1TvbaH6K34iB7nANgALqtOQBK_I3gpswFAJl-8nOQav2bg6qC8Wx5nqutNYe51JGAMncfM4n8"; // Base64URL

function urlBase64ToUint8Array(b64) {
  const pad = '='.repeat((4 - b64.length % 4) % 4);
  const base64 = (b64 + pad).replace(/-/g, '+').replace(/_/g, '/');
  const raw = atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

(async () => {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

  // 1) SW登録（/sw.js はサイト直下に置く）
  const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });

  // 2) 通知許可
  const perm = await Notification.requestPermission();
  if (perm !== 'granted') { console.warn('Notification not granted'); return; }

  // 3) 購読取得/作成（applicationServerKey は必ず Uint8Array）
  let sub = await reg.pushManager.getSubscription();
  if (!sub) {
    sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
    });
  }

  // 4) サーバに保存
  const res = await fetch('/.netlify/functions/push-subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ subscription: sub })
  });
  console.log('push-subscribe:', await res.text());
})();
  
// Elements
const parkSel = document.getElementById('park');
const qtDiv = document.getElementById('qt');
const dpaDiv = document.getElementById('dpa');
const fFavOnly = document.getElementById('fFavOnly');
const fFavOnlyDpa = document.getElementById('fFavOnlyDpa');
const fDpaOnSale = document.getElementById('fDpaOnSale');
const fPpOnSale  = document.getElementById('fPpOnSale');
const feedDiv = document.getElementById('feed');
const nowTipsDiv = document.getElementById('nowTips');
const shareLink=document.getElementById('shareLink');
const autoSchedLink=document.getElementById('autoSchedLink');

const fDpaOnly = document.getElementById('fDpaOnly');
const fKids = document.getElementById('fKids');
const fMaxWait = document.getElementById('fMaxWait');
const sortBy = document.getElementById('sortBy');

const rCloseReopen = document.getElementById('rCloseReopen');
const rDpaSale = document.getElementById('rDpaSale');
const rSpike = document.getElementById('rSpike');
const rWindow = document.getElementById('rWindow');
const btnSaveRules = document.getElementById('btnSaveRules');

const presetName=document.getElementById('presetName');
const presetSelect=document.getElementById('presetSelect');

const buyName=document.getElementById('buyName');
const buyStart=document.getElementById('buyStart');
const buyEnd=document.getElementById('buyEnd');
const buyQty=document.getElementById('buyQty');
const buyNote=document.getElementById('buyNote');

const planOut=document.getElementById('planOut');
const countsDiv=document.getElementById('counts');
const evName = document.getElementById('evName');
const evStart = document.getElementById('evStart');
const evDur = document.getElementById('evDur');
const btnAddEvent = document.getElementById('btnAddEvent');
const eventsList = document.getElementById('eventsList');

const fOpenOnly   = document.getElementById('fOpenOnly');
const fClosedOnly = document.getElementById('fClosedOnly');
const tgOpenOnly  = document.getElementById('tgOpenOnly');
const tgClosedOnly= document.getElementById('tgClosedOnly');
const areaSel     = document.getElementById('areaSel');
const btnQuickEasy    = document.getElementById('btnQuickEasy');
const btnQuickFavDpa  = document.getElementById('btnQuickFavDpa');
const sortByDpa   = document.getElementById('sortByDpa');

const state={ favorites:new Set(), qt:[], dpa:[], rules:null, purchases:[], parades:[], fixedManual:[], fixedAuto:[] };

function el(tag, attrs={}, children=[]){ const e=document.createElement(tag); for(const[k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } for(const c of (Array.isArray(children)?children:[children])) e.appendChild(typeof c==='string'?document.createTextNode(c):c); return e; }
function fmtLocal(dt){ 
  const pad=n=>String(n).padStart(2,'0'); 
  return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes()); 
}
function normalizeTitle(s){ 
  return (s||'').replace(/['＇`´']/g,"'").replace(/[""＂]/g,'"').replace(/[＆]/g,'&').replace(/\s+/g,'').replace(/　/g,''); 
}
function makeAreaMap(obj){ 
  const m = new Map(); 
  for (const [k,v] of Object.entries(obj)) m.set(normalizeTitle(k), v); 
  return m; 
}

const AREA_MAP={ 
  274: makeAreaMap({ 'オムニバス':'ワールドバザール' }), 
  275: makeAreaMap({ 'ソアリン：ファンタスティック・フライト':'メディテレーニアンハーバー' }) 
};

function areaOf(nameJa){ 
  const m = AREA_MAP[parkSel.value]; 
  return m?.get(normalizeTitle(nameJa)) || '?'; 
}

function populateAreas(){
  const m = AREA_MAP[parkSel.value] || new Map();
  const uniq = new Set([...m.values()]);
  const opts = ['<option value="">すべて</option>', ...[...uniq].map(a => `<option value="${a}">${a}</option>`)];
  areaSel.innerHTML = opts.join('');
}

function fmtUpdated(ts){
  if (!ts) return '';
  // スペース区切り対策（Safari等）
  const iso = typeof ts === 'string' ? ts.replace(' ', 'T') : ts;
  const d = new Date(iso);

  if (isNaN(d)) return ''; // 念のため

  // JSTの時刻表示（HH:MM）
  const hhmm = d.toLocaleString('ja-JP', {
    timeZone: 'Asia/Tokyo', hour12: false, hour: '2-digit', minute: '2-digit'
  });

  // 経過分（UTC基準のエポック差なのでTZ非依存）
  const diffMin = Math.max(0, Math.round((Date.now() - d.getTime()) / 60000));

  return '最終更新 ' + hhmm + '（' + diffMin + '分前）';
}
function setUpdated(el, ts, staleMinutes){ 
  if (!el) return; 
  if (!ts){ 
    el.textContent=''; 
    el.classList.remove('stale','fresh'); 
    return; 
  } 
  el.textContent = fmtUpdated(ts); 
  const ageMin = Math.max(0, Math.round((Date.now() - new Date(ts).getTime())/60000)); 
  el.classList.toggle('stale', ageMin >= staleMinutes); 
  el.classList.toggle('fresh', ageMin < staleMinutes); 
}

// 待ち時間による色分け関数
function getWaitClass(wait) {
  if (wait == null) return '';
  if (wait <= 20) return 'wait-low';
  if (wait <= 60) return 'wait-med';
  return 'wait-high';
}

// DPAカウントダウン関数
function getTimeUntil(targetTime) {
  const diff = Math.floor((new Date(targetTime) - new Date()) / 60000);
  if (diff > 60) return 'あと' + Math.floor(diff/60) + '時間' + (diff%60) + '分';
  if (diff > 0) return 'あと' + diff + '分';
  if (diff > -60) return '利用可能';
  return '終了';
}

// 混雑度計算
function getCrowdLevel() {
  const openAttractions = state.qt.filter(x => x.open && x.wait != null);
  if (!openAttractions.length) return { label: '計測中', className: '', avg: null };
  const avgWait = Math.round(openAttractions.reduce((sum, x) => sum + x.wait, 0) / openAttractions.length);
  if (avgWait < 30) return { label: '空いている', className: 'crowd-low', avg: avgWait };
  if (avgWait < 60) return { label: '普通', className: 'crowd-med', avg: avgWait };
  return { label: '混雑', className: 'crowd-high', avg: avgWait };
}

buyStart.addEventListener('change', ()=>{ if(!buyStart.value) return; const s=new Date(buyStart.value); const e=new Date(s.getTime()+60*60000); buyEnd.value=fmtLocal(e); });

async function refreshParkLastLabel() {
  const parkId = parseInt(parkSel.value, 10);
  const { data, error } = await supabase.from('queue_times').select('fetched_at').eq('park_id', parkId).order('fetched_at', { ascending: false }).limit(1);
  if (!error && data?.length) setUpdated(document.getElementById('qtUpdated'), data[0].fetched_at, 5);
}

async function loadQT(forceHeal=false){
  // ローディング表示
  document.getElementById('qtLoading').style.display = 'block';
  qtDiv.style.display = 'none';

  const parkId=parseInt(parkSel.value,10);
  const { data, error } = await supabase.from('v_queue_times_latest').select('name_ja,name_raw,is_open,wait_time,fetched_at').eq('park_id', parkId).limit(600);

  document.getElementById('qtLoading').style.display = 'none';
  qtDiv.style.display = 'block';

  if (error){ qtDiv.textContent = error.message; return; }
  const rows = data || [];
  const latestTs = rows.length ? rows.reduce((mx,r)=> (mx && new Date(mx)>new Date(r.fetched_at)? mx : r.fetched_at), rows[0].fetched_at) : null;
  const ageMin = latestTs ? Math.max(0, Math.round((Date.now() - new Date(latestTs).getTime())/60000)) : Infinity;
  const mostlyClosed = rows.filter(r => (r.wait_time??0)===0 && !r.is_open).length >= Math.max(5, Math.floor(rows.length*0.8));
  const stale = (!rows.length) || mostlyClosed || (ageMin >= 5);
  if (stale && !forceHeal){
    qtDiv.innerHTML = '<div class="mut">最新データが古い/ありません。サーバと同期しています…</div>';
    try{ await fetch('/.netlify/functions/sync-qt?parkId=' + parkId, { method:'POST' }); }catch(_){}
    await new Promise(r=>setTimeout(r, 4000));
    return await loadQT(true);
  }
  state.qt = rows.map(r=>({ nameJa:r.name_ja, nameRaw:r.name_raw, open:r.is_open, wait:r.wait_time, time:r.fetched_at }));
  setUpdated(document.getElementById('qtUpdated'), latestTs, 5);
  renderQT(); renderCountsEditor(); renderNowTips(); fillDpaNameList(); renderFavoritesQuick(); updateCrowdIndicator();
  await refreshParkLastLabel();
}

function applyFilters(list){
  let out = list.slice(0);

  // 既存：DPA対象・こども向け・待ち時間・★のみ
  if (fDpaOnly.checked){
    const dpaSet = new Set(state.dpa.map(d=>d.name));
    out = out.filter(x=> dpaSet.has(x.nameJa));
  }
  if (fKids.checked){
    out = out.filter(x=> /カルーセル|ダンボ|スモール|バギー|ティンカ|ゴーコースター|メリー|キャラバン/i.test(x.nameJa));
  }
  if (Number(fMaxWait.value) < 999){
    out = out.filter(x=> (x.wait??999) <= Number(fMaxWait.value));
  }
  if (fFavOnly?.checked){
    const favs = new Set(state.qt.filter(x=>state.favorites.has(x.nameRaw)).map(x=>x.nameJa));
    out = out.filter(x=> favs.has(x.nameJa));
  }

  // 追加：運営/休止の相互排他
  if (fOpenOnly?.checked && !fClosedOnly?.checked) out = out.filter(x=> !!x.open);
  if (fClosedOnly?.checked && !fOpenOnly?.checked) out = out.filter(x=> !x.open);

  // 追加：エリア
  if (areaSel?.value){
    out = out.filter(x => areaOf(x.nameJa) === areaSel.value);
  }

  // 並び順
  const favSet = new Set(state.qt.filter(x=>state.favorites.has(x.nameRaw)).map(x=>x.nameJa));
  const dpaOn  = new Set(state.dpa.filter(d=> d.dpa_status==='販売中').map(d=>d.name));

  switch (sortBy.value) {
    case 'wait':
      out.sort((a,b)=>(a.wait??999)-(b.wait??999));
      break;
    case 'wait_desc':
      out.sort((a,b)=>(b.wait??-1)-(a.wait??-1));
      break;
    case 'open':
      out.sort((a,b)=> (b.open?1:0)-(a.open?1:0) || (a.wait??999)-(b.wait??999));
      break;
    case 'fav_first':
      out.sort((a,b)=> (favSet.has(b.nameJa)?1:0)-(favSet.has(a.nameJa)?1:0) || a.nameJa.localeCompare(b.nameJa,'ja'));
      break;
    case 'dpa_first':
      out.sort((a,b)=> (dpaOn.has(b.nameJa)?1:0)-(dpaOn.has(a.nameJa)?1:0) || a.nameJa.localeCompare(b.nameJa,'ja'));
      break;
    default: // name
      out.sort((a,b)=>a.nameJa.localeCompare(b.nameJa,'ja'));
  }
  return out;
}


function renderQT(){
  const rows = applyFilters(state.qt);
  const tbl = el('table',{'data-hscroll':'1','data-sticky-first':'1'},[
    el('thead',{}, el('tr',{},[el('th',{},'★'),el('th',{},'施設（日本語）'),el('th',{},'待ち'),el('th',{},'状態'),el('th',{},'予測（±30分/同曜日）')])),
    el('tbody',{}, rows.map(r=>{
      const fav=state.favorites.has(r.nameRaw);
      const tr=el('tr',{},[
        el('td',{}, el('span',{class:'fav',onclick:()=>toggleFav(r.nameRaw)}, fav?'★':'☆')),
        el('td',{}, r.nameJa),
        el('td',{}, el('span',{class:'mono ' + getWaitClass(r.wait)}, (r.wait??'-').toString())),
        el('td',{}, r.open?el('span',{class:'good'},'運営中'):el('span',{class:'bad'},'休止')),
        el('td',{}, el('span',{class:'mut', id:'pred-' + r.nameRaw}, fav?'…':'-'))
      ]);
      if (fav) fetch('/.netlify/functions/qt-stats?park=' + parkSel.value + '&name=' + encodeURIComponent(r.nameRaw))
        .then(r=>r.json()).then(j=>{ 
          const elp=document.getElementById('pred-' + r.nameRaw); 
          if (elp) elp.textContent = j?.median!=null ? j.median + ' 分 (' + j.n + ')' : '-'; 
        })
        .catch(()=>{});
      return tr;
    }))
  ]);

  const cards = el('div',{class:'qt-cards'},
    rows.map(r=>{
      const fav = state.favorites.has(r.nameRaw);
      return el('div',{class:'qt-card'},[
        el('div',{},[
          el('div',{class:'title'}, r.nameJa),
          el('div',{class:'meta ' + (r.open ? 'open' : 'closed')}, r.open ? '運営中' : '休止')
        ]),
        el('div',{class:'wait ' + getWaitClass(r.wait)}, (r.wait ?? '-') + '分'),
        el('div',{class:'star', onclick:()=>toggleFav(r.nameRaw)}, fav?'★':'☆')
      ]);
    })
  );

  qtDiv.innerHTML='';
  qtDiv.appendChild(tbl);
  enableHScroll(qtDiv);
  qtDiv.appendChild(cards);
  
}

function fillDpaNameList(){
  const dl=document.getElementById('dpaNames'); dl.innerHTML='';
  for(const r of state.qt) dl.appendChild(el('option',{value:r.nameJa}));
}

async function renderNowTips(){
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  if (!favs.length){ nowTipsDiv.textContent='お気に入り（★）が未選択です。'; return; }
  const scored=[];
  for(const r of favs){
    let median=null;
    try{ const j=await (await fetch('/.netlify/functions/qt-stats?park=' + parkSel.value + '&name=' + encodeURIComponent(r.nameRaw))).json(); median=j.median; }catch{}
    const delta=(median!=null&&r.wait!=null)? (r.wait - median):0;
    scored.push({ ...r, median, delta });
  }
  scored.sort((a,b)=> (a.delta||999) - (b.delta||999) || (a.wait||999)-(b.wait||999));
  nowTipsDiv.textContent = scored.slice(0,3).map(x=> x.nameJa + '（' + (x.wait??'-') + '分 / 予測' + (x.median??'-') + '）').join(' / ');
}

// お気に入りクイックアクセス
function renderFavoritesQuick() {
  const panel = document.getElementById('favoritesQuick');
  const grid = document.getElementById('favGrid');
  const favs = state.qt.filter(x => state.favorites.has(x.nameRaw));

  if (!favs.length) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = 'block';
  grid.innerHTML = '';

  favs.forEach(f => {
    const item = el('div', {class: 'fav-item'}, [
      el('div', {class: 'name'}, f.nameJa),
      el('div', {class: 'wait-time ' + getWaitClass(f.wait)}, (f.wait ?? '-') + '分'),
      el('div', {class: 'status'}, f.open ? '運営中' : '休止')
    ]);
    grid.appendChild(item);
  });
}

// 混雑度インジケーター更新
function updateCrowdIndicator() {
  const crowd = getCrowdLevel();
  const levelEl = document.getElementById('crowdLevel');
  const avgEl = document.getElementById('avgWaitTime');

  levelEl.textContent = crowd.label;
  levelEl.className = 'crowd-level ' + crowd.className;
  avgEl.textContent = crowd.avg ? '(平均 ' + crowd.avg + '分)' : '';
}

// DPA/PP
async function loadDPA(){
  const parkCode = parkSel.value==='274' ? 'TDL' : 'TDS';
  const { data: parks } = await supabase.from('parks').select('id,code').eq('code', parkCode);
  if (!parks?.length){ dpaDiv.textContent='parks なし'; return; }
  const parkInternalId = parks[0].id;
  const { data } = await supabase
    .from('v_attraction_dpa_latest')
    .select('name,dpa_status,pp40_status,fetched_at')
    .eq('park_id', parkInternalId);
  // 整形＆並び順（販売中/発行中を先頭）
  const latest = (data||[]).map(r=>({
    name: r.name, dpa_status: r.dpa_status, pp40_status: r.pp40_status, t: r.fetched_at
  }));
  state.dpa = latest;

  (function(){
    const scoreDpa = v => (v === '販売中') ? 2 : (v === '対象' ? 1 : 0);
    const scorePp  = v => (v === '発行中') ? 2 : (v === '対象' ? 1 : 0);
  
    switch (sortByDpa?.value || 'smart') {
      case 'name':
        // 名前順
        latest.sort((a,b) => a.name.localeCompare(b.name, 'ja'));
        break;
  
      case 'dpa':
        // DPAが強い順（販売中→対象→その他）→ 名前
        latest.sort((a,b) =>
          (scoreDpa(b.dpa_status) - scoreDpa(a.dpa_status)) ||
          a.name.localeCompare(b.name, 'ja')
        );
        break;
  
      case 'pp':
        // PPが強い順（発行中→対象→その他）→ 名前
        latest.sort((a,b) =>
          (scorePp(b.pp40_status) - scorePp(a.pp40_status)) ||
          a.name.localeCompare(b.name, 'ja')
        );
        break;
  
      case 'recent':
        // 更新が新しい順
        latest.sort((a,b) => new Date(b.t) - new Date(a.t));
        break;
  
      default: // 'smart'（既定）：販売/発行中を先頭 → 名前
        latest.sort((a,b) => {
          const ka = scoreDpa(a.dpa_status) + scorePp(a.pp40_status);
          const kb = scoreDpa(b.dpa_status) + scorePp(b.pp40_status);
          return (kb - ka) || a.name.localeCompare(b.name, 'ja');
        });
    }
  })();

  // フィルタ（お気に入り/販売中のみ 等）
  const favSet = new Set(state.qt.filter(x=>state.favorites.has(x.nameRaw)).map(x=>x.nameJa));
  const filtered = latest.filter(r=>{
    // お気に入りのみ
    if (fFavOnlyDpa?.checked && !favSet.has(r.name)) return false;
    // DPA販売中のみ
    if (fDpaOnSale?.checked && r.dpa_status!=='販売中') return false;
    // PP発行中のみ
    if (fPpOnSale?.checked && !(r.pp40_status==='発行中' || r.pp40_status==='対象')) return false;
    // すべて表示 OFF のときは「DPA=記載なし AND PP=記載なし」を隠す
    if (!fShowAllDpa?.checked) {
      const dpaNone = !r.dpa_status || r.dpa_status==='記載なし';
      const ppNone  = !r.pp40_status || r.pp40_status==='記載なし';
      if (dpaNone && ppNone) return false;
    }
    return true;
  });

  // 共通：色クラス
  const clsDpa = s => s==='販売中' ? 'good' : (s==='販売終了' ? 'bad' : (s==='対象' ? 'warn' : ''));
  const clsPp  = s => s==='発行中' ? 'good' : (s==='発行終了' ? 'bad' : (s==='対象' ? 'warn' : ''));

  // テーブル（PC向け）
  const tbl = el('table',{'data-hscroll':'1','data-sticky-first':'1'},[
    el('thead',{},el('tr',{},[
      el('th',{},'施設'), el('th',{},'DPA'), el('th',{},'PP'), el('th',{},'更新')
    ])),
    el('tbody',{}, filtered.map(r=> el('tr',{},[
      el('td',{}, r.name),
      el('td',{}, el('span',{class:'tag dpa '+clsDpa(r.dpa_status)}, r.dpa_status||'-')),
      el('td',{}, el('span',{class:'tag pp '+clsPp(r.pp40_status)}, r.pp40_status||'-')),
      el('td',{}, new Date(r.t).toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false, year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}))
    ])))
  ]);

  // カード（スマホ向け）
  const cardsWrap = el('div',{class:'dpa-cards'},
    filtered.map(r=> el('div',{class:'dpa-card'},[
      el('div',{},[
        el('div',{class:'title'}, r.name),
        el('div',{class:'badges'},[
          el('span',{class:'tag dpa '+clsDpa(r.dpa_status)}, 'DPA: ' + (r.dpa_status||'-')),
          el('span',{class:'tag pp  '+clsPp(r.pp40_status)}, 'PP: ' + (r.pp40_status||'-')),
        ]),
        el('div',{class:'when'}, new Date(r.t).toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false, year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}))
      ])
    ]))
  );

  // 出力
  dpaDiv.innerHTML='';
  dpaDiv.appendChild(tbl);
  dpaDiv.appendChild(cardsWrap);
  enableHScroll(dpaDiv);
  
  // 更新ラベル
  const latestDpaTs = latest.length ? latest.reduce((mx,r)=> (mx && new Date(mx)>new Date(r.t)? mx : r.t), latest[0].t) : null;
  setUpdated(document.getElementById('dpaUpdated'), latestDpaTs, 10);
}

// Favorites and presets
async function toggleFav(raw){
  const parkId=parseInt(parkSel.value,10);
  const { data:{user} }=await supabase.auth.getUser();

  // 先にローカルを更新（オフラインでも効く）
  if(state.favorites.has(raw)) state.favorites.delete(raw); else state.favorites.add(raw);
  LS.writeFavs(parkId, state.favorites);

  // ログイン中だけサーバにも反映（失敗してもUIは維持）
  if(user){
    try{
      if(state.favorites.has(raw)){
        const { error } = await supabase.from('user_favorites').upsert({ user_id:user.id, park_id:parkId, attraction_name:raw });
        if (error) console.warn(error);
      }else{
        const { error } = await supabase.from('user_favorites').delete().match({ user_id:user.id, park_id:parkId, attraction_name:raw });
        if (error) console.warn(error);
      }
    }catch(e){ console.warn(e); }
  }

  renderFavs(); renderQT(); renderCountsEditor(); renderNowTips(); renderFavoritesQuick();
}

async function loadFavs(){
  const parkId=parseInt(parkSel.value,10);
  const { data:{user} }=await supabase.auth.getUser();

  // まずローカルから
  const local = LS.readFavs(parkId);
  state.favorites = new Set(local);

  // ログイン中ならサーバの内容とマージ（サーバ優先）
  if(user){
    const { data } = await supabase.from('user_favorites').select('*').match({ user_id:user.id, park_id:parkId });
    for(const r of (data||[])) state.favorites.add(r.attraction_name);
  }

  // 画面反映 & ローカルへ同期保存（ログイン時もローカルを最新に）
  LS.writeFavs(parkId, state.favorites);
  renderFavs(); renderCountsEditor(); renderFavoritesQuick();
}

function renderFavs(){
  const names = state.qt.filter(x=>state.favorites.has(x.nameRaw)).map(x=>x.nameJa);
  document.getElementById('favs').textContent = names.length ? 'お気に入り：'+names.join('、') : '★をクリックするとお気に入りに追加/解除できます。';
}

document.getElementById('btnSavePreset').onclick = async () => {
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) return alert('ログインしてください');
  const name = (presetName.value || '').trim();
  if (!name) return alert('プリセット名を入力');
  const items = Array.from(state.favorites.values());
  const row = { user_id: user.id, park_id: parseInt(parkSel.value,10), name, items };
  const { error } = await supabase.from('user_fav_presets').insert(row);
  if (error) return alert('保存に失敗: ' + error.message);
  alert('保存しました'); presetName.value=''; await loadPresets();
};

async function loadPresets(){
  const { data:{ user } } = await supabase.auth.getUser();
  const sel = document.getElementById('presetSelect');
  sel.innerHTML = '';
  if (!user) return;
  const { data } = await supabase.from('user_fav_presets').select('id,name,created_at').eq('user_id', user.id).eq('park_id', parseInt(parkSel.value,10)).order('created_at', { ascending:false });
  for (const p of (data||[])) { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); }
}

document.getElementById('btnLoadPreset').onclick = async () => {
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) return alert('ログインしてください');
  const sel = document.getElementById('presetSelect');
  const id = Number(sel.value || 0);
  if (!id) return alert('プリセットを選択');
  const { data: p, error } = await supabase.from('user_fav_presets').select('*').eq('id', id).single();
  if (error || !p) return alert('読み込みに失敗しました');
  const parkId = parseInt(parkSel.value,10);
  await supabase.from('user_favorites').delete().match({ user_id:user.id, park_id:parkId });
  const rows = (p.items||[]).map(nameRaw => ({ user_id:user.id, park_id:parkId, attraction_name:nameRaw }));
  if (rows.length) await supabase.from('user_favorites').insert(rows);
  state.favorites = new Set(p.items||[]);
  renderFavs(); renderQT(); renderCountsEditor(); renderNowTips(); renderFavoritesQuick();
  alert('プリセットを適用しました');
};

async function loadRules(){
  const parkId = parseInt(parkSel.value,10);
  const { data:{user} }=await supabase.auth.getUser();

  // ローカル優先で読み込み（あればそれをUIに）
  const local = LS.readRules(parkId);
  if(local){
    rCloseReopen.checked = !!local.notify_close_reopen;
    rDpaSale.checked     = !!local.notify_dpa_sale;
    rSpike.value         = local.spike_threshold ?? 20;
    rWindow.value        = local.window_minutes ?? 10;
    if(!user) return; // 未ログインならここで終わり
  }

  // ログイン中はサーバから取得してUI更新。ローカルにも反映
  if(user){
    const { data } = await supabase.from('user_alert_rules').select('*')
      .eq('user_id',user.id).eq('park_id',parkId).maybeSingle();
    const r = data || { notify_close_reopen:true, notify_dpa_sale:true, spike_threshold:20, window_minutes:10 };
    rCloseReopen.checked = !!r.notify_close_reopen;
    rDpaSale.checked     = !!r.notify_dpa_sale;
    rSpike.value         = r.spike_threshold;
    rWindow.value        = r.window_minutes;
    LS.writeRules(parkId, r);
  }
}

document.getElementById('btnSaveRules').onclick=async()=>{
  const parkId = parseInt(parkSel.value,10);
  const { data:{user} }=await supabase.auth.getUser();
  const row = {
    notify_close_reopen:rCloseReopen.checked,
    notify_dpa_sale:rDpaSale.checked,
    spike_threshold:Number(rSpike.value||20),
    window_minutes:Number(rWindow.value||10)
  };

  // 常にローカル保存
  LS.writeRules(parkId, row);

  // ログイン中のみサーバにも保存
  if(user){
    await supabase.from('user_alert_rules').upsert({ user_id:user.id, park_id:parkId, ...row },{ onConflict:'user_id,park_id' });
  }

  alert('保存しました');
};


async function loadPurchases(){
  const { data:{user} }=await supabase.auth.getUser();
  if(!user){ document.getElementById('purchases').innerHTML=''; state.fixedAuto=[]; return; }
  const { data } = await supabase.from('dpa_purchases').select('*').eq('user_id',user.id).eq('park_id',parseInt(parkSel.value,10)).order('slot_start');
  state.purchases=data||[]; renderPurchases(); renderEvents(); showAutoScheduleLinkForToday();
  state.fixedAuto = (data||[]).map(p => ({ name:p.attraction_name, start:new Date(p.slot_start), dur:Math.max(1, Math.round((new Date(p.slot_end)-new Date(p.slot_start))/60000)), method:'DPA' }));
}
  
// JSTのHH:MMで安全に表示（null/未パース対策・スペース区切りISO対策）
function fmtJST_HM(ts){
  if (!ts) return '-';
  const iso = typeof ts === 'string' ? ts.replace(' ', 'T') : ts;
  const d = new Date(iso);
  if (isNaN(d)) return '-';
  return d.toLocaleString('ja-JP', {
    timeZone: 'Asia/Tokyo', hour12: false, hour: '2-digit', minute: '2-digit'
  });
}

function renderPurchases(){
  const box = document.getElementById('purchases');
  box.innerHTML = '';

  const rows = (state.purchases || []);

  const tbl = el('table', {'data-hscroll':'1','data-sticky-first':'1'}, [
    el('thead', {}, el('tr', {}, [
      el('th', {}, '施設'),
      el('th', {}, '時間帯'),
      el('th', {}, 'カウントダウン'),
      el('th', {}, '枚数'),
      el('th', {}, 'メモ'),
      el('th', {}, '状態'),
      el('th', {}, '操作'),
    ])),
    el('tbody', {}, rows.map(p => el('tr', {}, [
      el('td', {}, p.attraction_name || '-'),
      el('td', {}, `${fmtJST_HM(p.slot_start)}〜${fmtJST_HM(p.slot_end)}`),
      el('td', {}, el('span', { class: 'dpa-countdown' }, getTimeUntil(p.slot_start))),
      el('td', {}, String(p.quantity ?? '-')),
      el('td', {}, p.note || ''),
      el('td', {}, p.used ? '使用済' : '未使用'),
      el('td', {}, el('button', {
        onclick: async () => {
          await supabase.from('dpa_purchases')
            .update({ used: !p.used })
            .eq('id', p.id);
          await loadPurchases();
        }
      }, p.used ? '未使用に戻す' : '使用済にする'))
    ])))
  ]);

  box.appendChild(tbl);
  enableHScroll(box);
}


document.getElementById('btnAddPurchase').onclick=async()=>{
  const { data:{user} }=await supabase.auth.getUser(); 
  if(!user) return alert('ログインしてください');
  const row={ 
    user_id:user.id, 
    park_id:parseInt(parkSel.value,10), 
    attraction_name:buyName.value, 
    slot_start:new Date(buyStart.value).toISOString(), 
    slot_end:new Date(buyEnd.value).toISOString(), 
    quantity:Number(buyQty.value||1), 
    note:buyNote.value||'' 
  };
  if(!row.attraction_name||!row.slot_start||!row.slot_end) return alert('値を確認してください');
  await supabase.from('dpa_purchases').insert(row);
  state.fixedAuto.push({ 
    name: row.attraction_name,
    start: new Date(buyStart.value), 
    dur: Math.max(1, Math.round((new Date(buyEnd.value)-new Date(buyStart.value))/60000)), 
    method:'DPA' 
  });
  renderEvents();
  await addPurchaseToAutoSchedule(row);
  buyName.value=''; 
  buyNote.value=''; 
  await loadPurchases();
  alert('登録しました（自動スケジュールにも追加済み）');
};

async function addPurchaseToAutoSchedule(purchaseRow){
  const { data:{user} }=await supabase.auth.getUser(); if(!user) return;
  const parkId = purchaseRow.park_id;
  const start = new Date(purchaseRow.slot_start);
  const end = new Date(purchaseRow.slot_end);
  const dateStr = start.toISOString().slice(0,10);
  const schedName = '自動スケジュール ' + dateStr;
  let { data:sch } = await supabase.from('user_schedules').select('id,share_token,name').eq('user_id',user.id).eq('park_id',parkId).eq('name',schedName).maybeSingle();
  if(!sch){
    const ins = await supabase.from('user_schedules').insert({ user_id:user.id, park_id:parkId, name:schedName }).select('id,share_token,name').single();
    if (ins.error) { console.warn(ins.error); return; }
    sch = ins.data;
  }
  const { data:dup } = await supabase.from('user_schedule_items').select('id').eq('schedule_id',sch.id).eq('attraction_name', purchaseRow.attraction_name).eq('method','DPA').eq('planned_time', start.toISOString()).limit(1);
  if (!dup?.length){
    await supabase.from('user_schedule_items').insert({
      schedule_id: sch.id, order_no: 9999, attraction_name: purchaseRow.attraction_name, method: 'DPA',
      planned_time: start.toISOString(), duration_min: Math.max(1, Math.round((end-start)/60000)), area: 'イベント'
    });
    const { data:items } = await supabase.from('user_schedule_items').select('id,planned_time').eq('schedule_id', sch.id).order('planned_time');
    let idx=1; for (const it of (items||[])) { await supabase.from('user_schedule_items').update({ order_no: idx++ }).eq('id', it.id); }
  }
  const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token);
  autoSchedLink.innerHTML = '今日の自動スケジュール： <a href="' + url.toString() + '">' + url.toString() + '</a>';
}

async function showAutoScheduleLinkForToday(){
  const { data:{user} }=await supabase.auth.getUser(); if(!user){ autoSchedLink.textContent=''; return; }
  const dateStr = new Date().toISOString().slice(0,10);
  const schedName = '自動スケジュール ' + dateStr;
  const { data:sch } = await supabase.from('user_schedules').select('id,share_token').eq('user_id',user.id).eq('park_id',parseInt(parkSel.value,10)).eq('name',schedName).maybeSingle();
  if (sch){ const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token); autoSchedLink.innerHTML = '今日の自動スケジュール： <a href="' + url.toString() + '">' + url.toString() + '</a>'; }
  else { autoSchedLink.textContent = ''; }
}

function renderEvents(){
  const wrap=eventsList; wrap.innerHTML='';
  const sec = (title, arr, deletable) => {
    const container = el('div',{});          // ← ラップ用に一度変数へ
    container.appendChild(el('h4',{},title));
  
    if (!arr.length) {
      container.appendChild(el('div',{class:'mut'},'なし'));
      return container;
    }
  
    const tbl = el('table', {'data-hscroll':'1','data-sticky-first':'1'}, [
      el('thead',{}, el('tr',{},[ el('th',{},'種別'), el('th',{},'名称'), el('th',{},'開始'),
                                  el('th',{},'所要'), el('th',{},'操作') ])),
      el('tbody',{}, arr.slice().sort((a,b)=>a.start-b.start).map((e,i)=> el('tr',{},[
        el('td',{}, e.method), el('td',{}, e.name),
        el('td',{}, e.start.toLocaleString()), el('td',{}, e.dur + '分'),
        el('td',{}, deletable ? el('button',{onclick:()=>{ arr.splice(i,1); renderEvents(); }},'削除')
                               : el('span',{class:'mut'},'—'))
      ])))
    ]);
  
    container.appendChild(tbl);
    enableHScroll(container);                // ← 横スクロールを適用
    return container;
  };
  wrap.appendChild(sec('DPA購入（自動反映）', state.fixedAuto, false));
  wrap.appendChild(sec('固定イベント（手動）', state.fixedManual, true));
}

btnAddEvent.onclick = () => {
  if (!evName.value || !evStart.value) return alert('名称と開始時刻を入力');
  state.fixedManual.push({ 
    name: evName.value, 
    start: new Date(evStart.value), 
    dur: Number(evDur.value || 30), 
    method: 'イベント' 
  });
  evName.value = ''; evStart.value = ''; evDur.value = '30';
  renderEvents();
};

function optimizeByArea(list){
  const out=[]; let curArea=null; const pool=list.slice(0);
  while(pool.length){
    const i = pool.findIndex(x=> areaOf(x.nameJa)===curArea);
    const pick = i>=0 ? pool.splice(i,1)[0] : pool.shift();
    out.push(pick); curArea = areaOf(pick.nameJa);
  }
  return out;
}

document.getElementById('btnPlan').onclick=async()=>{
  const { data:{user} }=await supabase.auth.getUser(); if(!user) return alert('ログインしてください');
  const start = document.getElementById('startTime').value || '09:00';
  const walk = Number(document.getElementById('walk').value||10);
  const today = new Date().toISOString().slice(0,10);
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  let tasks=[]; for(const r of favs){ const n = Number(document.getElementById('count-' + r.nameRaw)?.value||0); for(let i=0;i<n;i++) tasks.push(r); }
  const fixed = [...state.fixedAuto, ...state.fixedManual].map(e => ({ ...e, end: new Date(e.start.getTime() + e.dur*60000) })).sort((a,b)=> a.start - b.start);
  if(!tasks.length && !fixed.length) return alert('回数指定や固定イベントがありません');
  const dpaTargets = new Set(tasks.slice().sort((a,b)=>(b.wait||0)-(a.wait||0)).slice(0, Math.ceil(tasks.length/2)).map(x=>x.nameRaw));
  let cursor = new Date(today + 'T' + start + ':00');
  const steps = [];
  function bumpPastFixed(cur, durMin){
    let cur2 = new Date(cur);
    while(true){
      const hit = fixed.find(f => cur2 < f.end && new Date(cur2.getTime()+durMin*60000) > f.start);
      if(!hit) return cur2;
      cur2 = new Date(hit.end.getTime() + walk*60000);
    }
  }
  tasks = optimizeByArea(tasks);
  for(const t of tasks){
    const useDpa = dpaTargets.has(t.nameRaw);
    const dur = useDpa ? 20 : (t.wait||20);
    cursor = bumpPastFixed(cursor, dur);
    steps.push({ name:t.nameJa, raw:t.nameRaw, method: useDpa?'DPA':'Standby', at:new Date(cursor), dur, area: areaOf(t.nameJa) });
    cursor = new Date(cursor.getTime() + (dur+walk)*60000);
  }
  const fixSteps = fixed.map(f => ({ name:f.name, raw:f.name, method:f.method, at:new Date(f.start), dur:f.dur, area:'イベント' }));
  const allSteps = [...steps, ...fixSteps].sort((a,b)=> a.at - b.at);
  planOut.textContent = allSteps.map(s=> s.at.toTimeString().slice(0,5) + ' ' + s.method + ' → ' + s.name + '（' + s.dur + '分） [' + s.area + ']').join('\n');
  const sched = { user_id:(await supabase.auth.getUser()).data.user.id, park_id:parseInt(parkSel.value,10), name:'手動スケジュール ' + new Date().toLocaleTimeString() };
  const { data:sch, error:e1 } = await supabase.from('user_schedules').insert(sched).select('id,share_token').single();
  if(e1) return alert(e1.message);
  const items = allSteps.map((s,i)=>({ schedule_id:sch.id, order_no:i+1, attraction_name:s.raw, method:s.method, planned_time:s.at.toISOString(), duration_min:s.dur, area:s.area }));
  const { error:e2 } = await supabase.from('user_schedule_items').insert(items);
  if(e2) return alert(e2.message);
  const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token);
  shareLink.innerHTML = '共有リンク： <a href="' + url.toString() + '">' + url.toString() + '</a>';
};

function renderCountsEditor(){
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  countsDiv.innerHTML='';
  if(!favs.length){ countsDiv.textContent='★で施設を選ぶと回数指定できます。'; return; }
  const grid = document.createElement('div'); grid.className='grid3';
  for(const r of favs){
    const area=areaOf(r.nameJa);
    const row=document.createElement('div'); row.className='row';
    row.appendChild(document.createTextNode(r.nameJa +'（'+area+'）'));
    const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.value='1'; inp.id='count-' + r.nameRaw; inp.className='w120';
    row.appendChild(inp); grid.appendChild(row);
  }
  countsDiv.appendChild(grid);
}

async function loadParades(){
  const parkId = parseInt(parkSel.value,10);
  const { data, error } = await supabase.from('parades').select('*').eq('park_id', parkId).order('name');
  const dl = document.getElementById('paradeNames'); dl.innerHTML = '';
  (data||[]).forEach(p=> dl.appendChild(new Option('', p.name)));
}

async function loadShared(){
  const sp = new URLSearchParams(location.search); const token = sp.get('schedule'); if(!token) return;
  const { data:sch } = await supabase.from('user_schedules').select('id,name').eq('share_token', token).single();
  if(!sch) return;
  const { data:items } = await supabase.from('user_schedule_items').select('*').eq('schedule_id', sch.id).order('order_no');
  planOut.textContent = '📎 共有スケジュール: ' + sch.name + '\n' + items.map(s=> new Date(s.planned_time).toTimeString().slice(0,5) + ' ' + s.method + ' → ' + s.attraction_name + '（' + s.duration_min + '分） [' + (s.area||'') + ']').join('\n');
}

async function loadFeed(){ 
  const { data } = await supabase.from('notifications').select('*').order('created_at',{ascending:false}).limit(20); 
  feedDiv.innerHTML=''; 
  for(const n of data||[]){ 
    const row=document.createElement('div'); 
    row.className='row'; 
    row.textContent='[' + new Date(n.created_at).toLocaleString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' }) + '] ' + n.title + ' - ' + n.body; 
    feedDiv.prepend(row); 
  } 
}
supabase.channel('feed').on('postgres_changes',{event:'INSERT',schema:'public',table:'notifications'},p=>{ 
  const row=document.createElement('div'); 
  row.className='row'; 
  row.textContent='[' + new Date(p.new.created_at).toLocaleTimeString() + '] ' + p.new.title + ' - ' + p.new.body; 
  feedDiv.prepend(row); 
}).subscribe();

const btnNotify=document.getElementById('btnNotify');
async function urlB64ToUint8Array(b){const p='='.repeat((4-b.length%4)%4);const base=(b+p).replace(/-/g,'+').replace(/_/g,'/');const raw=atob(base);const u=new Uint8Array(raw.length);for(let i=0;i<raw.length;i++)u[i]=raw.charCodeAt(i);return u;}
btnNotify.onclick=async()=>{
  if (!ENV.VAPID_PUBLIC_KEY) return alert('VAPID_PUBLIC_KEY未設定');

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isIOS && !isStandalone) { alert('iPhoneは「ホーム画面に追加」でインストール後に通知が有効化できます。'); return; }

  const perm = await Notification.requestPermission();
  if (perm !== 'granted'){ alert('通知が許可されませんでした'); return; }

  const reg = await navigator.serviceWorker.register('/sw.js');
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: await urlB64ToUint8Array(ENV.VAPID_PUBLIC_KEY)
  });

  // 端末側の状態スナップショット（サーバが匿名配信するときに使う）
  const parkId = parseInt(parkSel.value,10);
  const favs   = [...(LS.readFavs(parkId) || [])];
  const rules  = LS.readRules(parkId) || { notify_close_reopen:true, notify_dpa_sale:true, spike_threshold:20, window_minutes:10 };

  const { data:{user}, error } = await supabase.auth.getUser();

  const headers = { 'Content-Type':'application/json' };
  let body = { device_id: deviceId, subscription: sub.toJSON(), park_id: parkId, favs, rules };

  // ログイン中は従来通りBearer付きでもOK（互換）
  if (!error && user) {
    const { data:{ session } } = await supabase.auth.getSession();
    if (session?.access_token) headers['Authorization'] = 'Bearer ' + session.access_token;
  }

  const resp = await fetch('/.netlify/functions/push-subscribe', {
    method:'POST', headers, body: JSON.stringify(body)
  });

  alert(resp.ok ? '通知を登録しました（端末）' : '通知登録に失敗しました');
};

// フィルタボタンのトグル表示
document.getElementById('filterDpaOnly').onclick = function() {
  this.classList.toggle('active');
  fDpaOnly.checked = !fDpaOnly.checked;
  renderQT();
};
document.getElementById('filterKids').onclick = function() {
  this.classList.toggle('active');
  fKids.checked = !fKids.checked;
  renderQT();
};
document.getElementById('filterFavOnly').onclick = function() {
  this.classList.toggle('active');
  fFavOnly.checked = !fFavOnly.checked;
  renderQT();
};

// ==== 運営/休止 相互排他トグル（堅牢版） ====
// ラベルとinputの状態を双方向で同期させる
function syncOpenClosedUI() {
  if (fOpenOnly)  tgOpenOnly?.classList.toggle('active',  !!fOpenOnly.checked);
  if (fClosedOnly)tgClosedOnly?.classList.toggle('active', !!fClosedOnly.checked);

  // 相互排他：両方ONは許可しない
  if (fOpenOnly?.checked && fClosedOnly?.checked) {
    // 最後にONになった方を優先したいが、ここでは「open優先」でclosedを落とす
    fClosedOnly.checked = false;
    tgClosedOnly?.classList.remove('active');
  }
}

// 1) ラベルをクリックしたとき（タップ含む）
tgOpenOnly?.addEventListener('click', (e) => {
  e.preventDefault(); // ラベルのデフォを抑制して自前でトグル
  if (!fOpenOnly) return;
  fOpenOnly.checked = !fOpenOnly.checked;
  if (fOpenOnly.checked) { // 相互排他
    fClosedOnly.checked = false;
  }
  syncOpenClosedUI();
  renderQT();
});

tgClosedOnly?.addEventListener('click', (e) => {
  e.preventDefault();
  if (!fClosedOnly) return;
  fClosedOnly.checked = !fClosedOnly.checked;
  if (fClosedOnly.checked) { // 相互排他
    fOpenOnly.checked = false;
  }
  syncOpenClosedUI();
  renderQT();
});

// 2) 入力(change)を直接操作された場合（キーボード/アクセシビリティ等）
fOpenOnly?.addEventListener('change', () => {
  if (fOpenOnly.checked) fClosedOnly.checked = false;
  syncOpenClosedUI();
  renderQT();
});
fClosedOnly?.addEventListener('change', () => {
  if (fClosedOnly.checked) fOpenOnly.checked = false;
  syncOpenClosedUI();
  renderQT();
});

// 3) 初期同期（ページロード直後・パーク切替後など）
syncOpenClosedUI();

// クイックフィルタ
btnQuickEasy.onclick = () => { fMaxWait.value = 20; renderQT(); };
btnQuickFavDpa.onclick = () => {
  fFavOnly.checked = true; document.getElementById('filterFavOnly').classList.add('active');
  fDpaOnSale.checked = true;
  loadDPA(); renderQT();
};

// エリア変更
areaSel.onchange = () => renderQT();

// DPA 並び順
if (sortByDpa) sortByDpa.onchange = () => loadDPA();

// タブ（上部）のスクロール & 強調
document.querySelectorAll('#topTabs .tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#topTabs .tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.target;
    let targetEl=null;
    if (t==='qt')       targetEl = document.querySelector('.panel:has(#qt)');
    if (t==='dpa')      targetEl = document.querySelector('.panel:has(#dpa)');
    if (t==='favs')     targetEl = document.querySelector('.panel:has(#favs)');
    if (t==='schedule') targetEl = document.querySelector('.panel:has(#planOut)');
    if (targetEl) targetEl.scrollIntoView({ behavior:'smooth', block:'start' });
  });
});

// 下部ナビのアクティブ強調
document.querySelectorAll('.bottom-nav .nav-item').forEach(item=>{
  item.addEventListener('click', function(){
    document.querySelectorAll('.bottom-nav .nav-item').forEach(i=>i.classList.remove('active'));
    this.classList.add('active');
  });
});


// 初期状態設定
if (fDpaOnly.checked) document.getElementById('filterDpaOnly').classList.add('active');
if (fKids.checked) document.getElementById('filterKids').classList.add('active');
if (fFavOnly.checked) document.getElementById('filterFavOnly').classList.add('active');

// モバイルナビゲーション
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', function() {
    const target = this.dataset.target;
    let scrollTarget;
    
    switch(target) {
      case 'qt':
        scrollTarget = document.querySelector('.panel:has(#qt)');
        break;
      case 'dpa':
        scrollTarget = document.querySelector('.panel:has(#dpa)');
        break;
      case 'favs':
        scrollTarget = document.querySelector('.panel:has(#favs)');
        break;
      case 'schedule':
        scrollTarget = document.querySelector('.panel:has(#planOut)');
        break;
    }
    
    if (scrollTarget) {
      scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
});

// 手動更新ボタン（待ち時間のみ）
document.getElementById('btnRefresh').onclick = async ()=>{ await loadQT(true); };
parkSel.onchange = async () => {
  await loadRules(); await loadFavs(); await loadQT(); await loadDPA(); await loadPurchases(); await loadParades();
  renderEvents(); await renderNowTips(); await loadPresets();
  populateAreas(); areaSel.value = ''; // 追加
};


// DPAフィルタのイベント
fFavOnlyDpa.onchange = fDpaOnSale.onchange = fPpOnSale.onchange = () => loadDPA();
document.getElementById('fShowAllDpa').onchange = () => loadDPA();
fMaxWait.onchange = sortBy.onchange = () => renderQT();

let autoTimer=null, dpaTimer=null;
const autoRefresh = document.getElementById('autoRefresh');
function startAuto(){
  stopAuto();
  // 待ち時間（Queue-Times）を 90 秒ごと
  autoTimer = setInterval(() => loadQT(false).catch(()=>{}), 90_000);

  // DPA/PP を 30 秒ごと
  dpaTimer  = setInterval(() => loadDPA().catch(()=>{}), 30_000);

  // 初回即時ロード
  loadQT(false).catch(()=>{});
  loadDPA().catch(()=>{});
}
function stopAuto(){ if (autoTimer){ clearInterval(autoTimer); autoTimer=null; } if (dpaTimer){ clearInterval(dpaTimer); dpaTimer=null; } }
autoRefresh.onchange = ()=> autoRefresh.checked ? startAuto() : stopAuto();
document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopAuto(); else if (autoRefresh.checked) startAuto(); });
if (autoRefresh.checked) startAuto();

// プルリフレッシュ実装
let pullStartY = 0;
let pullDistance = 0;
let isPulling = false;
const pullThreshold = 100;
const pullMax = 150;
const pullRefreshEl = document.getElementById('pullRefresh');
const pullTextEl = document.getElementById('pullText');
const pullSpinnerEl = document.getElementById('pullSpinner');

document.addEventListener('touchstart', (e) => {
  if (window.scrollY === 0 && !isPulling) {
    pullStartY = e.touches[0].pageY;
    pullRefreshEl.classList.add('pulling');
  }
}, { passive: true });

document.addEventListener('touchmove', (e) => {
  if (pullStartY > 0 && !isPulling) {
    pullDistance = Math.min(e.touches[0].pageY - pullStartY, pullMax);
    
    if (pullDistance > 0 && window.scrollY === 0) {
      e.preventDefault();
      
      pullRefreshEl.style.transform = 'translateY(' + pullDistance + 'px)';
      
      if (pullDistance > pullThreshold) {
        pullTextEl.textContent = '離して更新';
      } else {
        pullTextEl.textContent = '下に引っ張って更新';
      }
    }
  }
}, { passive: false });

document.addEventListener('touchend', async (e) => {
  if (pullDistance > pullThreshold && !isPulling) {
    isPulling = true;
    pullRefreshEl.classList.remove('pulling');
    pullRefreshEl.classList.add('show');
    pullTextEl.textContent = '更新中...';
    pullSpinnerEl.style.display = 'block';
    
    try {
      await Promise.all([
        loadQT(true),
        loadDPA(),
        loadFeed()
      ]);
    } catch (error) {
      console.error('更新エラー:', error);
    }
    
    pullTextEl.textContent = '更新完了！';
    setTimeout(() => {
      pullRefreshEl.classList.remove('show');
      pullRefreshEl.style.transform = '';
      pullSpinnerEl.style.display = 'none';
      pullTextEl.textContent = '下に引っ張って更新';
      isPulling = false;
    }, 1000);
  } else {
    pullRefreshEl.style.transform = '';
    pullRefreshEl.classList.remove('pulling');
  }
  
  pullStartY = 0;
  pullDistance = 0;
});
// DPA取り込みを手動でキック（約15秒後に最新を表示）
const btnFetchDpa = document.getElementById('btnFetchDpa');
if (btnFetchDpa) {
  btnFetchDpa.onclick = async () => {
    try {
      btnFetchDpa.disabled = true;
      const prev = btnFetchDpa.textContent;
      btnFetchDpa.textContent = '取得中…（約15秒）';
      // 背景関数をPOSTで起動（すぐ 202 が返る）
      await fetch('/.netlify/functions/ingest-tdr-dpa-background', { method: 'POST' }).catch(()=>{});
      // 取り込み完了を待つ（15秒後に最新を読む）
      await new Promise(r => setTimeout(r, 15000));
      await loadDPA(); // ← 既存のDPAテーブル再描画関数（app.htmlに実装済み）
      btnFetchDpa.textContent = prev;
    } finally {
      btnFetchDpa.disabled = false;
    }
  };
}

// ===== 今日の販売タイムライン（8:00–21:00 / 15分刻み） =====

// DOM 参照（既に存在する要素）
const tlDiv      = document.getElementById('timeline');
const tlKindSel  = document.getElementById('tlKind');
const tlUpdated  = document.getElementById('tlUpdated');

// 8:00〜21:00 の 15分スロットを JST で生成
function* tlSlots(startHour=8, endHour=21, step=15){
  const tz = 'Asia/Tokyo';
  const base = new Date();
  const s = new Date(base.toLocaleString('en-US',{ timeZone: tz }));
  s.setHours(startHour,0,0,0);
  const e = new Date(base.toLocaleString('en-US',{ timeZone: tz }));
  e.setHours(endHour,0,0,0);
  for (let t=new Date(s); t<e; t=new Date(t.getTime()+step*60000)) {
    yield [new Date(t), new Date(t.getTime()+step*60000)];
  }
}
const overlap = (a1,a2,b1,b2)=> a1<b2 && b1<a2;

// Supabase（マテビュー）から区間を取得して表に描画
async function loadTimeline(){
  const kind   = tlKindSel?.value || 'dpa';
  const table  = (kind === 'dpa') ? 'v_dpa_sessions_today_mv' : 'v_pp_sessions_today_mv';

  // ← ここだけ追加：274/275(ランド/シー) → 1/2 に合わせる
  const qtParkId = parseInt(parkSel.value || '274', 10);
  const sessionParkId = (qtParkId === 274 ? 1 : qtParkId === 275 ? 2 : qtParkId);

  const { data, error } = await supabase
    .from(table)
    .select('park_id,name_ja,jst_start,jst_end')
    .eq('park_id', sessionParkId)     // ← ここを sessionParkId に
    .order('name_ja', { ascending:true })
    .order('jst_start', { ascending:true });

  if (error) { tlDiv.textContent = error.message; return; }
  renderTimeline(data || []);
}

function renderTimeline(rows){
  const names  = [...new Set(rows.map(r=>r.name_ja))];
  const byName = Object.fromEntries(names.map(n => [n, rows.filter(r=>r.name_ja===n)]));

  const tbl = document.createElement('table'); tbl.className='timeline';

  // ヘッダ
  const thead = document.createElement('thead');
  const thr   = document.createElement('tr'); thr.className='head';
  thr.appendChild(Object.assign(document.createElement('th'), {textContent:'時刻'}));
  for (const n of names) thr.appendChild(Object.assign(document.createElement('th'), {textContent:n}));
  thead.appendChild(thr); tbl.appendChild(thead);

  // 本体（8:00〜21:00 / 15分）
  const tbody = document.createElement('tbody');
  for (const [slotS, slotE] of tlSlots(8,21,15)) {
    const tr    = document.createElement('tr');
    const tdT   = document.createElement('td');
    tdT.textContent = slotS.toLocaleTimeString('ja-JP',{ timeZone:'Asia/Tokyo', hour:'2-digit', minute:'2-digit', hour12:false });
    tr.appendChild(tdT);

    for (const n of names) {
      const td  = document.createElement('td');
      const on  = (byName[n]||[]).some(s => overlap(new Date(s.jst_start), new Date(s.jst_end), slotS, slotE));
      td.className  = on ? 'on' : 'off';
      td.textContent= on ? '●' : '';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);

  const tlWrap = document.getElementById('timelineWrap') || tlDiv; // ラッパが無ければ従来通り
  tlDiv.innerHTML = '';
  tlWrap.innerHTML = '';            // ← ラッパ内をクリア
  tlWrap.appendChild(tbl);          // ← ラッパにテーブルを入れる
  tlUpdated.textContent = '更新: ' + new Date().toLocaleTimeString('ja-JP',{ timeZone:'Asia/Tokyo', hour12:false });
}

// イベント & 自動更新（1分ごと）
tlKindSel?.addEventListener('change', loadTimeline);
parkSel?.addEventListener('change', loadTimeline);

let tlTimer = null;
function startTimelineAuto(){
  if (tlTimer) clearInterval(tlTimer);
  loadTimeline().catch(()=>{});
  tlTimer = setInterval(()=> loadTimeline().catch(()=>{}), 60_000);
}

// マウスドラッグで横スクロール（任意）
(function enableDragScroll(){
  const wrap = document.getElementById('timelineWrap');
  if (!wrap) return;
  let isDown=false, startX=0, scrollLeft=0;
  wrap.addEventListener('mousedown', (e)=>{
    isDown=true; wrap.classList.add('dragging');
    startX = e.pageX - wrap.offsetLeft;
    scrollLeft = wrap.scrollLeft;
  });
  ['mouseleave','mouseup'].forEach(ev=>wrap.addEventListener(ev,()=>{ isDown=false; wrap.classList.remove('dragging'); }));
  wrap.addEventListener('mousemove', (e)=>{
    if(!isDown) return;
    e.preventDefault();
    const x = e.pageX - wrap.offsetLeft;
    const walk = (x - startX) * 1; // 速度係数
    wrap.scrollLeft = scrollLeft - walk;
  });
})();
// 任意の table[data-hscroll] を自動で <div class="hscroll"> で包み、横スクロール化
function enableHScroll(root = document){
  root.querySelectorAll('table[data-hscroll]').forEach(tbl => {
    if (tbl.closest('.hscroll')) return;           // 既に包まれていれば何もしない
    const wrap = document.createElement('div');
    wrap.className = 'hscroll';
    tbl.parentNode.insertBefore(wrap, tbl);
    wrap.appendChild(tbl);
    tbl.classList.add('hscroll-table');
    if (tbl.dataset.stickyFirst === '1') tbl.classList.add('sticky-first');
  });
}

// 初期読み込み
await loadShared(); await loadRules(); await loadFavs(); await loadQT(); await loadDPA(); await loadPurchases(); await loadParades(); renderEvents(); await renderNowTips(); await loadFeed(); await loadPresets(); populateAreas(); startTimelineAuto();
</script>
</body>
</html>
