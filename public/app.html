<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TDR DPAã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« & é€šçŸ¥ã‚¢ãƒ—ãƒª</title>
<link rel="manifest" href="/manifest.json">
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --mute:#94a3b8; --line:#1f2937;
          --accent:#38bdf8; --good:#22c55e; --bad:#ef4444; --chip:#0b1220; }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  a{color:var(--accent)}
  header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .g{display:grid;gap:12px} .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:var(--ink);outline:none}
  button{cursor:pointer}
  .cta{background:var(--accent);color:#00111a;border:0;font-weight:800}
  .chip{display:inline-flex;gap:8px;align-items:center;background:#0b1220;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .mut{color:var(--mute)} .mono{font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:8px;color:var(--mute)}
  .tag.dpa{color:#93c5fd;border-color:#1e3a8a}
  .tag.pp{color:#a7f3d0;border-color:#064e3b}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .fav{cursor:pointer}
  .plan{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;padding:10px;border-radius:12px}
</style>
</head>
<body>
<header><div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div><strong>ğŸ§­ TDR DPA / å¾…ã¡æ™‚é–“ é€šçŸ¥ã‚¢ãƒ—ãƒª</strong> <span class="mut">ï¼ˆNetlify + Supabaseï¼‰</span></div>
    <div class="row">
      <span id="userEmail" class="mut"></span>
      <button id="btnLogin" class="cta">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnLogout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
</div></header>

<main class="wrap g">
  <section class="panel">
    <div class="row">
      <label for="park">ãƒ‘ãƒ¼ã‚¯ï¼š</label>
      <select id="park">
        <option value="274">æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰</option>
        <option value="275">æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼</option>
      </select>
      <button id="btnNotify" class="cta">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ON</button>
      <span class="mut">ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¨±å¯ã—ã€ç«¯æœ«ç™»éŒ²ï¼‰</span>
    </div>
  </section>

  <section class="g g2">
    <div class="panel">
      <h3 style="margin-top:0">â± æœ€æ–°å¾…ã¡æ™‚é–“ï¼ˆSupabaseï¼‰</h3>
      <div class="row">
        <button id="btnRefresh" class="cta">æ›´æ–°</button>
        <span class="mut">è‡ªå‹•æ›´æ–°ï¼š1åˆ†ã”ã¨ã«ã‚µãƒ¼ãƒãŒä¿å­˜</span>
      </div>
      <div id="qt"></div>
    </div>
    <div class="panel">
      <h3 style="margin-top:0">ğŸ« DPA / PP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå…¬å¼ã‚µã‚¤ãƒˆè§£æï¼‰</h3>
      <div class="row">
        <button id="btnFetchDpa" class="cta">æœ€æ–°å–å¾—</button>
        <span class="mut">ã‚µãƒ¼ãƒãŒ1åˆ†ã”ã¨ã«ä¿å­˜</span>
      </div>
      <div id="dpa"></div>
    </div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">â­ ãŠæ°—ã«å…¥ã‚Š / ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
    <div class="row">
      <input id="presetName" placeholder="ãƒ—ãƒªã‚»ãƒƒãƒˆåï¼ˆä¾‹ï¼šæœã‚¤ãƒå®šç•ªï¼‰">
      <button id="btnSavePreset" class="cta">ç¾åœ¨ã®â˜…ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</button>
      <select id="presetSelect"></select>
      <button id="btnLoadPreset">ãƒ—ãƒªã‚»ãƒƒãƒˆèª­è¾¼</button>
    </div>
    <div id="favs" class="mut">â˜…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤ã§ãã¾ã™ã€‚</div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ“… DPAã‚¹ãƒ­ãƒƒãƒˆè‡ªå‹•ç”Ÿæˆ & è¡Œå‹•ãƒ—ãƒ©ãƒ³</h3>
    <div class="row">
      <label>é–‹å§‹æ™‚åˆ»</label><input id="startTime" type="time">
      <label>å¾’æ­©/ç§»å‹•ãƒãƒƒãƒ•ã‚¡(åˆ†)</label><input id="walk" type="number" value="10" style="width:120px">
      <label>ä¹—ã‚ŠãŸã„åˆè¨ˆæ•°</label><input id="rideCount" type="number" value="4" style="width:120px">
      <button id="btnPlan" class="cta">ãƒ—ãƒ©ãƒ³ç”Ÿæˆ</button>
    </div>
    <div class="row mut">ã‚¹ãƒ­ãƒƒãƒˆã¯8:45ã‹ã‚‰15åˆ†é–“éš”ã§1æ™‚é–“æœ‰åŠ¹ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼‰</div>
    <div id="planOut" class="plan"></div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ”” é€šçŸ¥ãƒ•ã‚£ãƒ¼ãƒ‰</h3>
    <div id="feed"></div>
  </section>
</main>
<script src="/.netlify/functions/env"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

// ======= ENV (set these in Netlify environment; we read from window.ENV injected or prompt fallback) =======
const ENV = {
  SUPABASE_URL: window.ENV?.SUPABASE_URL || prompt('SUPABASE_URL'),
  SUPABASE_ANON_KEY: window.ENV?.SUPABASE_ANON_KEY || prompt('SUPABASE_ANON_KEY'),
  VAPID_PUBLIC_KEY: window.ENV?.VAPID_PUBLIC_KEY || prompt('VAPID_PUBLIC_KEY (WebPush å…¬é–‹éµ)')
};
const supabase = createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY);

// ======= Auth =======
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const userEmail = document.getElementById('userEmail');

async function refreshAuthUI() {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    userEmail.textContent = user.email || '(ãƒ­ã‚°ã‚¤ãƒ³ä¸­)';
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'inline-block';
  } else {
    userEmail.textContent = '';
    btnLogin.style.display = 'inline-block';
    btnLogout.style.display = 'none';
  }
}

btnLogin.onclick = async () => {
  const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯é€ä¿¡ï¼‰');
  if (!email) return;
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.origin + '/app.html' } });
  if (error) alert(error.message); else alert('ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
};
btnLogout.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

await refreshAuthUI();
supabase.auth.onAuthStateChange(refreshAuthUI);

// ======= Helpers =======
const parkSel = document.getElementById('park');
const qtDiv = document.getElementById('qt');
const dpaDiv = document.getElementById('dpa');
const feedDiv = document.getElementById('feed');
const presetName = document.getElementById('presetName');
const presetSelect = document.getElementById('presetSelect');

const state = { favorites: new Set(), qt: [], dpa: [] };

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') e.className = v;
    else if (k.startsWith('on')) e.addEventListener(k.slice(2), v);
    else e.setAttribute(k,v);
  }
  for (const c of (Array.isArray(children) ? children : [children])) {
    e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  }
  return e;
}

// ======= Fetch: Queue-Times (from Supabase latest snapshots) =======
async function loadQT() {
  const parkId = parseInt(parkSel.value, 10);
  // latest per attraction_name
  const { data, error } = await supabase
    .from('queue_times')
    .select('attraction_name, is_open, wait_time, fetched_at')
    .eq('park_id', parkId)
    .order('fetched_at', { ascending: false })
    .limit(500);
  if (error) { qtDiv.textContent = error.message; return; }

  // Reduce to most recent per attraction
  const seen = new Set();
  const latest = [];
  for (const row of data) {
    if (seen.has(row.attraction_name)) continue;
    seen.add(row.attraction_name);
    latest.push(row);
  }
  state.qt = latest.sort((a,b)=> (a.attraction_name > b.attraction_name?1:-1));
  renderQT();
}

function renderQT() {
  const tbl = el('table',{},[
    el('thead',{}, el('tr',{},[el('th',{},'â˜…'),el('th',{},'æ–½è¨­'), el('th',{},'å¾…ã¡'), el('th',{},'çŠ¶æ…‹')])),
    el('tbody',{}, state.qt.map(r=>{
      const fav = state.favorites.has(r.attraction_name);
      return el('tr',{},[
        el('td',{}, el('span',{ class:'fav', onclick:()=>toggleFav(r.attraction_name) }, fav ? 'â˜…' : 'â˜†')),
        el('td',{}, r.attraction_name),
        el('td',{}, el('span',{class:'mono'}, (r.wait_time ?? '-').toString())),
        el('td',{}, r.is_open ? el('span',{class:'good'},'é‹å–¶ä¸­') : el('span',{class:'bad'},'ä¼‘æ­¢'))
      ]);
    }))
  ]);
  qtDiv.innerHTML = ''; qtDiv.appendChild(tbl);
  renderFavs();
}

async function toggleFav(name) {
  const parkId = parseInt(parkSel.value, 10);
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  if (state.favorites.has(name)) {
    await supabase.from('user_favorites').delete().match({ user_id: user.id, park_id: parkId, attraction_name: name });
    state.favorites.delete(name);
  } else {
    await supabase.from('user_favorites').upsert({ user_id: user.id, park_id: parkId, attraction_name: name });
    state.favorites.add(name);
  }
  renderFavs(); renderQT();
}

async function loadFavs() {
  const parkId = parseInt(parkSel.value, 10);
  const { data: { user } } = await supabase.auth.getUser();
  state.favorites.clear();
  if (user) {
    const { data } = await supabase.from('user_favorites').select('*').match({ user_id: user.id, park_id: parkId });
    for (const row of (data||[])) state.favorites.add(row.attraction_name);
  }
  renderFavs();
}
function renderFavs() {
  if (!state.qt.length) { document.getElementById('favs').textContent = 'ãƒ‡ãƒ¼ã‚¿æœªå–å¾—'; return; }
  const favs = state.qt.filter(x=> state.favorites.has(x.attraction_name)).map(x=>x.attraction_name);
  document.getElementById('favs').textContent = favs.length ? 'ãŠæ°—ã«å…¥ã‚Šï¼š' + favs.join('ã€') : 'â˜…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤ã§ãã¾ã™ã€‚';
}

// ======= Fetch: DPA statuses =======
async function loadDPA() {
  // latest snapshot per attraction (take last rows)
  const parkCode = parkSel.value === '274' ? 'TDL' : 'TDS';
  // join attractions + latest status
  const { data: attrs } = await supabase.from('attractions').select('id, name, park_id').in('park_id',
    (await supabase.from('parks').select('id').eq('code', parkCode)).data?.map(p=>p.id) || []
  );
  if (!attrs) { dpaDiv.textContent = 'attractions ãªã—'; return; }

  const latest = [];
  for (const a of attrs) {
    const { data: rows } = await supabase.from('attraction_status')
       .select('dpa_status, pp40_status, fetched_at').eq('attraction_id', a.id)
       .order('fetched_at', { ascending:false }).limit(1);
    if (rows && rows[0]) latest.push({ name: a.name, ...rows[0] });
  }
  latest.sort((x,y)=> x.name.localeCompare(y.name,'ja'));
  state.dpa = latest;
  renderDPA();
}

function renderDPA() {
  const tbl = el('table',{},[
    el('thead',{}, el('tr',{},[el('th',{},'æ–½è¨­'), el('th',{},'DPA'), el('th',{},'PP(40th)'), el('th',{},'æ›´æ–°')])),
    el('tbody',{}, state.dpa.map(r=> el('tr',{},[
      el('td',{}, r.name),
      el('td',{}, el('span',{class:'tag dpa'}, r.dpa_status || '-')),
      el('td',{}, el('span',{class:'tag pp'}, r.pp40_status || '-')),
      el('td',{}, new Date(r.fetched_at).toLocaleTimeString())
    ])))
  ]);
  dpaDiv.innerHTML = ''; dpaDiv.appendChild(tbl);
}

// ======= Presets =======
async function refreshPresets() {
  const { data: { user } } = await supabase.auth.getUser();
  presetSelect.innerHTML = '';
  if (!user) return;
  const { data } = await supabase.from('user_presets').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
  for (const p of (data || [])) {
    const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; presetSelect.appendChild(opt);
  }
}
document.getElementById('btnSavePreset').onclick = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  const parkId = parseInt(parkSel.value, 10);
  const items = Array.from(state.favorites).map(n=>({ name:n, count:1 }));
  const name = presetName.value || 'ãƒ—ãƒªã‚»ãƒƒãƒˆ';
  await supabase.from('user_presets').insert({ user_id: user.id, name, park_id: parkId, items });
  presetName.value=''; await refreshPresets(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
};
document.getElementById('btnLoadPreset').onclick = async () => {
  const id = presetSelect.value; if (!id) return;
  const { data } = await supabase.from('user_presets').select('*').eq('id', id).single();
  if (!data) return;
  state.favorites = new Set(data.items.map(x=>x.name));
  renderFavs(); renderQT();
};

// ======= Planner =======
function generateDpaSlots(dateStr) {
  // Generate 8:45 to 21:00 by 15m, each valid for 1h
  const out = [];
  let start = new Date(dateStr + 'T08:45:00');
  const end = new Date(dateStr + 'T21:00:00');
  for (let d = new Date(start); d <= end; d = new Date(d.getTime() + 15*60*1000)) {
    out.push({ start: new Date(d), end: new Date(d.getTime() + 60*60*1000) });
  }
  return out;
}

document.getElementById('btnPlan').onclick = () => {
  const parkId = parseInt(parkSel.value, 10);
  const favs = state.qt.filter(x=> state.favorites.has(x.attraction_name));
  if (!favs.length) { document.getElementById('planOut').textContent = 'â˜…ã§æ–½è¨­ã‚’é¸ã‚“ã§ãã ã•ã„'; return; }
  const startTime = document.getElementById('startTime').value || '09:00';
  const walk = parseInt(document.getElementById('walk').value,10) || 10;
  const rideCount = parseInt(document.getElementById('rideCount').value,10) || favs.length;
  const today = new Date().toISOString().slice(0,10);
  const slots = generateDpaSlots(today);

  // Greedy: use DPA for top waits if possible
  const sorted = favs.slice(0).sort((a,b)=>(b.wait_time||0)-(a.wait_time||0));
  const dpaAssignCount = Math.min( Math.ceil(sorted.length/2), rideCount ); // simple heuristic
  const dpaTargets = new Set(sorted.slice(0, dpaAssignCount).map(x=>x.attraction_name));

  let cursor = new Date(`${today}T${startTime}:00`);
  const steps = [];
  for (let i=0;i<rideCount && i<favs.length;i++) {
    const r = favs[i];
    if (dpaTargets.has(r.attraction_name)) {
      // find next slot whose window includes cursor+walk ~ cursor+walk+30m
      const s = slots.find(s=> s.start >= cursor && s.start <= new Date(cursor.getTime()+60*60*1000));
      const when = s ? s.start : cursor;
      steps.push(`${when.toTimeString().slice(0,5)} DPAåˆ©ç”¨ â†’ ${r.attraction_name}ï¼ˆå…¥å ´ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: ${s ? s.start.toTimeString().slice(0,5)+'ã€œ'+s.end.toTimeString().slice(0,5) : 'å³æ™‚'})`);
      cursor = new Date((s ? s.end : new Date(cursor.getTime()+30*60*1000)).getTime() + walk*60*1000);
    } else {
      const w = r.wait_time || 20;
      steps.push(`${cursor.toTimeString().slice(0,5)} ã‚¹ã‚¿ãƒ³ãƒã‚¤ â†’ ${r.attraction_name}ï¼ˆ${w}åˆ†ï¼‰`);
      cursor = new Date(cursor.getTime() + (w+walk)*60*1000);
    }
  }
  document.getElementById('planOut').textContent = steps.join('\n');
};

// ======= Notifications feed (Supabase Realtime) =======
async function loadFeed() {
  const { data } = await supabase.from('notifications').select('*').order('created_at', { ascending: false }).limit(20);
  renderFeed(data||[]);
}
function renderFeed(items) {
  feedDiv.innerHTML = '';
  for (const n of items) {
    const row = el('div',{ class:'chip' },[
      el('span',{}, `[${new Date(n.created_at).toLocaleTimeString()}] ${n.title} - ${n.body}`)
    ]);
    feedDiv.appendChild(row);
  }
}
// Realtime subscription
supabase
  .channel('table-db-changes')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
    renderFeed([payload.new, ...Array.from(feedDiv.children).map(x=>({ title:x.textContent, body:'', created_at:new Date().toISOString()}))]);
  })
  .subscribe();

// ======= Push subscription =======
const btnNotify = document.getElementById('btnNotify');
async function urlB64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}
btnNotify.onclick = async () => {
  const reg = await navigator.serviceWorker.register('/sw.js');
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: await urlB64ToUint8Array(ENV.VAPID_PUBLIC_KEY)
  });
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  // send to function
  const resp = await fetch('/.netlify/functions/push-subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-user-id': user.id },
    body: JSON.stringify(sub.toJSON())
  });
  alert(resp.ok ? 'ç™»éŒ²ã—ã¾ã—ãŸ' : 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
};

// ======= Wire up buttons =======
document.getElementById('btnRefresh').onclick = () => loadQT();
document.getElementById('btnFetchDpa').onclick = async () => {
  await fetch('/.netlify/functions/ingest-tdr-dpa'); // trigger server scrape now
  await loadDPA();
};

parkSel.onchange = async () => { await loadFavs(); await loadQT(); };
await loadFavs(); await loadQT(); await loadDPA(); await refreshPresets(); await loadFeed();
</script>
</body>
</html>
