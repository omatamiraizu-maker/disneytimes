<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TDR DPA & å¾…ã¡æ™‚é–“ é€šçŸ¥ã‚¢ãƒ—ãƒª</title>
<link rel="manifest" href="/manifest.json">
<style>
  :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --mute:#94a3b8; --line:#1f2937; --accent:#38bdf8; --good:#22c55e; --bad:#ef4444; }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  a{color:var(--accent)} header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .g{display:grid;gap:12px} .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:var(--ink);outline:none}
  button{cursor:pointer} .cta{background:var(--accent);color:#00111a;border:0;font-weight:800}
  .mut{color:var(--mute)} .mono{font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:middle}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:8px;color:var(--mute)}
  .tag.dpa{color:#93c5fd;border-color:#1e3a8a}.tag.pp{color:#a7f3d0;border-color:#064e3b}
  .good{color:var(--good)} .bad{color:var(--bad)} .fav{cursor:pointer}
  .plan{white-space:pre-wrap;background:#0b1220;border:1px dashed #334155;padding:10px;border-radius:12px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .w120{width:120px}
  .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center}
  .modal.on{display:flex}
  .tag.stale{ border-color:#7f1d1d; color:#fca5a5 }
  .tag.fresh{ border-color:#1e3a8a; color:#93c5fd }
  .card{background:#0b1220;border:1px solid var(--line);border-radius:16px;padding:18px;min-width:320px;max-width:420px}
  @media (max-width: 720px){
  .g2{ grid-template-columns: 1fr; }
  header .row{ gap:6px; flex-wrap:wrap; }
  .row{ gap:6px; }
  input,select,button{ font-size:16px; } /* iOS ã®å‹æ‰‹ãªã‚ºãƒ¼ãƒ é˜²æ­¢ */
  table{ display:block; overflow-x:auto; white-space:nowrap; font-size:14px; }
  th,td{ padding:6px 4px; }
  }
</style>
</head>
<body>
<header><div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div><strong>ğŸ§­ TDR DPA & å¾…ã¡æ™‚é–“ é€šçŸ¥</strong> <span class="mut">ï¼ˆNetlify + Supabaseï¼‰</span></div>
    <div class="row">
      <span id="userEmail" class="mut"></span>
      <button id="btnOpenLogin" class="cta">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>
      <button id="btnLogout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <button id="btnInstall">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
    </div>
  </div>
</div></header>

<main class="wrap g">
  <section class="panel">
    <div class="row">
      <label>ãƒ‘ãƒ¼ã‚¯ï¼š</label>
      <select id="park"><option value="274">æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰</option><option value="275">æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼</option></select>
      <button id="btnNotify" class="cta">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–</button>
      <span class="mut">ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ï¼‰</span>
    </div>
    <div class="row">
      <span class="pill">ãƒ•ã‚£ãƒ«ã‚¿ï¼š</span>
      <label class="pill"><input type="checkbox" id="fDpaOnly"> DPAå¯¾è±¡ã®ã¿</label>
      <label class="pill"><input type="checkbox" id="fKids"> ã“ã©ã‚‚å‘ã‘</label>
      <label class="pill">å¾…ã¡æ™‚é–“ â‰¤ <input type="number" id="fMaxWait" value="999" class="w120"> åˆ†</label>
      <label class="pill">ä¸¦ã³é †ï¼š
        <select id="sortBy"><option value="name">åå‰</option><option value="wait">å¾…ã¡æ™‚é–“ï¼ˆçŸ­ã„é †ï¼‰</option><option value="open">é‹å–¶ä¸­ã‚’å…ˆã«</option></select>
      </label>
    </div>
  </section>

  <section class="g g2">
    <div class="panel">
      <h3 style="margin-top:0">â± æœ€æ–°å¾…ã¡æ™‚é–“</h3>
      <div class="row">
        <button id="btnRefresh" class="cta">æœ€æ–°ã®å¾…ã¡æ™‚é–“ã‚’è¡¨ç¤º</button>
        <span id="qtUpdated" class="tag"></span>
        <span class="mut">ã‚µãƒ¼ãƒã¯1åˆ†ã”ã¨ä¿å­˜</span>
      </div>
      <div id="qt"></div>
      <div style="margin-top:10px">
        <strong>ğŸ¯ ã„ã¾è¡Œããªã‚‰ï¼ˆãŠæ°—ã«å…¥ã‚Šã‹ã‚‰ï¼‰</strong>
        <div id="nowTips" class="mut">ãŠæ°—ã«å…¥ã‚Šï¼ˆâ˜…ï¼‰ãŒæœªé¸æŠã§ã™ã€‚</div>
      </div>
    </div>
    <div class="panel">
      <h3 style="margin-top:0">ğŸ« DPA / PP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
      <div class="row">
        <button id="btnFetchDpa" class="cta">æœ€æ–°ã‚’å–å¾—ï¼ˆèƒŒæ™¯ã§ç´„15ç§’ï¼‰</button>
        <span id="dpaUpdated" class="tag"></span>
      </div>
      <div id="dpa"></div>
    </div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ”” é€šçŸ¥ãƒ«ãƒ¼ãƒ«</h3>
    <div class="row">
      <label class="pill"><input type="checkbox" id="rCloseReopen" checked> ä¼‘æ­¢/å†é–‹</label>
      <label class="pill"><input type="checkbox" id="rDpaSale" checked> DPAè²©å£²ä¸­</label>
      <label class="pill">ã‚¹ãƒ‘ã‚¤ã‚¯é–¾å€¤ï¼ˆæ€¥å¤‰åˆ¤å®šå¹…ï¼‰Â±<input type="number" id="rSpike" value="20" class="w120"> åˆ†</label>
      <label class="pill">DPAé–‹å§‹ã® <input type="number" id="rWindow" value="10" class="w120"> åˆ†å‰ã«é€šçŸ¥</label>
      <button id="btnSaveRules" class="cta">ä¿å­˜</button>
    </div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">â­ ãŠæ°—ã«å…¥ã‚Š / ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
    <div class="row">
      <input id="presetName" placeholder="ãƒ—ãƒªã‚»ãƒƒãƒˆå">
      <button id="btnSavePreset" class="cta">ç¾åœ¨ã®â˜…ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</button>
      <select id="presetSelect"></select>
      <button id="btnLoadPreset">ãƒ—ãƒªã‚»ãƒƒãƒˆèª­è¾¼</button>
    </div>
    <div id="favs" class="mut">â˜…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤ã§ãã¾ã™ã€‚</div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ§¾ DPAè³¼å…¥ç®¡ç†ï¼ˆé–‹å§‹â†’çµ‚äº†ã¯è‡ªå‹•ã§+1æ™‚é–“ / ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è‡ªå‹•åæ˜ ï¼‰</h3>
    <div class="grid3">
      <div><label>æ–½è¨­</label><input id="buyName" list="dpaNames" placeholder="ï¼ˆå€™è£œã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å…¥åŠ›ï¼‰"></div>
      <div><label>é–‹å§‹</label><input id="buyStart" type="datetime-local"></div>
      <div><label>çµ‚äº†</label><input id="buyEnd" type="datetime-local"></div>
      <div><label>æšæ•°</label><input id="buyQty" type="number" value="1"></div>
      <div><label>ãƒ¡ãƒ¢</label><input id="buyNote"></div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAddPurchase" class="cta">ç™»éŒ²</button>
        <span class="mut">â€»ãã®æ—¥ã®ã€Œè‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã«å³æ™‚è¿½åŠ ã•ã‚Œã¾ã™</span>
      </div>
    </div>
    <div id="purchases"></div>
    <div id="autoSchedLink" class="mut" style="margin-top:8px"></div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ“… æ‰‹å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆï¼ˆå›æ•°æŒ‡å®šï¼†å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆãƒ»ç°¡æ˜“ã‚¨ãƒªã‚¢æœ€é©åŒ–ï¼‰</h3>
    <div class="row">
      <label>é–‹å§‹æ™‚åˆ»</label><input id="startTime" type="time" value="09:00">
      <label>å¾’æ­©/ç§»å‹•(åˆ†)</label><input id="walk" type="number" value="10" class="w120">
      <button id="btnPlan" class="cta">ç”Ÿæˆã—ã¦ä¿å­˜</button>
      <span id="shareLink" class="mut"></span>
    </div>

    <h4 style="margin:12px 0 6px">ğŸ‰ å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‘ãƒ¬ãƒ¼ãƒ‰/ã‚·ãƒ§ãƒ¼ï¼‰</h4>
    <div class="grid3" style="margin-bottom:8px">
      <div>
        <label>åç§°</label>
        <input id="evName" list="paradeNames" placeholder="ä¾‹ï¼šãƒ‡ã‚¤ãƒ»ãƒ‘ãƒ¬ãƒ¼ãƒ‰">
      </div>
      <div>
        <label>é–‹å§‹</label>
        <input id="evStart" type="datetime-local">
      </div>
      <div>
        <label>æ‰€è¦(åˆ†)</label>
        <input id="evDur" type="number" value="30">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnAddEvent" class="cta">è¿½åŠ </button>
        <span class="mut">â€»å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã¯ã“ã®æ™‚é–“ã‚’å„ªå…ˆã€‚å¾…ã¡æ™‚é–“è¨ˆç®—ã¯ä½¿ã„ã¾ã›ã‚“ã€‚</span>
      </div>
    </div>
    <div id="eventsList"></div>

    <h4 style="margin:12px 0 6px">ğŸ”¢ å›æ•°æŒ‡å®šï¼ˆâ˜…ãŒå¯¾è±¡ï¼‰</h4>
    <div id="counts"></div>

    <div id="planOut" class="plan" style="margin-top:10px"></div>
  </section>

  <section class="panel">
    <h3 style="margin-top:0">ğŸ”” é€šçŸ¥ãƒ•ã‚£ãƒ¼ãƒ‰</h3>
    <div id="feed"></div>
  </section>
</main>

<!-- datalistï¼ˆå€™è£œï¼‰ -->
<datalist id="dpaNames"></datalist>
<datalist id="paradeNames"></datalist>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="loginModal">
  <div class="card">
    <h3 style="margin-top:0">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
    <p class="mut">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</p>

    <!-- ã“ã“ã¯ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ç”¨ã®è¡Œï¼ˆIDä»˜ä¸ï¼‰ -->
    <div class="row" id="emailRow">
      <input id="loginEmail" type="email" placeholder="your@email.com" style="flex:1">
    </div>

    <!-- è¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³æ–¹å¼ã®åˆ‡æ›¿ -->
    <div class="row" style="gap:6px;margin-top:8px">
      <label class="pill"><input type="radio" name="loginMode" id="modeEmail" checked> ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯</label>
      <label class="pill"><input type="radio" name="loginMode" id="modePw"> ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    </div>

    <!-- è¿½åŠ ï¼šID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒœãƒƒã‚¯ã‚¹ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
    <div id="pwBox" style="display:none;margin-top:8px">
      <div class="row"><input id="loginId" placeholder="ãƒ¡ãƒ¼ãƒ« or ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" style="flex:1"></div>
      <div class="row"><input id="loginPw" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="flex:1"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnSigninPw" class="cta">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="btnSignupPw">æ–°è¦ç™»éŒ²</button>
      </div>
    </div>

    <!-- ã“ã“ã¯ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯é€ä¿¡ç”¨ã®ãƒœã‚¿ãƒ³è¡Œï¼ˆIDä»˜ä¸ï¼‰ -->
    <div class="row" id="emailActionRow" style="justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="btnCloseLogin">é–‰ã˜ã‚‹</button>
      <button id="btnSendLink" class="cta">ãƒªãƒ³ã‚¯ã‚’é€ä¿¡</button>
    </div>
  </div>
</div>

<script src="/.netlify/functions/env"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

const ENV = window.ENV || {};

// localStorage ãŒä½¿ãˆãªã„(iOSãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/å®¹é‡åˆ‡ã‚Œ)æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
const safeStorage = (()=> {
  try { const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
  catch(e){ let mem={}; return { getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=v}, removeItem:k=>{delete mem[k]} }; }
})();

const supabase = createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: safeStorage,
    storageKey: 'tdr-sb'
  }
});

// èµ·å‹•ç›´å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿å‡ºã—ï¼ˆPWA/offlineã§ã‚‚å³å¾©å…ƒï¼‰
await supabase.auth.getSession();

// ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã® #access_token ã‚’ç‰‡ã¥ã‘ï¼ˆã‚µã‚¤ãƒ³ã‚¤ãƒ³ç¢ºå®šå¾Œï¼‰
supabase.auth.onAuthStateChange((event) => {
  if (event === 'SIGNED_IN' && location.hash.includes('access_token')) {
    history.replaceState({}, '', location.pathname + location.search);
  }
});

// ã‚¿ãƒ–å¾©å¸°æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†ç¢ºèªï¼ˆiOSã§ã®ä¸€æ™‚ç ´æ£„å¯¾ç­–ï¼‰
document.addEventListener('visibilitychange', async()=>{
  if (!document.hidden) { await supabase.auth.getSession().catch(()=>{}); }
});

// ===== PWA install prompt =====
let deferredPrompt=null;
const btnInstall = document.getElementById('btnInstall');
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.disabled = false;
});
btnInstall.disabled = isIOS ? false : true;

btnInstall.onclick = async()=>{
  if (isIOS && !isStandalone) {
    alert('iPhoneã§ã¯ã€Safariã§ã€Œå…±æœ‰ã€â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«é€šçŸ¥ã‚‚æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚');
    return;
  }
  if (!deferredPrompt){
    alert('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æ¡ä»¶ãŒã¾ã æº€ãŸã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
};

// ===== ãƒ­ã‚°ã‚¤ãƒ³UIï¼ˆãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ / ID+ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ä¸¡å¯¾å¿œï¼‰=====
const userEmail = document.getElementById('userEmail');
const btnOpenLogin = document.getElementById('btnOpenLogin');
const btnLogout = document.getElementById('btnLogout');
const loginModal = document.getElementById('loginModal');

// ãƒ¡ãƒ¼ãƒ«æ–¹å¼ã®è¦ç´ 
const loginEmail = document.getElementById('loginEmail');
const emailRow = document.getElementById('emailRow');               // â† ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã«è¿½åŠ ã—ãŸID
const emailActionRow = document.getElementById('emailActionRow');   // â† ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã«è¿½åŠ ã—ãŸID
const btnSendLink = document.getElementById('btnSendLink');

// æ–¹å¼åˆ‡æ›¿ / IDãƒ‘ã‚¹æ–¹å¼ã®è¦ç´ 
const modeEmail = document.getElementById('modeEmail'); // ãƒ©ã‚¸ã‚ª
const modePw    = document.getElementById('modePw');    // ãƒ©ã‚¸ã‚ª
const pwBox     = document.getElementById('pwBox');
const loginId   = document.getElementById('loginId');
const loginPw   = document.getElementById('loginPw');
const btnSigninPw = document.getElementById('btnSigninPw');
const btnSignupPw = document.getElementById('btnSignupPw');

document.getElementById('btnCloseLogin').onclick = () => loginModal.classList.remove('on');
btnLogout.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

// ãƒ¢ãƒ¼ãƒ‰é©ç”¨
function applyLoginMode(){
  const usePw = modePw?.checked;
  if (pwBox) pwBox.style.display = usePw ? 'block' : 'none';
  if (emailRow) emailRow.style.display = usePw ? 'none' : 'flex';
  if (emailActionRow) emailActionRow.style.display = usePw ? 'none' : 'flex';
}
if (modeEmail && modePw){
  modeEmail.onchange = modePw.onchange = applyLoginMode;
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãæ™‚ç‚¹ã§æ—¢å®šã¯ã€Œãƒ¡ãƒ¼ãƒ«æ–¹å¼ã€
btnOpenLogin.onclick = () => {
  if (modeEmail) modeEmail.checked = true;
  if (modePw) modePw.checked = false;
  applyLoginMode();
  loginModal.classList.add('on');
  if (loginEmail) loginEmail.focus();
};

// --- ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯æ–¹å¼ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¸è¥²ï¼‰ ---
btnSendLink.onclick = async () => {
  const email = (loginEmail?.value || '').trim();
  if (!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');

  let { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: location.origin + '/app.html', shouldCreateUser: false }
  });

  if (error && /user.*not.*found|invalid login|No account/i.test(error.message)) {
    const r1 = await supabase.auth.signUp({ email, options: { emailRedirectTo: location.origin + '/app.html' } });
    if (r1.error) return alert(r1.error.message);
    error = null;
  }
  if (error && /Database error saving new user|duplicate key|partial_key/i.test(error.message)) {
    const r2 = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.origin + '/app.html', shouldCreateUser: false } });
    if (r2.error) return alert(r2.error.message);
  }

  alert('ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚');
  loginModal.classList.remove('on');
};

// --- ID / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ–¹å¼ï¼ˆç°¡æ˜“ç‰ˆï¼šID=ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã†ï¼‰ ---
if (btnSigninPw) btnSigninPw.onclick = async () => {
  const id = (loginId?.value || '').trim();
  const pw = (loginPw?.value || '').trim();
  if (!id || !pw) return alert('ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  // ç°¡æ˜“é‹ç”¨ï¼šID=ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã†ï¼ˆæœ¬æ ¼å°å…¥ã¯ usernameâ†’email è§£æ±ºã®Edge Functionã‚’åˆ¥é€”ç”¨æ„ï¼‰
  if (!id.includes('@')) return alert('ã“ã®ç°¡æ˜“å®Ÿè£…ã§ã¯ ID=ãƒ¡ãƒ¼ãƒ« ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã§ãŠè©¦ã—ãã ã•ã„ã€‚');

  const { error } = await supabase.auth.signInWithPassword({ email: id, password: pw });
  if (error) return alert(error.message);
  loginModal.classList.remove('on');
};

if (btnSignupPw) btnSignupPw.onclick = async () => {
  const id = (loginId?.value || '').trim();
  const pw = (loginPw?.value || '').trim();
  if (!id || !pw) return alert('ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  if (!id.includes('@')) return alert('ã“ã®ç°¡æ˜“å®Ÿè£…ã§ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯å¾Œã‹ã‚‰è¨­å®šã§ãã¾ã™ï¼‰');

  const { error } = await supabase.auth.signUp({ email: id, password: pw });
  if (error) return alert(error.message);
  alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚å±Šã„ãŸç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
  loginModal.classList.remove('on');
};

async function refreshAuthUI(){
  const { data:{ user } } = await supabase.auth.getUser();
  if (user){ userEmail.textContent=user.email||'(ãƒ­ã‚°ã‚¤ãƒ³ä¸­)'; btnOpenLogin.style.display='none'; btnLogout.style.display='inline-block'; }
  else { userEmail.textContent=''; btnOpenLogin.style.display='inline-block'; btnLogout.style.display='none'; }
}
await refreshAuthUI(); supabase.auth.onAuthStateChange(refreshAuthUI);

// ===== å…±é€šãƒ˜ãƒ«ãƒ‘ =====
const parkSel = document.getElementById('park');
const qtDiv = document.getElementById('qt');
const dpaDiv = document.getElementById('dpa');
const feedDiv = document.getElementById('feed');
const nowTipsDiv = document.getElementById('nowTips');
const shareLink=document.getElementById('shareLink');
const autoSchedLink=document.getElementById('autoSchedLink');

const fDpaOnly = document.getElementById('fDpaOnly');
const fKids = document.getElementById('fKids');
const fMaxWait = document.getElementById('fMaxWait');
const sortBy = document.getElementById('sortBy');

const rCloseReopen = document.getElementById('rCloseReopen');
const rDpaSale = document.getElementById('rDpaSale');
const rSpike = document.getElementById('rSpike');
const rWindow = document.getElementById('rWindow');
const btnSaveRules = document.getElementById('btnSaveRules');

const presetName=document.getElementById('presetName');
const presetSelect=document.getElementById('presetSelect');

const buyName=document.getElementById('buyName');
const buyStart=document.getElementById('buyStart');
const buyEnd=document.getElementById('buyEnd');
const buyQty=document.getElementById('buyQty');
const buyNote=document.getElementById('buyNote');

const planOut=document.getElementById('planOut');
const countsDiv=document.getElementById('counts');

const evName = document.getElementById('evName');
const evStart = document.getElementById('evStart');
const evDur = document.getElementById('evDur');
const btnAddEvent = document.getElementById('btnAddEvent');
const eventsList = document.getElementById('eventsList');

const state={
  favorites:new Set(), qt:[], dpa:[], rules:null, purchases:[],
  parades:[],
  fixedManual:[],   // æ‰‹å‹•è¿½åŠ ã®å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆ
  fixedAuto:[]      // è‡ªå‹•ï¼ˆDPAè³¼å…¥â†’å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆåŒ–ï¼‰
};

function normalizeTitle(s){
  return (s||'')
    .replace(/[â€™ï¼‡`Â´â€˜]/g,"'")         // ã‚¢ãƒã‚¹ãƒˆãƒ­ãƒ•ã‚£é¡
    .replace(/[â€œâ€ï¼‚]/g,'"')            // äºŒé‡å¼•ç”¨ç¬¦é¡
    .replace(/[ï¼†]/g,'&')              // å…¨è§’ã‚¢ãƒ³ãƒ‘ã‚µãƒ³ãƒ‰
    .replace(/\s+/g,'')                // ç©ºç™½é¡ã‚’é™¤å»
    .replace(/ã€€/g,'');                // å…¨è§’ç©ºç™½
}
  
function makeAreaMap(obj){
  const m = new Map();
  for (const [k,v] of Object.entries(obj)) m.set(normalizeTitle(k), v);
  return m;
}
const AREA_MAP = {
  // 274: æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰
  274: makeAreaMap({
    // ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«
    'ã‚ªãƒ ãƒ‹ãƒã‚¹':'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«',
    'ãƒšãƒ‹ãƒ¼ã‚¢ãƒ¼ã‚±ãƒ¼ãƒ‰':'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«',

    // ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰
    'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒªãƒãƒ¼é‰„é“':'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚«ãƒªãƒ–ã®æµ·è³Š':'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ã‚¯ãƒ«ãƒ¼ã‚ºï¼šãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ»ã‚¨ã‚¯ã‚¹ãƒšãƒ‡ã‚£ã‚·ãƒ§ãƒ³':'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚¹ã‚¤ã‚¹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ»ãƒ„ãƒªãƒ¼ãƒã‚¦ã‚¹':'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'é­…æƒ‘ã®ãƒã‚­ãƒ«ãƒ¼ãƒ ï¼šã‚¹ãƒ†ã‚£ãƒƒãƒãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ„â€œã‚¢ãƒ­ãƒãƒ»ã‚¨ãƒ»ã‚³ãƒ¢ãƒ»ãƒã‚¤ï¼â€':'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰',

    // ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰
    'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰ãƒ»ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚®ãƒ£ãƒ©ãƒªãƒ¼':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰',
    'ã‚«ãƒ³ãƒˆãƒªãƒ¼ãƒ™ã‚¢ãƒ»ã‚·ã‚¢ã‚¿ãƒ¼':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰',
    'è’¸æ°—èˆ¹ãƒãƒ¼ã‚¯ãƒˆã‚¦ã‚§ã‚¤ãƒ³å·':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰',
    'ãƒãƒ¼ã‚¯ãƒˆã‚¦ã‚§ã‚¤ãƒ³å·':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰', // è¡¨è¨˜ã‚†ã‚Œå¯¾å¿œ
    'ãƒˆãƒ ã‚½ãƒ¼ãƒ¤å³¶ã„ã‹ã ':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰',
    'ãƒ“ãƒƒã‚°ã‚µãƒ³ãƒ€ãƒ¼ãƒ»ãƒã‚¦ãƒ³ãƒ†ãƒ³':'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰',

    // ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼
    'ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãƒ»ãƒã‚¦ãƒ³ãƒ†ãƒ³':'ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼',
    'ãƒ“ãƒ¼ãƒãƒ¼ãƒ–ãƒ©ã‚¶ãƒ¼ã‚ºã®ã‚«ãƒŒãƒ¼æ¢æ¤œ':'ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼',

    // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰
    'ã‚¢ãƒªã‚¹ã®ãƒ†ã‚£ãƒ¼ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚¤ãƒƒãƒ„ãƒ»ã‚¢ãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚­ãƒ£ãƒƒã‚¹ãƒ«ã‚«ãƒ«ãƒ¼ã‚»ãƒ«':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ç™½é›ªå§«ã¨ä¸ƒäººã®ã“ã³ã¨':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ã®ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ†ã‚¤ãƒ«ãƒ»ãƒ›ãƒ¼ãƒ«':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ç©ºé£›ã¶ãƒ€ãƒ³ãƒœ':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ç¾å¥³ã¨é‡ç£â€é­”æ³•ã®ã‚‚ã®ãŒãŸã‚Šâ€':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰', // â€â€ ç‰ˆ
    'ç¾å¥³ã¨é‡ç£â€œé­”æ³•ã®ã‚‚ã®ãŒãŸã‚Šâ€':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰', // â€œâ€ ç‰ˆ
    'ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ³ç©ºã®æ—…':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒ”ãƒã‚­ã‚ªã®å†’é™ºæ—…è¡Œ':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒ—ãƒ¼ã•ã‚“ã®ãƒãƒ‹ãƒ¼ãƒãƒ³ãƒˆ':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒ›ãƒ¼ãƒ³ãƒ†ãƒƒãƒ‰ãƒãƒ³ã‚·ãƒ§ãƒ³':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒŸãƒƒã‚­ãƒ¼ã®ãƒ•ã‚£ãƒ«ãƒãƒ¼ãƒã‚¸ãƒƒã‚¯':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰',

    // ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³
    'ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚´ãƒ¼ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ã‚°ãƒ¼ãƒ•ã‚£ãƒ¼ã®ãƒšã‚¤ãƒ³ãƒˆ&ãƒ—ãƒ¬ã‚¤ãƒã‚¦ã‚¹':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ã‚°ãƒ¼ãƒ•ã‚£ãƒ¼ã®ãƒšã‚¤ãƒ³ãƒˆï¼†ãƒ—ãƒ¬ã‚¤ãƒã‚¦ã‚¹':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³', // å…¨è§’ï¼†
    'ãƒãƒƒãƒ—ã¨ãƒ‡ãƒ¼ãƒ«ã®ãƒ„ãƒªãƒ¼ãƒã‚¦ã‚¹':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ãƒˆã‚¥ãƒ¼ãƒ³ãƒ‘ãƒ¼ã‚¯':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ãƒ‰ãƒŠãƒ«ãƒ‰ã®ãƒœãƒ¼ãƒˆ':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ãƒŸãƒ‹ãƒ¼ã®å®¶':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',
    'ãƒ­ã‚¸ãƒ£ãƒ¼ãƒ©ãƒ“ãƒƒãƒˆã®ã‚«ãƒ¼ãƒˆã‚¥ãƒ¼ãƒ³ã‚¹ãƒ”ãƒ³':'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³',

    // ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰
    'ã‚¹ã‚¿ãƒ¼ãƒ„ã‚¢ãƒ¼ã‚ºï¼šã‚¶ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã‚ºãƒ»ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚¹ãƒ†ã‚£ãƒƒãƒãƒ»ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ãƒã‚¦ãƒ³ãƒ†ãƒ³':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒã‚ºãƒ»ãƒ©ã‚¤ãƒˆã‚¤ãƒ¤ãƒ¼ã®ã‚¢ã‚¹ãƒˆãƒ­ãƒ–ãƒ©ã‚¹ã‚¿ãƒ¼':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒ™ã‚¤ãƒãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ”ãƒ¼ãƒ©ã‚¤ãƒ‰':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
    'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ã‚¯â€ãƒ©ã‚¤ãƒ‰&ã‚´ãƒ¼ã‚·ãƒ¼ã‚¯ï¼â€':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',   // â€â€ & ç‰ˆ
    'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ã‚¯â€œãƒ©ã‚¤ãƒ‰ï¼†ã‚´ãƒ¼ã‚·ãƒ¼ã‚¯ï¼â€':'ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰'    // â€œâ€ ï¼† ç‰ˆ
  }),

  // 275: æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼
  275: makeAreaMap({
    // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹
    'ã‚¢ãƒŠã¨ã‚¨ãƒ«ã‚µã®ãƒ•ãƒ­ãƒ¼ã‚ºãƒ³ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹',
    'ãƒ©ãƒ—ãƒ³ãƒ„ã‚§ãƒ«ã®ãƒ©ãƒ³ã‚¿ãƒ³ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹',
    'ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ³ã®ãƒãƒãƒ¼ãƒ©ãƒ³ãƒ‰ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹',
    'ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ»ãƒ†ã‚£ãƒ³ã‚«ãƒ¼ãƒ™ãƒ«ã®ãƒ“ã‚¸ãƒ¼ãƒã‚®ãƒ¼':'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹',

    // ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ¼ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼
    'ã‚½ã‚¢ãƒªãƒ³ï¼šãƒ•ã‚¡ãƒ³ã‚¿ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ»ãƒ•ãƒ©ã‚¤ãƒˆ':'ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ¼ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼',
    'ãƒ´ã‚§ãƒãƒ„ã‚£ã‚¢ãƒ³ãƒ»ã‚´ãƒ³ãƒ‰ãƒ©':'ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ¼ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼',
    'ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆã‚¹ãƒãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³':'ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ¼ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    'ãƒ•ã‚©ãƒ¼ãƒˆãƒ¬ã‚¹ãƒ»ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³':'ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ¼ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼',

    // ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ
    'ã‚¿ãƒ¯ãƒ¼ãƒ»ã‚ªãƒ–ãƒ»ãƒ†ãƒ©ãƒ¼':'ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ',
    'ãƒˆã‚¤ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ãƒãƒ‹ã‚¢ï¼':'ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ',
    'ã‚¿ãƒ¼ãƒˆãƒ«ãƒ»ãƒˆãƒ¼ã‚¯':'ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ',
    'ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼ãƒ»ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ¬ãƒ¼ãƒ«ã‚¦ã‚§ã‚¤':'ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    'ãƒ“ãƒƒã‚°ã‚·ãƒ†ã‚£ãƒ»ãƒ´ã‚£ãƒ¼ã‚¯ãƒ«':'ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ',

    // ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼
    'ãƒ‹ãƒ¢ï¼†ãƒ•ãƒ¬ãƒ³ã‚ºãƒ»ã‚·ãƒ¼ãƒ©ã‚¤ãƒ€ãƒ¼':'ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼',
    'ã‚¢ã‚¯ã‚¢ãƒˆãƒ”ã‚¢':'ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼',

    // ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿
    'ã‚¤ãƒ³ãƒ‡ã‚£ãƒ»ã‚¸ãƒ§ãƒ¼ãƒ³ã‚ºÂ®ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ï¼šã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚¹ã‚«ãƒ«ã®é­”å®®':'ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿',
    'ãƒ¬ã‚¤ã‚¸ãƒ³ã‚°ãƒ»ã‚¹ãƒ”ãƒªãƒƒãƒ„':'ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿',

    // ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ
    'ã‚·ãƒ³ãƒ‰ãƒãƒƒãƒ‰ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ–ãƒƒã‚¯ãƒ»ãƒ´ã‚©ãƒ¤ãƒƒã‚¸':'ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ',
    'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ã®ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ã‚«ãƒ¼ãƒšãƒƒãƒˆ':'ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ',
    'ã‚­ãƒ£ãƒ©ãƒãƒ³ã‚«ãƒ«ãƒ¼ã‚»ãƒ«':'ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ',
    'ãƒã‚¸ãƒƒã‚¯ãƒ©ãƒ³ãƒ—ã‚·ã‚¢ã‚¿ãƒ¼':'ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ',

    // ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³
    'ã‚¹ã‚«ãƒƒãƒˆãƒ«ã®ã‚¹ã‚¯ãƒ¼ã‚¿ãƒ¼':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ãƒ•ãƒ©ãƒ³ãƒ€ãƒ¼ã®ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ã‚¢ãƒªã‚¨ãƒ«ã®ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ã‚¸ãƒ£ãƒ³ãƒ”ãƒ³ãƒ»ã‚¸ã‚§ãƒªãƒ¼ãƒ•ã‚£ãƒƒã‚·ãƒ¥':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ãƒ–ãƒ­ãƒ¼ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒ»ãƒãƒ«ãƒ¼ãƒ³ãƒ¬ãƒ¼ã‚¹':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ãƒ¯ãƒ¼ãƒ«ãƒ—ãƒ¼ãƒ«':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',
    'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³ã‚·ã‚¢ã‚¿ãƒ¼':'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³',

    // ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰
    'ã‚»ãƒ³ã‚¿ãƒ¼ãƒ»ã‚ªãƒ–ãƒ»ã‚¸ãƒ»ã‚¢ãƒ¼ã‚¹':'ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰',
    'æµ·åº•2ä¸‡ãƒã‚¤ãƒ«':'ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰'
  })
};

function el(tag, attrs={}, children=[]){ const e=document.createElement(tag); for(const[k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } for(const c of (Array.isArray(children)?children:[children])) e.appendChild(typeof c==='string'?document.createTextNode(c):c); return e; }
function fmtLocal(dt){ const pad=n=>String(n).padStart(2,'0'); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`; }
function areaOf(nameJa){
  const m = AREA_MAP[parkSel.value];
  return m?.get(normalizeTitle(nameJa)) || '?';
}
// === æœ€çµ‚æ›´æ–°ã®è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ ===
function fmtUpdated(ts){
  if (!ts) return '';
  const d = new Date(ts);
  const pad = n=>String(n).padStart(2,'0');
  const hhmm = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const diffMin = Math.max(0, Math.round((Date.now() - d.getTime())/60000));
  return `æœ€çµ‚æ›´æ–° ${hhmm}ï¼ˆ${diffMin}åˆ†å‰ï¼‰`;
}
function setUpdated(el, ts, staleMinutes){
  if (!el) return;
  if (!ts){ el.textContent=''; el.classList.remove('stale','fresh'); return; }
  el.textContent = fmtUpdated(ts);
  const ageMin = Math.max(0, Math.round((Date.now() - new Date(ts).getTime())/60000));
  el.classList.toggle('stale', ageMin >= staleMinutes);
  el.classList.toggle('fresh', ageMin < staleMinutes);
}
// ===== DPAè³¼å…¥ï¼šé–‹å§‹â†’çµ‚äº†+1h è‡ªå‹•å…¥åŠ› =====
buyStart.addEventListener('change', ()=>{
  if(!buyStart.value) return;
  const s = new Date(buyStart.value);
  const e = new Date(s.getTime() + 60*60000);
  buyEnd.value = fmtLocal(e);
});

// ===== å¾…ã¡æ™‚é–“ï¼ˆæ—¥æœ¬èªãƒ“ãƒ¥ãƒ¼ï¼‰ =====
async function loadQT(forceHeal=false){
  const parkId = parseInt(parkSel.value,10);

  // 1) Supabase ã‹ã‚‰èª­ã‚€
  const { data, error } = await supabase
    .from('v_queue_times_latest')
    .select('name_ja,name_raw,is_open,wait_time,fetched_at')
    .eq('park_id',parkId)
    .limit(600);

  if (error){ qtDiv.textContent=error.message; return; }

  // 2) ãƒ‡ãƒ¼ã‚¿ãŒç©º / ã»ã¼å…¨ä»¶ 0åˆ†&ä¼‘æ­¢ = å–ã‚Šè¾¼ã¿æ­»ã‚’ç–‘ã†
  const rows = data||[];
  const stale = !rows.length || rows.filter(r => (r.wait_time??0)===0 && !r.is_open).length >= Math.max(5, Math.floor(rows.length*0.8));

  // 3) stale ã®ã¨ãã¯ä¸€åº¦ã ã‘è‡ªå·±ä¿®å¾©ï¼ˆNetlifyé–¢æ•°ã‚’å©ãï¼‰
  if (stale && !forceHeal){
    qtDiv.innerHTML = '<div class="mut">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒã¨åŒæœŸã—ã¦ã„ã¾ã™â€¦ï¼ˆæ•°ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰</div>';
    await triggerQtSync(parkId);        // â† ä¸‹ã«å®šç¾©
    // å°‘ã—å¾…ã£ã¦å†èª­è¾¼
    await new Promise(r=>setTimeout(r, 4000));
    return loadQT(true);
  }

  // 4) è¡¨ç¤ºã¸
  state.qt = rows.map(r=>({ nameJa:r.name_ja, nameRaw:r.name_raw, open:r.is_open, wait:r.wait_time, time:r.fetched_at }));
  // â˜… æœ€çµ‚æ›´æ–° = è¡Œã® fetched_at ã®æœ€å¤§
  const latestTs = rows.length ? rows.reduce((mx,r)=> (mx && new Date(mx)>new Date(r.fetched_at)? mx : r.fetched_at), rows[0].fetched_at) : null;
  setUpdated(document.getElementById('qtUpdated'), latestTs, 5); // 5åˆ†è¶…ã§ stale æ‰±ã„
  
  renderQT(); renderCountsEditor(); renderNowTips(); fillDpaNameList();
}

// Netlifyé–¢æ•°ã‚’å©ã„ã¦ã€Œå–ã‚Šè¾¼ã¿ã€ã‚’å¼·åˆ¶ï¼ˆå­˜åœ¨ã™ã‚‹æ–¹ã‚’é †ã«è©¦ã™ï¼‰
async function triggerQtSync(parkId){
  // (A) æœ¬å‘½: ã‚µãƒ¼ãƒå´ã§ Supabase ã«æ›¸ãè¾¼ã‚€é–¢æ•°ï¼ˆã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ç”¨æ„æ¸ˆã¿æƒ³å®šï¼‰
  //   - ä¾‹: /.netlify/functions/sync-qt  ï¼ˆä¸¡ãƒ‘ãƒ¼ã‚¯ã¾ã¨ã‚ã¦ or ?parkId=ï¼‰
  try{
    const u = `/.netlify/functions/sync-qt?parkId=${parkId}`;
    const r = await fetch(u, { method:'POST' });
    if (r.ok) return;
  }catch(_){}

  // (B) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: queue-times ç›´èª­ â†’ è¡¨ç¤ºã ã‘ã§ã‚‚æ›´æ–°ï¼ˆä¿å­˜ã¯ã—ãªã„ï¼‰
  try{
    const r = await fetch(`/.netlify/functions/queue-times?parkId=${parkId}`);
    if (!r.ok) return;
    const j = await r.json();
    // queue-times ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ â†’ ç”»é¢ç”¨ã«å¤‰æ›
    const list = (j.lands||[]).flatMap(l=>l.rides||[]);
    if (list.length){
      state.qt = list.map(x=>({
        nameJa: x.name_jp || x.name,       // ã‚‚ã—è‡ªå‰ã§æ—¥æœ¬èªåã‚’ä»˜ã‘ã¦ã„ã‚‹å ´åˆ
        nameRaw: x.name,
        open: x.is_open ?? (x.is_open === undefined ? x.status!=='Closed' : x.is_open),
        wait: typeof x.wait_time==='number' ? x.wait_time : (x.wait_time_minutes ?? null),
        time: new Date().toISOString()
      }));
      renderQT(); renderCountsEditor(); renderNowTips(); fillDpaNameList();
    }
  }catch(_){}
}
function applyFilters(list){
  let out=list.slice(0);
  if (fKids.checked){ out = out.filter(x=> /ã‚«ãƒ«ãƒ¼ã‚»ãƒ«|ãƒ€ãƒ³ãƒœ|ã‚¹ãƒ¢ãƒ¼ãƒ«|ãƒã‚®ãƒ¼|ãƒ†ã‚£ãƒ³ã‚«|ã‚´ãƒ¼ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼|ãƒ¡ãƒªãƒ¼|ã‚­ãƒ£ãƒ©ãƒãƒ³/i.test(x.nameJa)); }
  if (Number(fMaxWait.value) < 999){ out = out.filter(x=> (x.wait??999) <= Number(fMaxWait.value)); }
  if (fDpaOnly.checked){
    const dpaSet=new Set(state.dpa.filter(d=>d.dpa_status==='è²©å£²ä¸­'||d.dpa_status==='è¦ç¢ºèªï¼ˆè¨˜è¼‰ã‚ã‚Šï¼‰').map(d=>d.name));
    out = out.filter(x=> dpaSet.has(x.nameJa));
  }
  if (sortBy.value==='wait') out.sort((a,b)=>(a.wait??999)-(b.wait??999));
  else if (sortBy.value==='open') out.sort((a,b)=> (b.open?1:0)-(a.open?1:0));
  else out.sort((a,b)=>a.nameJa.localeCompare(b.nameJa,'ja'));
  return out;
}
function renderQT(){
  const rows = applyFilters(state.qt);
  const tbl = el('table',{},[
    el('thead',{}, el('tr',{},[el('th',{},'â˜…'),el('th',{},'æ–½è¨­ï¼ˆæ—¥æœ¬èªï¼‰'),el('th',{},'å¾…ã¡'),el('th',{},'çŠ¶æ…‹'),el('th',{},'äºˆæ¸¬ï¼ˆÂ±30åˆ†/åŒæ›œæ—¥ï¼‰')])),
    el('tbody',{}, rows.map(r=>{
      const fav=state.favorites.has(r.nameRaw);
      const tr=el('tr',{},[
        el('td',{}, el('span',{class:'fav',onclick:()=>toggleFav(r.nameRaw)}, fav?'â˜…':'â˜†')),
        el('td',{}, r.nameJa),
        el('td',{}, el('span',{class:'mono'}, (r.wait??'-').toString())),
        el('td',{}, r.open?el('span',{class:'good'},'é‹å–¶ä¸­'):el('span',{class:'bad'},'ä¼‘æ­¢')),
        el('td',{}, el('span',{class:'mut', id:`pred-${r.nameRaw}`}, fav?'â€¦':'-'))
      ]);
      if (fav) fetch(`/.netlify/functions/qt-stats?park=${parkSel.value}&name=${encodeURIComponent(r.nameRaw)}`)
        .then(r=>r.json()).then(j=>{ const elp=document.getElementById(`pred-${r.nameRaw}`); if (elp) elp.textContent = j?.median!=null ? `${j.median} åˆ† (${j.n})` : '-'; })
        .catch(()=>{});
      return tr;
    }))
  ]);
  qtDiv.innerHTML=''; qtDiv.appendChild(tbl);
}
function fillDpaNameList(){
  const dl=document.getElementById('dpaNames'); dl.innerHTML='';
  for(const r of state.qt) dl.appendChild(el('option',{value:r.nameJa}));
}

// ===== ã€Œã„ã¾è¡Œããªã‚‰ã€ =====
async function renderNowTips(){
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  if (!favs.length){ nowTipsDiv.textContent='ãŠæ°—ã«å…¥ã‚Šï¼ˆâ˜…ï¼‰ãŒæœªé¸æŠã§ã™ã€‚'; return; }
  const scored=[];
  for(const r of favs){
    let median=null;
    try{ const j=await (await fetch(`/.netlify/functions/qt-stats?park=${parkSel.value}&name=${encodeURIComponent(r.nameRaw)}`)).json(); median=j.median; }catch{}
    const delta=(median!=null&&r.wait!=null)? (r.wait - median):0;
    scored.push({ ...r, median, delta });
  }
  scored.sort((a,b)=> (a.delta||999) - (b.delta||999) || (a.wait||999)-(b.wait||999));
  nowTipsDiv.textContent = scored.slice(0,3).map(x=> `${x.nameJa}ï¼ˆ${x.wait??'-'}åˆ† / äºˆæ¸¬${x.median??'-'}ï¼‰`).join(' / ');
}

// ===== DPA / PPï¼ˆæœ€æ–°ï¼‰ =====
async function loadDPA(){
  const parkCode=parkSel.value==='274'?'TDL':'TDS';
  const { data: parks } = await supabase.from('parks').select('id,code').eq('code',parkCode);
  if(!parks?.length){ dpaDiv.textContent='parks ãªã—'; return; }
  const parkId=parks[0].id;
  const { data: attrs } = await supabase.from('attractions').select('id,name,park_id').eq('park_id',parkId);
  const latest=[];
  for(const a of attrs||[]){
    const { data: rows } = await supabase.from('attraction_status').select('dpa_status,pp40_status,fetched_at').eq('attraction_id',a.id).order('fetched_at',{ascending:false}).limit(1);
    if(rows&&rows[0]) latest.push({ name:a.name, dpa_status:rows[0].dpa_status, pp40_status:rows[0].pp40_status, t:rows[0].fetched_at });
  }
  latest.sort((x,y)=>x.name.localeCompare(y.name,'ja'));
  state.dpa=latest;
  const tbl=el('table',{},[
    el('thead',{},el('tr',{},[el('th',{},'æ–½è¨­'),el('th',{},'DPA'),el('th',{},'PP(40th)'),el('th',{},'æ›´æ–°')])),
    el('tbody',{}, latest.map(r=> el('tr',{},[
      el('td',{}, r.name),
      el('td',{}, el('span',{class:'tag dpa'}, r.dpa_status||'-')),
      el('td',{}, el('span',{class:'tag pp'}, r.pp40_status||'-')),
      el('td',{}, new Date(r.t).toLocaleTimeString())
    ])))
  ]);
  dpaDiv.innerHTML=''; dpaDiv.appendChild(tbl);
  // â˜… DPA ã®æœ€çµ‚æ›´æ–°ï¼ˆå„æ–½è¨­ã®æœ€æ–°è¡Œã®æœ€å¤§æ™‚åˆ»ï¼‰
  const latestDpaTs = latest.length ? latest.reduce((mx,r)=> (mx && new Date(mx)>new Date(r.t)? mx : r.t), latest[0].t) : null;
  setUpdated(document.getElementById('dpaUpdated'), latestDpaTs, 10); // 10åˆ†è¶…ã§ stale
}

// ===== ãŠæ°—ã«å…¥ã‚Š =====
async function toggleFav(raw){ const parkId=parseInt(parkSel.value,10); const { data:{user} }=await supabase.auth.getUser(); if(!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  if(state.favorites.has(raw)){ await supabase.from('user_favorites').delete().match({ user_id:user.id, park_id:parkId, attraction_name:raw }); state.favorites.delete(raw); }
  else{ await supabase.from('user_favorites').upsert({ user_id:user.id, park_id:parkId, attraction_name:raw }); state.favorites.add(raw); }
  renderFavs(); renderQT(); renderCountsEditor(); renderNowTips();
}
async function loadFavs(){ const parkId=parseInt(parkSel.value,10); const { data:{user} }=await supabase.auth.getUser(); state.favorites.clear();
  if(user){ const { data } = await supabase.from('user_favorites').select('*').match({ user_id:user.id, park_id:parkId }); for(const r of (data||[])) state.favorites.add(r.attraction_name); }
  renderFavs(); renderCountsEditor();
}
function renderFavs(){
  const names = state.qt.filter(x=>state.favorites.has(x.nameRaw)).map(x=>x.nameJa);
  document.getElementById('favs').textContent = names.length ? 'ãŠæ°—ã«å…¥ã‚Šï¼š'+names.join('ã€') : 'â˜…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /è§£é™¤ã§ãã¾ã™ã€‚';
}

// ===== é€šçŸ¥ãƒ«ãƒ¼ãƒ« =====
async function loadRules(){
  const { data:{user} }=await supabase.auth.getUser(); if(!user){ state.rules=null; return; }
  const { data } = await supabase.from('user_alert_rules').select('*').eq('user_id',user.id).eq('park_id',parseInt(parkSel.value,10)).maybeSingle();
  const r = data || { notify_close_reopen:true, notify_dpa_sale:true, spike_threshold:20, window_minutes:10 };
  rCloseReopen.checked = !!r.notify_close_reopen; rDpaSale.checked = !!r.notify_dpa_sale; rSpike.value = r.spike_threshold; rWindow.value = r.window_minutes;
}
document.getElementById('btnSaveRules').onclick=async()=>{ const { data:{user} }=await supabase.auth.getUser(); if(!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  const row={ user_id:user.id, park_id:parseInt(parkSel.value,10), notify_close_reopen:rCloseReopen.checked, notify_dpa_sale:rDpaSale.checked, spike_threshold:Number(rSpike.value||20), window_minutes:Number(rWindow.value||10) };
  await supabase.from('user_alert_rules').upsert(row,{ onConflict:'user_id,park_id' }); alert('ä¿å­˜ã—ã¾ã—ãŸ');
};

// ===== DPAè³¼å…¥ç®¡ç†ï¼ˆè‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åæ˜ ã¤ãï¼‰ =====
async function loadPurchases(){ const { data:{user} }=await supabase.auth.getUser(); if(!user){ document.getElementById('purchases').innerHTML=''; state.fixedAuto=[]; return; }
  const { data } = await supabase.from('dpa_purchases').select('*').eq('user_id',user.id).eq('park_id',parseInt(parkSel.value,10)).order('slot_start');
  state.purchases=data||[]; // è¡¨ç¤º
  // è‡ªå‹•å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã«åæ˜ 
  state.fixedAuto = (data||[]).map(p => ({ name:p.attraction_name, start:new Date(p.slot_start), dur:Math.max(1, Math.round((new Date(p.slot_end)-new Date(p.slot_start))/60000)), method:'DPA' }));
  renderPurchases(); renderEvents();
  // è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆå½“æ—¥ãŒã‚ã‚Œã°è¡¨ç¤ºï¼‰
  showAutoScheduleLinkForToday();
}
function renderPurchases(){
  const box=document.getElementById('purchases'); box.innerHTML='';
  const tbl=el('table',{},[
    el('thead',{},el('tr',{},[el('th',{},'æ–½è¨­'),el('th',{},'æ™‚é–“å¸¯'),el('th',{},'æšæ•°'),el('th',{},'ãƒ¡ãƒ¢'),el('th',{},'çŠ¶æ…‹'),el('th',{},'æ“ä½œ')])),
    el('tbody',{}, (state.purchases||[]).map(p=>el('tr',{},[
      el('td',{},p.attraction_name),
      el('td',{},`${new Date(p.slot_start).toLocaleTimeString()}ã€œ${new Date(p.slot_end).toLocaleTimeString()}`),
      el('td',{},String(p.quantity)),
      el('td',{},p.note||''),
      el('td',{}, p.used ? 'ä½¿ç”¨æ¸ˆ' : 'æœªä½¿ç”¨'),
      el('td',{}, el('button',{onclick:async()=>{ await supabase.from('dpa_purchases').update({ used: !p.used }).eq('id',p.id); await loadPurchases(); }}, p.used?'æœªä½¿ç”¨ã«æˆ»ã™':'ä½¿ç”¨æ¸ˆã«ã™ã‚‹'))
    ])))
  ]);
  box.appendChild(tbl);
}
document.getElementById('btnAddPurchase').onclick=async()=>{
  const { data:{user} }=await supabase.auth.getUser(); if(!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  const row={ user_id:user.id, park_id:parseInt(parkSel.value,10), attraction_name:buyName.value, slot_start:new Date(buyStart.value).toISOString(), slot_end:new Date(buyEnd.value).toISOString(), quantity:Number(buyQty.value||1), note:buyNote.value||'' };
  if(!row.attraction_name||!row.slot_start||!row.slot_end) return alert('å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
  await supabase.from('dpa_purchases').insert(row);
  // ç”»é¢ä¸Šã®å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚å³æ™‚åæ˜ 
  state.fixedAuto.push({ name: row.attraction_name, start: new Date(buyStart.value), dur: Math.max(1, Math.round((new Date(buyEnd.value)-new Date(buyStart.value))/60000)), method:'DPA' });
  renderEvents();
  // è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸å³åæ˜ 
  await addPurchaseToAutoSchedule(row);
  // å…¥åŠ›ã‚¯ãƒªã‚¢ & å†èª­è¾¼
  buyName.value=''; buyNote.value=''; await loadPurchases();
  alert('ç™»éŒ²ã—ã¾ã—ãŸï¼ˆè‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚è¿½åŠ æ¸ˆã¿ï¼‰');
};

// è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå½“æ—¥åˆ†ï¼‰ã«åæ˜ 
async function addPurchaseToAutoSchedule(purchaseRow){
  const { data:{user} }=await supabase.auth.getUser(); if(!user) return;
  const parkId = purchaseRow.park_id;
  const start = new Date(purchaseRow.slot_start);
  const end = new Date(purchaseRow.slot_end);
  const dateStr = start.toISOString().slice(0,10);
  const schedName = `è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ${dateStr}`;

  // æ—¢å­˜ã®å½“æ—¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾— or ä½œæˆ
  let { data:sch } = await supabase.from('user_schedules').select('id,share_token,name').eq('user_id',user.id).eq('park_id',parkId).eq('name',schedName).maybeSingle();
  if(!sch){
    const ins = await supabase.from('user_schedules').insert({ user_id:user.id, park_id:parkId, name:schedName }).select('id,share_token,name').single();
    if (ins.error) { console.warn(ins.error); return; }
    sch = ins.data;
  }

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼šåŒåãƒ»åŒé–‹å§‹ã®DPAãŒã‚ã‚Œã°æŒ¿å…¥ã‚¹ã‚­ãƒƒãƒ—
  const { data:dup } = await supabase.from('user_schedule_items')
    .select('id').eq('schedule_id',sch.id)
    .eq('attraction_name', purchaseRow.attraction_name)
    .eq('method','DPA')
    .eq('planned_time', start.toISOString())
    .limit(1);
  if (!dup?.length){
    await supabase.from('user_schedule_items').insert({
      schedule_id: sch.id,
      order_no: 9999, // å¾Œã§ä¸¦ã¹æ›¿ãˆã‚‹ã®ã§ä»®
      attraction_name: purchaseRow.attraction_name,
      method: 'DPA',
      planned_time: start.toISOString(),
      duration_min: Math.max(1, Math.round((end-start)/60000)),
      area: 'ã‚¤ãƒ™ãƒ³ãƒˆ'
    });
    // æ™‚åˆ»é †ã« order_no ã‚’å†æ¡ç•ª
    const { data:items } = await supabase.from('user_schedule_items').select('id,planned_time').eq('schedule_id', sch.id).order('planned_time');
    let idx=1; for (const it of (items||[])) { await supabase.from('user_schedule_items').update({ order_no: idx++ }).eq('id', it.id); }
  }

  // å…±æœ‰ãƒªãƒ³ã‚¯è¡¨ç¤º
  const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token);
  autoSchedLink.innerHTML = `ä»Šæ—¥ã®è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼š <a href="${url.toString()}">${url.toString()}</a>`;
}
async function showAutoScheduleLinkForToday(){
  const { data:{user} }=await supabase.auth.getUser(); if(!user){ autoSchedLink.textContent=''; return; }
  const dateStr = new Date().toISOString().slice(0,10);
  const schedName = `è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ${dateStr}`;
  const { data:sch } = await supabase.from('user_schedules').select('id,share_token').eq('user_id',user.id).eq('park_id',parseInt(parkSel.value,10)).eq('name',schedName).maybeSingle();
  if (sch){
    const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token);
    autoSchedLink.innerHTML = `ä»Šæ—¥ã®è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼š <a href="${url.toString()}">${url.toString()}</a>`;
  } else {
    autoSchedLink.textContent = '';
  }
}

// ===== æ‰‹å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå›æ•°æŒ‡å®š & å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆï¼‰ =====
function renderCountsEditor(){
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  countsDiv.innerHTML='';
  if(!favs.length){ countsDiv.textContent='â˜…ã§æ–½è¨­ã‚’é¸ã¶ã¨å›æ•°æŒ‡å®šã§ãã¾ã™ã€‚'; return; }
  const grid = el('div',{class:'grid3'});
  for(const r of favs){
    const area=areaOf(r.nameJa);
    grid.appendChild(el('div',{class:'row'},[
      el('span',{}, r.nameJa +'ï¼ˆ'+area+'ï¼‰'),
      el('input',{type:'number', min:'0', value:'1', id:`count-${r.nameRaw}`, class:'w120'})
    ]));
  }
  countsDiv.appendChild(grid);
}
// å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆ UIï¼ˆæ‰‹å‹•è¿½åŠ ï¼‰
evName.addEventListener('change', async ()=>{
  const hit = state.parades.find(p => p.name === evName.value);
  if (hit && (!evDur.value || Number(evDur.value) === 30)) evDur.value = String(hit.default_duration_min || 30);
});
btnAddEvent.onclick = ()=>{
  if(!evName.value || !evStart.value) return alert('åç§°ã¨é–‹å§‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const start = new Date(evStart.value);
  const dur = Number(evDur.value||30);
  state.fixedManual.push({ name: evName.value, start, dur, method:'Parade' });
  evName.value=''; evStart.value=''; evDur.value='30';
  renderEvents();
};
function renderEvents(){
  const wrap=eventsList; wrap.innerHTML='';
  const sec = (title, arr, deletable) => el('div',{},[
    el('h4',{},title),
    !arr.length ? el('div',{class:'mut'},'ãªã—') :
    el('table',{},[
      el('thead',{}, el('tr',{},[el('th',{},'ç¨®åˆ¥'),el('th',{},'åç§°'),el('th',{},'é–‹å§‹'),el('th',{},'æ‰€è¦'),el('th',{},'æ“ä½œ')])),
      el('tbody',{}, arr.slice().sort((a,b)=>a.start-b.start).map((e,i)=> el('tr',{},[
        el('td',{}, e.method),
        el('td',{}, e.name),
        el('td',{}, e.start.toLocaleString()),
        el('td',{}, `${e.dur}åˆ†`),
        el('td',{}, deletable ? el('button',{onclick:()=>{ arr.splice(i,1); renderEvents(); }},'å‰Šé™¤') : el('span',{class:'mut'},'â€”'))
      ])))
    ])
  ]);
  wrap.appendChild(sec('DPAè³¼å…¥ï¼ˆè‡ªå‹•åæ˜ ï¼‰', state.fixedAuto, false));
  wrap.appendChild(sec('å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ‰‹å‹•ï¼‰', state.fixedManual, true));
}

// ç°¡æ˜“ã‚¨ãƒªã‚¢æœ€é©åŒ–
function optimizeByArea(list){
  const out=[]; let curArea=null; const pool=list.slice(0);
  while(pool.length){
    const i = pool.findIndex(x=> areaOf(x.nameJa)===curArea);
    const pick = i>=0 ? pool.splice(i,1)[0] : pool.shift();
    out.push(pick); curArea = areaOf(pick.nameJa);
  }
  return out;
}

document.getElementById('btnPlan').onclick=async()=>{
  const { data:{user} }=await supabase.auth.getUser(); if(!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  const start = document.getElementById('startTime').value || '09:00';
  const walk = Number(document.getElementById('walk').value||10);
  const today = new Date().toISOString().slice(0,10);

  // â˜…ã‹ã‚‰å›æ•°å±•é–‹
  const favs = state.qt.filter(x=>state.favorites.has(x.nameRaw));
  let tasks=[];
  for(const r of favs){
    const n = Number(document.getElementById(`count-${r.nameRaw}`)?.value||0);
    for(let i=0;i<n;i++) tasks.push(r);
  }

  // å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆ = è‡ªå‹•(DPA) + æ‰‹å‹•(Parade)
  const fixed = [...state.fixedAuto, ...state.fixedManual]
    .map(e => ({ ...e, end: new Date(e.start.getTime() + e.dur*60000) }))
    .sort((a,b)=> a.start - b.start);

  if(!tasks.length && !fixed.length) return alert('å›æ•°æŒ‡å®šã‚„å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');

  // DPAå¯¾è±¡ã‚’å„ªå…ˆï¼ˆç°¡æ˜“ï¼‰
  const dpaTargets = new Set(tasks.slice().sort((a,b)=>(b.wait||0)-(a.wait||0)).slice(0, Math.ceil(tasks.length/2)).map(x=>x.nameRaw));

  // å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã‚’é¿ã‘ãªãŒã‚‰é…ç½®
  let cursor = new Date(`${today}T${start}:00`);
  const steps = [];
  function bumpPastFixed(cur, durMin){
    let cur2 = new Date(cur);
    while(true){
      const hit = fixed.find(f => cur2 < f.end && new Date(cur2.getTime()+durMin*60000) > f.start);
      if(!hit) return cur2;
      cur2 = new Date(hit.end.getTime() + walk*60000);
    }
  }
  // ã¾ãšãƒ©ã‚¤ãƒ‰ã‚’ä¸¦ã¹ã‚‹ï¼ˆã‚¨ãƒªã‚¢æœ€é©åŒ–ï¼‰
  tasks = optimizeByArea(tasks);
  for(const t of tasks){
    const useDpa = dpaTargets.has(t.nameRaw);
    const dur = useDpa ? 20 : (t.wait||20);
    cursor = bumpPastFixed(cursor, dur);
    steps.push({ name:t.nameJa, raw:t.nameRaw, method: useDpa?'DPA':'Standby', at:new Date(cursor), dur, area: areaOf(t.nameJa) });
    cursor = new Date(cursor.getTime() + (dur+walk)*60000);
  }
  // å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã‚’çµ±åˆï¼ˆãã®ã¾ã¾ï¼‰
  const fixSteps = fixed.map(f => ({ name:f.name, raw:f.name, method:f.method, at:new Date(f.start), dur:f.dur, area:'ã‚¤ãƒ™ãƒ³ãƒˆ' }));
  const allSteps = [...steps, ...fixSteps].sort((a,b)=> a.at - b.at);

  // è¡¨ç¤º
  planOut.textContent = allSteps.map(s=> `${s.at.toTimeString().slice(0,5)} ${s.method} â†’ ${s.name}ï¼ˆ${s.dur}åˆ†ï¼‰ [${s.area}]`).join('\n');

  // ä¿å­˜ + å…±æœ‰ãƒªãƒ³ã‚¯
  const sched = { user_id:user.id, park_id:parseInt(parkSel.value,10), name:`æ‰‹å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ${new Date().toLocaleTimeString()}` };
  const { data:sch, error:e1 } = await supabase.from('user_schedules').insert(sched).select('id,share_token').single();
  if(e1) return alert(e1.message);
  const items = allSteps.map((s,i)=>({ schedule_id:sch.id, order_no:i+1, attraction_name:s.raw, method:s.method, planned_time:s.at.toISOString(), duration_min:s.dur, area:s.area }));
  const { error:e2 } = await supabase.from('user_schedule_items').insert(items);
  if(e2) return alert(e2.message);
  const url = new URL(location.href); url.searchParams.set('schedule', sch.share_token);
  shareLink.innerHTML = `å…±æœ‰ãƒªãƒ³ã‚¯ï¼š <a href="${url.toString()}">${url.toString()}</a>`;
};

// ===== ãƒ‘ãƒ¬ãƒ¼ãƒ‰å€™è£œï¼ˆãƒã‚¹ã‚¿ï¼‰ =====
async function loadParades(){
  const parkId = parseInt(parkSel.value,10);
  const { data, error } = await supabase.from('parades').select('*').eq('park_id', parkId).order('name');
  state.parades = data||[];
  const dl = document.getElementById('paradeNames'); dl.innerHTML = '';
  for(const p of state.parades) dl.appendChild(el('option',{ value:p.name }));
}

// ===== å…±æœ‰ãƒªãƒ³ã‚¯ã§é–²è¦§ =====
async function loadShared(){
  const sp = new URLSearchParams(location.search); const token = sp.get('schedule'); if(!token) return;
  const { data:sch } = await supabase.from('user_schedules').select('id,name').eq('share_token', token).single();
  if(!sch) return;
  const { data:items } = await supabase.from('user_schedule_items').select('*').eq('schedule_id', sch.id).order('order_no');
  planOut.textContent = `ğŸ“ å…±æœ‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: ${sch.name}\n` + items.map(s=> `${new Date(s.planned_time).toTimeString().slice(0,5)} ${s.method} â†’ ${s.attraction_name}ï¼ˆ${s.duration_min}åˆ†ï¼‰ [${s.area||''}]`).join('\n');
}

// ===== é€šçŸ¥ãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆæœ€æ–°20ä»¶ + Realtimeï¼‰ =====
async function loadFeed(){ const { data } = await supabase.from('notifications').select('*').order('created_at',{ascending:false}).limit(20); renderFeed(data||[]); }
function renderFeed(items){ feedDiv.innerHTML=''; for(const n of items){ feedDiv.prepend(el('div',{class:'row'}, `[${new Date(n.created_at).toLocaleTimeString()}] ${n.title} - ${n.body}` )); } }
supabase.channel('feed').on('postgres_changes',{event:'INSERT',schema:'public',table:'notifications'},p=>{ feedDiv.prepend(el('div',{class:'row'}, `[${new Date(p.new.created_at).toLocaleTimeString()}] ${p.new.title} - ${p.new.body}` ));}).subscribe();

// ===== Pushè³¼èª­ =====
const btnNotify=document.getElementById('btnNotify');

async function urlB64ToUint8Array(b){const p='='.repeat((4-b.length%4)%4);const base=(b+p).replace(/-/g,'+').replace(/_/g,'/');const raw=atob(base);const u=new Uint8Array(raw.length);for(let i=0;i<raw.length;i++)u[i]=raw.charCodeAt(i);return u;}

btnNotify.onclick=async()=>{
  if (!ENV.VAPID_PUBLIC_KEY) return alert('VAPID_PUBLIC_KEYæœªè¨­å®š');

  // iOS ã¯ PWA(ãƒ›ãƒ¼ãƒ ç”»é¢)å¿…é ˆ
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isIOS && !isStandalone) {
    alert('iPhoneã§ã¯ã€ã¾ãšã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼ˆãã®å¾Œã“ã®ãƒœã‚¿ãƒ³ã§é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–ã§ãã¾ã™ï¼‰ã€‚');
    return;
  }

  // æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ï¼‰
  const perm = await Notification.requestPermission();
  if (perm !== 'granted'){ alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'); return; }

  const reg = await navigator.serviceWorker.register('/sw.js');
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: await urlB64ToUint8Array(ENV.VAPID_PUBLIC_KEY)
  });

  const { data:{user} }=await supabase.auth.getUser();
  if(!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');

  const resp=await fetch('/.netlify/functions/push-subscribe',{
    method:'POST',
    headers:{'Content-Type':'application/json','x-user-id':user.id},
    body: JSON.stringify(sub.toJSON())
  });
  alert(resp.ok?'é€šçŸ¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸ':'é€šçŸ¥ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
};

// ===== ãƒœã‚¿ãƒ³é…ç·š =====
document.getElementById('btnRefresh').onclick = async () => {
  await loadQT(true);   // ä¸­ã§ renderNowTips() ã¾ã§å®Ÿè¡Œã•ã‚Œã‚‹
};
document.getElementById('btnFetchDpa').onclick=async()=>{ await fetch('/.netlify/functions/ingest-tdr-dpa-background',{method:'POST'}).catch(()=>{}); await new Promise(r=>setTimeout(r,15000)); await loadDPA(); };
parkSel.onchange = async () => {
  await loadRules(); await loadFavs(); await loadQT(); await loadDPA(); await loadPurchases();
  await loadParades(); renderEvents(); await renderNowTips();
};

// ===== åˆæœŸåŒ– =====
await loadShared(); await loadRules(); await loadFavs(); await loadQT(); await loadDPA(); await loadPurchases(); await loadParades(); renderEvents(); await renderNowTips(); await loadFeed();
</script>
</body>
</html>
