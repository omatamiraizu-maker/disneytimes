<!DOCTYPE html>
<html lang="ja" data-theme="auto" data-density="comfort" data-contrast="normal">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TDR ÂæÖ„Å°ÊôÇÈñì„ÉªDPAÈÄöÁü• </title>
  <!-- iOS PWA ÊúÄÈÅ©Âåñ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TDR Now" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="theme-color" content="#0ea5e9" />

  <style>
    /* =========================
       THEME (Light / Dark / High-Contrast)
    ========================== */
    :root {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --line: #e5e7eb;
      --accent: #0ea5e9;
      --accent-2: #6366f1;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --card-shadow: 0 8px 24px rgba(2,8,23,.06);
      --radius: 16px;
      --tap: 48px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    @media (prefers-color-scheme: dark) {
      html[data-theme="auto"] {
        --bg: #0b1220;
        --panel: #0f172a;
        --text: #e5e7eb;
        --muted: #93a0b0;
        --line: #1f2937;
        --accent: #38bdf8;
        --accent-2: #8b5cf6;
        --card-shadow: 0 10px 30px rgba(2,8,23,.4);
      }
    }
    html[data-theme="dark"] {
      --bg: #0b1220;
      --panel: #0f172a;
      --text: #e5e7eb;
      --muted: #93a0b0;
      --line: #1f2937;
      --accent: #38bdf8;
      --accent-2: #8b5cf6;
      --card-shadow: 0 10px 30px rgba(2,8,23,.4);
    }
    html[data-theme="light"] {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --line: #e5e7eb;
      --accent: #0ea5e9;
      --accent-2: #6366f1;
    }
    html[data-contrast="high"] {
      --text: #000; --muted:#1f2937; --line:#0ea5e9; --accent:#0ea5e9; --accent-2:#0ea5e9;
      filter: contrast(1.05) saturate(1.05);
      text-shadow: 0 0 0 rgba(0,0,0,0.01);
    }

    html[data-density="compact"] .panel { padding: 10px; }
    html[data-density="compact"] .btn, html[data-density="compact"] .pill, html[data-density="compact"] .cta { padding: 8px 10px; }
    html[data-density="compact"] main { padding-bottom: calc(76px + var(--safe-bottom)); }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "„Éí„É©„ÇÆ„ÉéËßí„Ç¥ ProN W3", Meiryo, Roboto, Noto Sans JP, Segoe UI, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-variant-numeric: tabular-nums;
    }
    a { color: inherit; text-decoration: none; }
    .mut { color: var(--muted); }
    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; border: 0; clip: rect(0 0 0 0); overflow: hidden; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius: 999px; background: color-mix(in srgb, var(--accent) 12%, transparent); border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent); font-size: 12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 8px; font-size: 12px; border:1px solid var(--line); background: color-mix(in srgb, var(--panel) 70%, var(--bg)); }

    header.sticky { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(180%) blur(8px); background: color-mix(in srgb, var(--panel) 85%, transparent); border-bottom: 1px solid var(--line); padding: max(8px, calc(8px + var(--safe-top))) 12px 8px 12px; }
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title { font-weight: 800; letter-spacing: 0.2px; }
    .subtitle { font-size: 12px; }

    main { padding: 16px; padding-bottom: calc(88px + var(--safe-bottom)); max-width: 1200px; margin: 0 auto; }

    .grid { display:grid; gap: 12px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 720px) { .grid.cols-3 { grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .panel { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--card-shadow); padding: 12px; }
    .panel h2, .panel h3 { margin: 6px 0 8px 0; }

    .row { display:flex; align-items:center; gap: 8px; }
    .row.wrap { flex-wrap: wrap; }
    .space { flex: 1; }

    .btn, button, .pill, .cta { appearance: none; border: 1px solid var(--line); border-radius: 12px; background: var(--panel); color: var(--text); padding: 10px 14px; font-weight: 600; cursor: pointer; min-height: var(--tap); }
    .btn[aria-pressed="true"], .btn.active { outline: 2px solid color-mix(in srgb, var(--accent) 50%, transparent); }
    .cta { background: var(--accent); border-color: color-mix(in srgb, var(--accent) 40%, transparent); color: #fff; }
    .ghost { background: transparent; }

    .seg { display:inline-flex; border:1px solid var(--line); border-radius: 999px; padding:4px; gap:4px; }
    .seg button { border-radius:999px; border:0; background:transparent; padding:8px 12px; font-weight:700; }
    .seg button.active { background: color-mix(in srgb, var(--accent) 18%, transparent); }

    .search { display:flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background: color-mix(in srgb, var(--panel) 70%, var(--bg)); }
    .search input { flex:1; border:0; background:transparent; color: inherit; outline:none; font-size:16px; }

    .card { border:1px solid var(--line); border-radius: 14px; padding: 10px; background: color-mix(in srgb, var(--panel) 92%, var(--bg)); position:relative; }
    .card.changed { animation: glow 1.4s ease-out 1; }
    @keyframes glow { 0% { box-shadow: 0 0 0 0 rgba(14,165,233,.6);} 100% { box-shadow: 0 0 0 12px rgba(14,165,233,0);} }
    .delta { font-family: var(--mono); font-size:12px; padding:2px 6px; border-radius:999px; border:1px solid var(--line); }
    .up { color: var(--good); border-color: color-mix(in srgb, var(--good) 50%, transparent); }
    .down { color: var(--bad); border-color: color-mix(in srgb, var(--bad) 50%, transparent); }

    .list { display:grid; gap:8px; }

    nav.bottom { position: fixed; left:0; right:0; bottom:0; z-index: 60; padding: 6px 8px calc(8px + var(--safe-bottom)); background: color-mix(in srgb, var(--panel) 95%, transparent); border-top: 1px solid var(--line); display:grid; grid-template-columns: repeat(5,1fr); gap: 8px; }
    .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; border-radius: 12px; padding: 8px 4px; }
    .nav-item.active { outline: 2px solid color-mix(in srgb, var(--accent) 45%, transparent); }

    #pullRefresh { position: sticky; top: 0; z-index: 40; display:flex; align-items:center; justify-content:center; height: 40px; transform: translateY(-40px); transition: transform .2s ease; }
    #pullRefresh.show { transform: translateY(0); }

    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--line); padding: 10px; text-align:left; }

    :focus-visible { outline: 3px solid color-mix(in srgb, var(--accent) 60%, transparent); outline-offset:3px; border-radius: 8px; }

    /* ==== Â±•Ê≠¥„Ç∑„Éº„Éà ==== */
    #historySheet { position: fixed; inset: 0; background: rgba(0,0,0,.4); display:none; align-items:flex-end; z-index: 80; }
    #historyPanel { background: var(--panel); border-top-left-radius: 16px; border-top-right-radius: 16px; max-height: 80dvh; overflow:auto; padding: 12px; border-top: 1px solid var(--line); box-shadow: 0 -10px 30px rgba(0,0,0,.25); width: 100%; }
  </style>
</head>
<body>
  <header class="sticky" role="banner">
    <div class="header-row">
      <div>
        <div class="title">TDR ÂæÖ„Å°ÊôÇÈñì„ÉªDPAÈÄöÁü• <span class="badge" id="appVer">v2.2</span></div>
        <div class="subtitle mut">ÂÄã‰∫∫ÊúÄÂº∑Áâà / Netlify + Supabase / iOS PWA</div>
      </div>
      <div class="row wrap">
        <button id="btnInstall" class="btn ghost" aria-label="„Éõ„Éº„É†ÁîªÈù¢„Å∏ËøΩÂä†">üì≤ „Ç§„É≥„Çπ„Éà„Éº„É´</button>
        <div class="seg" role="tablist" aria-label="„ÉÜ„Éº„ÉûÂàáÊõø">
          <button id="themeLight" class="" aria-pressed="false">‚òÄÔ∏è Êòé</button>
          <button id="themeAuto" class="active" aria-pressed="true">üåì Ëá™</button>
          <button id="themeDark" class="" aria-pressed="false">üåô Êöó</button>
        </div>
        <div class="seg" role="tablist" aria-label="ÂØÜÂ∫¶">
          <button id="densComfort" class="active" aria-pressed="true">„ÇÜ„Å£„Åü„Çä</button>
          <button id="densCompact" class="" aria-pressed="false">Ë©∞„ÇÅ„Çã</button>
        </div>
        <div class="seg" role="tablist" aria-label="„Ç≥„É≥„Éà„É©„Çπ„Éà">
          <button id="contrastNorm" class="active" aria-pressed="true">Ê®ôÊ∫ñ</button>
          <button id="contrastHigh" class="" aria-pressed="false">È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà</button>
        </div>
        <div class="seg" role="tablist" aria-label="Ëá™ÂãïÊõ¥Êñ∞">
          <button id="autoOff" class="active" aria-pressed="true" data-sec="0">ÊâãÂãï</button>
          <button id="auto15" class="" aria-pressed="false" data-sec="15">15s</button>
          <button id="auto30" class="" aria-pressed="false" data-sec="30">30s</button>
          <button id="auto60" class="" aria-pressed="false" data-sec="60">60s</button>
        </div>
        <button id="btnShare" class="btn ghost" title="ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂÖ±Êúâ">üîó ÂÖ±Êúâ</button>
      </div>
    </div>
  </header>

  <div id="pullRefresh" aria-hidden="true"><span class="badge">‰∏ã„Å´Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞</span></div>
  <div id="crowdIndicator" class="sr-only"></div>

  <main id="main" role="main">
    <section class="panel" id="summary">
      <div class="row wrap">
        <div class="chip"><b>üéõ Ê∑∑Èõë</b> <span id="crowdLevel">‚Äî</span></div>
        <div class="chip"><b>‚è± Âπ≥Âùá</b> <span id="avgWait">‚Äî</span></div>
        <div class="chip"><b>üé´ DPA</b> <span id="dpaCount">‚Äî</span></div>
        <div class="chip"><b>ü™™ PP</b> <span id="ppCount">‚Äî</span></div>
        <div class="chip"><b>üóì ÊúÄÁµÇ</b> <span id="lastUpdated">‚Äî</span></div>
        <div class="chip"><b>‚è≥ Ê¨°</b> <span id="autoCountdown">‚Äî</span></div>
        <div class="space"></div>
        <button id="btnRefresh" class="cta">üîÑ ÊúÄÊñ∞„Å´Êõ¥Êñ∞</button>
      </div>
    </section>

    <section class="panel" id="controls">
      <div class="row wrap">
        <div class="seg" role="tablist" aria-label="„Éë„Éº„ÇØÈÅ∏Êäû">
          <button id="parkTDL" class="active" data-park="274" aria-pressed="true">üè∞ TDL</button>
          <button id="parkTDS" data-park="275" aria-pressed="false">üåã TDS</button>
        </div>
        <div class="space"></div>
        <div class="search" aria-label="Ê§úÁ¥¢">
          <span>üîé</span>
          <input id="searchInput" type="search" placeholder="„Ç¢„Éà„É©„ÇØÂêç„ÅßÊ§úÁ¥¢" autocomplete="off" />
        </div>
      </div>
      <div class="row wrap" style="margin-top:8px">
        <button class="btn" id="fltFast">‚â§20ÂàÜ</button>
        <button class="btn" id="fltDPA">DPAË≤©Â£≤‰∏≠</button>
        <button class="btn" id="fltPP">PPÁô∫Ë°å‰∏≠</button>
        <button class="btn" id="fltDown">ÈÅãÂñ∂ÂÅúÊ≠¢</button>
        <button class="btn" id="fltFavs">‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
        <div class="space"></div>
        <button class="btn ghost" id="btnClear">„Éï„Ç£„É´„ÇøËß£Èô§</button>
      </div>
    </section>

    <section class="panel" id="insight">
      <h3 style="margin:0">üí° „Ç§„É≥„Çµ„Ç§„Éà</h3>
      <div id="insightList" class="list" style="margin-top:6px"></div>
    </section>

    <section class="panel" id="favsQuick" style="display:none">
      <h3>‚≠ê „Çà„ÅèË¶ã„ÇãÊñΩË®≠</h3>
      <div id="favChips" class="row wrap"></div>
    </section>

    <span id="qtAnchor"></span>

    <section class="panel" id="qt">
      <div class="row" style="justify-content:space-between"><h2 style="margin:0">‚è± ÂæÖ„Å°ÊôÇÈñì</h2><div class="row"><button id="viewCards" class="btn active">„Ç´„Éº„Éâ</button><button id="viewTable" class="btn">„ÉÜ„Éº„Éñ„É´</button></div></div>
      <div id="qtCards" class="list" style="margin-top:8px"></div>
      <div id="qtTableWrap" style="display:none; margin-top:8px">
        <table id="qtTable"><thead><tr><th>ÊñΩË®≠</th><th>ÂæÖ„Å°</th><th>Œî</th><th>Áä∂ÊÖã</th><th>„Çø„Ç∞</th><th>Êìç‰Ωú</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <span id="dpaAnchor"></span>

    <section class="panel" id="dpa">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">üé´ DPA / PP</h2>
        <div class="row">
          <button id="btnHistoryAll" class="btn">Ë≤©Â£≤Â±•Ê≠¥</button>
          <button id="btnCopyOn" class="btn ghost" title="Ë≤©Â£≤/Áô∫Ë°å‰∏≠‰∏ÄË¶ß„Çí„Ç≥„Éî„Éº">üìã ÁèæÂú® ON „Çí„Ç≥„Éî„Éº</button>
          <button id="btnFetchDpa" class="btn">ÂÜçÂèñÂæó</button>
        </div>
      </div>
      <div id="dpaList" class="list" style="margin-top:8px"></div>
    </section>

    <section class="panel" id="timeline">
      <h3 style="margin-top:0">üïí „Çø„Ç§„É†„É©„Ç§„É≥ÔºàÁõ¥Ëøë„ÅÆÂ§âÂåñÔºâ</h3>
      <div id="tlList" class="list"></div>
    </section>

    <span id="favsAnchor"></span>

    <section class="panel" id="favs">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä</h2>
        <div class="row">
          <button id="btnFavExport" class="btn">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
          <button id="btnFavImport" class="btn ghost">„Ç§„É≥„Éù„Éº„Éà</button>
        </div>
      </div>
      <div id="favList" class="list" style="margin-top:8px"></div>
    </section>

    <span id="scheduleAnchor"></span>

    <section class="panel" id="schedule">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">üìÖ ‰∫àÂÆö</h2>
        <div class="row">
          <input id="schInput" class="btn" placeholder="‰æã: 12:30 „Éô„Ç§„Éû„ÉÉ„ÇØ„Çπ" style="min-width:220px" />
          <button id="schAdd" class="btn">ËøΩÂä†</button>
          <button id="schClear" class="btn ghost">ÂÖ®Ê∂àÂéª</button>
        </div>
      </div>
      <div id="schList" class="list" style="margin-top:8px"></div>
      <div class="mut" style="margin-top:6px">„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÂ∫èÂ§âÊõ¥„Åß„Åç„Åæ„Åô</div>
    </section>

    <section class="panel" id="notifPanel">
      <h3 style="margin-top:0">üîî ÈÄöÁü•</h3>
      <div class="row wrap" style="align-items:center">
        <button id="btnTestNotify" class="btn">„ÉÜ„Çπ„ÉàÈÄöÁü•</button>
        <button id="btnFetchNotifs" class="btn">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø</button>
        <span class="mut" id="quietHoursHint">‚Äî</span>
      </div>
      <div id="notifList" class="list" style="margin-top:8px"></div>
    </section>

  </main>

  <!-- Â±•Ê≠¥„Ç∑„Éº„Éà -->
  <div id="historySheet" role="dialog" aria-modal="true">
    <div id="historyPanel">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">üìú Ë≤©Â£≤Â±•Ê≠¥ <small class="mut" id="histScope">ÔºàÂÖ®‰ΩìÔºâ</small></h3>
        <div class="row">
          <button id="histFavsOnly" class="btn ghost" aria-pressed="false">‚òÖ„ÅÆ„Åø</button>
          <button id="btnHistoryClose" class="btn">Èñâ„Åò„Çã</button>
        </div>
      </div>
      <div id="histList" class="list" style="margin-top:8px"></div>
    </div>
  </div>

  <nav class="bottom" role="navigation" aria-label="„É°„Ç§„É≥„Éä„Éì">
    <button class="nav-item active" data-target="qt"><div>‚è±</div><small>ÂæÖ„Å°ÊôÇÈñì</small></button>
    <button class="nav-item" data-target="dpa"><div>üé´</div><small>DPA/PP</small></button>
    <button class="nav-item" data-target="insight"><div>üí°</div><small>„Ç§„É≥„Çµ„Ç§„Éà</small></button>
    <button class="nav-item" data-target="favs"><div>‚≠ê</div><small>„ÅäÊ∞ó„Å´ÂÖ•„Çä</small></button>
    <button class="nav-item" data-target="schedule"><div>üìÖ</div><small>‰∫àÂÆö</small></button>
  </nav>

  <script>
  (function(){
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent);
    let autoTimer = null, autoRemain = 0;
    let prevQueuesByName = {}; let prevDpaByName = {};

    let state = {
      park: 274,
      queues: [],
      dpa: [],
      favs: new Set(JSON.parse(localStorage.getItem('favs')||'[]')),
      schedule: JSON.parse(localStorage.getItem('schedule')||'[]'),
      filters: { fast:false, dpa:false, pp:false, down:false, favs:false, q:'' },
      view: 'cards',
      theme: localStorage.getItem('theme') || 'auto',
      density: localStorage.getItem('density') || 'comfort',
      contrast: localStorage.getItem('contrast') || 'normal',
      autoSec: +(localStorage.getItem('autoSec')||0),
      lastFetchAt: null
    };

    initTheme(); initDensity(); initContrast();
    function initTheme(){ setTheme(state.theme); ['Light','Auto','Dark'].forEach(k=>$('#theme'+k)?.addEventListener('click',()=>setTheme(k.toLowerCase()))); }
    function setTheme(mode){ document.documentElement.setAttribute('data-theme', mode); localStorage.setItem('theme', mode); state.theme = mode; ['Light','Auto','Dark'].forEach(k=>$('#theme'+k)?.classList.remove('active')); $('#theme'+(mode.charAt(0).toUpperCase()+mode.slice(1)))?.classList.add('active'); ['Light','Auto','Dark'].forEach(k=>$('#theme'+k)?.setAttribute('aria-pressed','false')); $('#theme'+(mode.charAt(0).toUpperCase()+mode.slice(1)))?.setAttribute('aria-pressed','true'); }
    function initDensity(){ setDensity(state.density); $('#densComfort')?.addEventListener('click',()=>setDensity('comfort')); $('#densCompact')?.addEventListener('click',()=>setDensity('compact')); }
    function setDensity(v){ document.documentElement.setAttribute('data-density', v); localStorage.setItem('density', v); state.density=v; $('#densComfort').classList.toggle('active', v==='comfort'); $('#densCompact').classList.toggle('active', v==='compact'); $('#densComfort').setAttribute('aria-pressed', v==='comfort'); $('#densCompact').setAttribute('aria-pressed', v==='compact'); }
    function initContrast(){ setContrast(state.contrast); $('#contrastNorm')?.addEventListener('click',()=>setContrast('normal')); $('#contrastHigh')?.addEventListener('click',()=>setContrast('high')); }
    function setContrast(v){ document.documentElement.setAttribute('data-contrast', v); localStorage.setItem('contrast', v); state.contrast=v; $('#contrastNorm').classList.toggle('active', v==='normal'); $('#contrastHigh').classList.toggle('active', v==='high'); $('#contrastNorm').setAttribute('aria-pressed', v==='normal'); $('#contrastHigh').setAttribute('aria-pressed', v==='high'); }

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; $('#btnInstall')?.classList.add('cta'); });
    $('#btnInstall')?.addEventListener('click', async ()=>{ if (window.navigator.standalone === true) return alert('„Éõ„Éº„É†ÁîªÈù¢„Åã„ÇâËµ∑ÂãïÊ∏à„Åø„Åß„Åô'); if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; return; } alert('Safari„ÅÆÂÖ±Êúâ„Éú„Çø„É≥„Åã„Çâ„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ'); });

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js').catch(()=>{}); }

    async function ensureEnv(){ if (window.ENV && ENV.SUPABASE_URL) return; try { const res = await fetch('/.netlify/functions/env'); const txt = await res.text(); eval(txt); } catch (e) {} }

    async function fetchQueues(){
      const url = `/.netlify/functions/qt?type=queues&park=${state.park}`;
      try {
        const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const list = (Array.isArray(data)?data:[]).map(x=>({
          name: x.name || x.title || x.canonical_name || '‚Äî',
          wait: x.wait ?? x.queue ?? x.minutes ?? null,
          status: x.status || x.status_operational || x.state || 'Ë®òËºâ„Å™„Åó',
          labels: x.labels || [],
          href: x.url || x.href || '#',
        }));
        state.queues = withDelta(list, prevQueuesByName, (a)=>a.wait);
        prevQueuesByName = indexByName(list);
      } catch (e) { console.warn('fetchQueues fail', e); state.queues = []; }
    }

    async function fetchDpa(){
      const url = `/.netlify/functions/qt?type=dpa&park=${state.park}`;
      try {
        const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const list = (Array.isArray(data)?data:[]).map(x=>({
          name: x.name || x.title || x.canonical_name || '‚Äî',
          dpa: x.dpa_status || x.dpa || x.dpa_flag || 'Ë®òËºâ„Å™„Åó',
          pp: x.pp40_status || x.pp || x.pp_flag || 'Ë®òËºâ„Å™„Åó',
          href: x.url || x.href || '#',
          labels: x.labels || [],
        }));
        state.dpa = withDelta(list, prevDpaByName, (a)=>`${a.dpa}|${a.pp}`);
        prevDpaByName = indexByName(list);
      } catch (e) { console.warn('fetchDpa fail', e); state.dpa = []; }
    }

    // ====== Supabase Â±•Ê≠¥ÔºàË≤©Â£≤Â±•Ê≠¥Ôºâ ======
    async function fetchHistory(filterName){
      try {
        await ensureEnv();
        const limit = 600; // ËªΩÈáè
        let url = `${ENV.SUPABASE_URL}/rest/v1/attraction_status?select=name_raw,dpa_status,pp40_status,fetched_at,park_id&id=gt.0&park_id=eq.${state.park}&order=fetched_at.desc&limit=${limit}`;
        if (filterName) url += `&name_raw=eq.${encodeURIComponent(filterName)}`;
        const r = await fetch(url, { headers: { 'apikey': ENV.SUPABASE_ANON_KEY, 'Authorization': `Bearer ${ENV.SUPABASE_ANON_KEY}` }});
        if (!r.ok) throw new Error('history http '+r.status);
        const rows = await r.json();
        return buildHistory(rows, filterName);
      } catch(e){ console.warn('history fail', e); return { scope: filterName? `Ôºà${filterName}Ôºâ` : 'ÔºàÂÖ®‰ΩìÔºâ', items:[{text:'Â±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', t:new Date()}] }; }
    }
    function buildHistory(rows, filterName){
      const by = new Map();
      for (const x of rows){ const key = x.name_raw || '‚Äî'; if (!by.has(key)) by.set(key, []); by.get(key).push(x); }
      const out = [];
      for (const [name, arr] of by){
        // fetched_at ÈôçÈ†Ü„ÅßÊù•„Å¶„ÅÑ„ÇãÂâçÊèê„ÄÅÁõ¥Ââç„ÅÆÁä∂ÊÖã„Å®ÊØîËºÉ
        let prev = null; for (const r of arr){ const cur = `${r.dpa_status||'Ë®òËºâ„Å™„Åó'}|${r.pp40_status||'Ë®òËºâ„Å™„Åó'}`; if (prev && prev!==cur){ out.push({ name, t:new Date(r.fetched_at||Date.now()), dpa:r.dpa_status||'Ë®òËºâ„Å™„Åó', pp:r.pp40_status||'Ë®òËºâ„Å™„Åó' }); } prev = cur; }
      }
      // Êñ∞„Åó„ÅÑÈ†Ü„Åß‰∏ä‰Ωç„ÇíË°®Á§∫ÔºàÊúÄÂ§ß120‰ª∂Ôºâ
      out.sort((a,b)=>b.t - a.t);
      const scope = filterName? `Ôºà${filterName}Ôºâ` : 'ÔºàÂÖ®‰ΩìÔºâ';
      return { scope, items: out.slice(0,120) };
    }

    // ====== Renderers ======
    function renderSummary(){
      const items = applyFilters(state.queues);
      const waits = items.map(i=>Number(i.wait)).filter(Number.isFinite);
      const avg = waits.length ? Math.round(waits.reduce((a,b)=>a+b,0)/waits.length) : '‚Äî';
      $('#avgWait').textContent = typeof avg==='number'? `${avg}ÂàÜ` : '‚Äî';
      let level = '‚Äî'; if (typeof avg==='number') level = avg<=15?'‰Ωé':avg<=40?'‰∏≠':'È´ò';
      $('#crowdLevel').textContent = level; $('#crowdIndicator').textContent = level;
      const dpaOn = state.dpa.filter(d=>/Ë≤©Â£≤‰∏≠|Áô∫Ë°å‰∏≠|available|on/i.test(`${d.dpa}`)).length;
      const ppOn  = state.dpa.filter(d=>/Áô∫Ë°å‰∏≠|available|on/i.test(`${d.pp}`)).length;
      $('#dpaCount').textContent = dpaOn; $('#ppCount').textContent = ppOn;
      if (state.lastFetchAt) $('#lastUpdated').textContent = new Date(state.lastFetchAt).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
    }

    function renderInsights(){
      const box = $('#insightList'); box.innerHTML='';
      const list = [];
      const downs = state.queues.filter(q=>Number(q.delta)<0).sort((a,b)=>a.delta-b.delta).slice(0,3);
      for (const q of downs){ list.push(`üîª <b>${escapeHtml(q.name)}</b> „Åå <b>${Math.abs(q.delta)}ÂàÜÁü≠Á∏Æ</b> ‚Üí ‰ªä ${q.wait??'‚Äî'}ÂàÜ`); }
      const dpaOn = state.dpa.filter(d=>d.delta && /Ë≤©Â£≤‰∏≠|available|on/i.test(`${d.dpa}`));
      for (const d of dpaOn){ list.push(`üü¢ <b>${escapeHtml(d.name)}</b> „Åå <b>DPA Ë≤©Â£≤‰∏≠</b> „Å´Â§âÂåñ`); }
      const favOn = state.dpa.filter(d=>state.favs.has(d.name) && /Ë≤©Â£≤‰∏≠|Áô∫Ë°å‰∏≠|available|on/i.test(`${d.dpa}|${d.pp}`));
      for (const f of favOn){ list.push(`‚≠ê <b>${escapeHtml(f.name)}</b> ‚Äì DPA/PP „ÉÅ„É£„É≥„Çπ`); }
      box.innerHTML = list.length? list.map(t=>`<div class="row" style="border-bottom:1px solid var(--line); padding:6px 0">${t}</div>`).join('') : '<div class="mut">Áõ¥Ëøë„ÅÆÊ≥®ÁõÆÂ§âÂåñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    }

    function renderQueues(){
      const list = applyFilters(state.queues);
      const cards = $('#qtCards'); const tbody = $('#qtTable tbody'); cards.innerHTML=''; tbody.innerHTML='';
      for (const a of list){
        const waitTxt = a.wait==null? '‚Äî' : `${a.wait}ÂàÜ`;
        const status = (a.status||'').toString();
        const tagTxt = (a.labels||[]).join(' / ');
        const delta = Number.isFinite(a.delta)? a.delta: null;
        const deltaHtml = delta==null? '<span class="mut">‚Äî</span>' : `<span class="delta ${delta>0?'up':'down'}">${delta>0? 'Ôºã'+delta: delta}</span>`;
        const c = document.createElement('div'); c.className='card'; if (a.changed) c.classList.add('changed');
        c.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="name">${escapeHtml(a.name)}</div>
            <button class="btn ghost star" aria-label="„ÅäÊ∞ó„Å´ÂÖ•„ÇäÂàáÊõø">${state.favs.has(a.name)?'‚≠ê':'‚òÜ'}</button>
          </div>
          <div class="row" style="gap:12px; align-items:center">
            <div class="chip"><b>ÂæÖ„Å°</b> ${waitTxt}</div>
            ${delta!=null? deltaHtml: ''}
            <div class="chip" style="background:color-mix(in srgb, var(--warn) 12%, transparent); border-color:color-mix(in srgb, var(--warn) 35%, transparent)"><b>Áä∂ÊÖã</b> ${escapeHtml(status)}</div>
          </div>
          <div class="meta">${escapeHtml(tagTxt)}</div>
          <div class="row" style="margin-top:8px">
            <a class="btn" href="${a.href}" target="_blank" rel="noopener">Ë©≥Á¥∞</a>
          </div>`;
        c.querySelector('.star').addEventListener('click',()=>toggleFav(a.name));
        cards.appendChild(c);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(a.name)}</td><td>${waitTxt}</td><td>${deltaHtml}</td><td>${escapeHtml(status)}</td><td>${escapeHtml(tagTxt)}</td><td><button class="btn star">${state.favs.has(a.name)?'‚≠ê':'‚òÜ'}</button></td>`;
        tr.querySelector('.star').addEventListener('click',()=>toggleFav(a.name));
        tbody.appendChild(tr);
      }
      renderFavQuick();
    }

    function renderDpa(){
      const list = $('#dpaList'); list.innerHTML='';
      for (const d of state.dpa){
        const badgeD = (/Ë≤©Â£≤‰∏≠|available|on/i.test(`${d.dpa}`))? `<span class="badge" style="border-color:color-mix(in srgb, var(--good) 50%, transparent)">DPA: Ë≤©Â£≤‰∏≠</span>` : `<span class="badge">DPA: ${escapeHtml(d.dpa||'‚Äî')}</span>`;
        const badgeP = (/Áô∫Ë°å‰∏≠|available|on/i.test(`${d.pp}`))? `<span class="badge" style="border-color:color-mix(in srgb, var(--good) 50%, transparent)">PP: Áô∫Ë°å‰∏≠</span>` : `<span class="badge">PP: ${escapeHtml(d.pp||'‚Äî')}</span>`;
        const deltaHtml = d.delta? `<span class="delta ${/Ë≤©Â£≤‰∏≠|on/i.test(`${d.dpa}`)?'up':'down'}">Â§âÂåñ</span>`: '<span class="mut">‚Äî</span>';
        const el = document.createElement('div'); el.className='card'; if (d.changed) el.classList.add('changed');
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="name">${escapeHtml(d.name)}</div>
            <div class="row">
              <button class="btn ghost hist">Â±•Ê≠¥</button>
              <button class="btn ghost star">${state.favs.has(d.name)?'‚≠ê':'‚òÜ'}</button>
            </div>
          </div>
          <div class="row" style="gap:8px; align-items:center">${badgeD} ${badgeP} ${deltaHtml}</div>
          <div class="meta">${escapeHtml((d.labels||[]).join(' / '))}</div>
          <div class="row" style="margin-top:8px"><a class="btn" href="${d.href}" target="_blank" rel="noopener">Ë©≥Á¥∞</a></div>
        `;
        el.querySelector('.star').addEventListener('click',()=>toggleFav(d.name));
        el.querySelector('.hist').addEventListener('click',()=>openHistoryFor(d.name));
        list.appendChild(el);
      }
    }

    function renderTimeline(){
      const tl = $('#tlList'); tl.innerHTML='';
      const changes = [];
      for (const q of state.queues){ if (Number.isFinite(q.delta) && q.delta!==0) changes.push({ t:new Date(), text:`${q.name} ÂæÖ„Å° ${q.delta>0?'+':''}${q.delta}ÂàÜ ‚Üí ${q.wait??'‚Äî'}ÂàÜ` }); }
      for (const d of state.dpa){ if (d.delta) changes.push({ t:new Date(), text:`${d.name} DPA/PP Áä∂ÊÖãÂ§âÂåñ` }); }
      if (!changes.length){ tl.innerHTML = '<div class="mut">Áõ¥Ëøë„ÅÆÂ§âÂåñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>'; return; }
      for (const it of changes.slice(0,12)){
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.borderBottom='1px solid var(--line)'; row.style.padding='6px 0';
        row.innerHTML = `<div>${escapeHtml(it.text)}</div><div class="mut" style="font-size:12px">${fmtTime(it.t)}</div>`;
        tl.appendChild(row);
      }
    }

    function renderFavQuick(){
      const wrap = $('#favsQuick'); const chips = $('#favChips'); chips.innerHTML='';
      const favArr = Array.from(state.favs); wrap.style.display = favArr.length? 'block':'none';
      for (const name of favArr){ const b = document.createElement('button'); b.className='pill'; b.textContent = `‚≠ê ${name}`; b.addEventListener('click',()=>{ $('#searchInput').value = name; state.filters.q = name; applyAndRender(); }); chips.appendChild(b); }
    }

    function renderFavList(){
      const list = $('#favList'); list.innerHTML='';
      for (const name of Array.from(state.favs)){
        const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.borderBottom='1px solid var(--line)'; row.style.padding='6px 0';
        row.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="row"><button class="btn ghost del">ÂâäÈô§</button><button class="btn ghost hist">Â±•Ê≠¥</button></div>`;
        row.querySelector('.del').addEventListener('click',()=>toggleFav(name));
        row.querySelector('.hist').addEventListener('click',()=>openHistoryFor(name));
        list.appendChild(row);
      }
    }

    function renderSchedule(){ const list = $('#schList'); list.innerHTML=''; state.schedule.forEach((it,idx)=>{ const row = document.createElement('div'); row.className='card'; row.draggable=true; row.dataset.idx = idx; row.innerHTML = `<div class="row" style="justify-content:space-between"><div>${escapeHtml(it)}</div><button class="btn ghost rm">ÂâäÈô§</button></div>`; row.querySelector('.rm').addEventListener('click',()=>{ state.schedule.splice(idx,1); saveSchedule(); renderSchedule(); }); row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); }); row.addEventListener('dragover', e=>{ e.preventDefault(); }); row.addEventListener('drop', e=>{ e.preventDefault(); const from = +e.dataTransfer.getData('text/plain'); const to = idx; moveSchedule(from,to); }); list.appendChild(row); }); }

    function applyFilters(items){
      let out = items;
      const q = state.filters.q.trim();
      if (q) out = out.filter(i=> `${i.name} ${(i.labels||[]).join(' ')}`.toLowerCase().includes(q.toLowerCase()));
      if (state.filters.fast) out = out.filter(i=> Number(i.wait) <= 20);
      if (state.filters.down) out = out.filter(i=> /‰ºëÊ≠¢|ÈÅãÂñ∂‰∏≠Ê≠¢|ÈÅãÂñ∂‰∏ÄÊôÇÂÅúÊ≠¢|closed|down/i.test(`${i.status}`));
      if (state.filters.favs) out = out.filter(i=> state.favs.has(i.name));
      if (state.filters.dpa || state.filters.pp){ const map = new Map(state.dpa.map(d=>[d.name,d])); out = out.filter(i=>{ const m = map.get(i.name); const dOn = m && /Ë≤©Â£≤‰∏≠|available|on/i.test(`${m.dpa}`); const pOn = m && /Áô∫Ë°å‰∏≠|available|on/i.test(`${m.pp}`); return (state.filters.dpa? dOn:true) && (state.filters.pp? pOn:true); }); }
      return out;
    }

    function applyAndRender(){ renderQueues(); renderSummary(); renderInsights(); }

    async function fetchQuietHours(){ try { const r = await fetch('/.netlify/functions/notify-all'); const j = await r.json().catch(()=>({})); if (j && typeof j.muted !== 'undefined') { $('#quietHoursHint').textContent = j.muted? 'ÈùôÈü≥ÊôÇÈñìÔºà22:00„Äú07:59Ôºâ‰∏≠Ôºöforce=1„ÅßÂº∑Âà∂ÈÄÅ‰ø°ÂèØ' : 'ÁèæÂú®„ÅØÈÄÅ‰ø°ÂèØËÉΩÊôÇÈñìÂ∏Ø„Åß„Åô'; } } catch {}
    }
    async function sendTestNotify(){ try { const r = await fetch('/.netlify/functions/notify-all?force=1'); const j = await r.json().catch(()=>({})); alert('„ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü
' + JSON.stringify(j)); } catch (e) { alert('„ÉÜ„Çπ„ÉàÈÄöÁü•„Å´Â§±Êïó: '+(e?.message||e)); } }
    async function fetchNotifLogs(){ try { await ensureEnv(); const url = `${ENV.SUPABASE_URL}/rest/v1/notifications?select=*&order=id.desc&limit=20`; const r = await fetch(url, { headers: { 'apikey': ENV.SUPABASE_ANON_KEY, 'Authorization': `Bearer ${ENV.SUPABASE_ANON_KEY}` }}); const arr = await r.json(); const list = $('#notifList'); list.innerHTML=''; (Array.isArray(arr)?arr:[]).forEach(n=>{ const t = new Date(n.created_at || n.inserted_at || Date.now()); const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.borderBottom='1px solid var(--line)'; row.style.padding='6px 0'; row.innerHTML = `<div><b>${escapeHtml(n.title||'-')}</b><div class="mut" style="font-size:12px">${escapeHtml(n.body||'')}</div></div><div class="mut" style="font-size:12px">${t.toLocaleString('ja-JP')}</div>`; list.appendChild(row); }); } catch (e) { $('#notifList').textContent = 'Â±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'; } }

    function toggleFav(name){ if (state.favs.has(name)) state.favs.delete(name); else state.favs.add(name); localStorage.setItem('favs', JSON.stringify(Array.from(state.favs))); applyAndRender(); renderDpa(); renderFavList(); }
    function saveSchedule(){ localStorage.setItem('schedule', JSON.stringify(state.schedule)); }
    function moveSchedule(from,to){ if (from===to) return; const [x]=state.schedule.splice(from,1); state.schedule.splice(to,0,x); saveSchedule(); renderSchedule(); }

    let startY=null, pulling=false;
    document.addEventListener('touchstart', e=>{ startY = e.touches?.[0]?.clientY ?? 0; pulling=false; }, {passive:true});
    document.addEventListener('touchmove', e=>{ if (window.scrollY>0 || startY==null) return; const dy = (e.touches?.[0]?.clientY ?? 0) - startY; if (dy>20){ pulling=true; $('#pullRefresh').classList.add('show'); } }, {passive:true});
    document.addEventListener('touchend', async ()=>{ if (!pulling) { $('#pullRefresh').classList.remove('show'); return; } $('#pullRefresh').querySelector('.badge').textContent='Êõ¥Êñ∞‰∏≠...'; try { await refreshAll(); } finally { await sleep(300); $('#pullRefresh').classList.remove('show'); $('#pullRefresh').querySelector('.badge').textContent='‰∏ã„Å´Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞'; } }, {passive:true});
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) { refreshAll(); } });

    initAutoRefresh();
    function initAutoRefresh(){ setAutoSec(state.autoSec); $('#autoOff').addEventListener('click',()=>setAutoSec(0)); $('#auto15').addEventListener('click',()=>setAutoSec(15)); $('#auto30').addEventListener('click',()=>setAutoSec(30)); $('#auto60').addEventListener('click',()=>setAutoSec(60)); }
    function setAutoSec(sec){ state.autoSec = sec; localStorage.setItem('autoSec', String(sec)); ['autoOff','auto15','auto30','auto60'].forEach(id=>{ const btn = $('#'+id); const s = +btn.dataset.sec||0; btn.classList.toggle('active', s===sec); btn.setAttribute('aria-pressed', String(s===sec)); }); if (autoTimer) clearInterval(autoTimer); if (sec>0){ autoRemain = sec; $('#autoCountdown').textContent = autoRemain+'s'; autoTimer = setInterval(()=>{ if (document.hidden) return; autoRemain--; if (autoRemain<=0){ autoRemain = sec; refreshAll(); } $('#autoCountdown').textContent = autoRemain+'s'; }, 1000); } else { $('#autoCountdown').textContent='‚Äî'; } }

    $('#btnRefresh').addEventListener('click', refreshAll);
    $('#btnFetchDpa').addEventListener('click', async ()=>{ await fetchDpa(); renderDpa(); renderSummary(); renderInsights(); });
    $('#btnCopyOn').addEventListener('click', copyCurrentOn);
    $('#btnHistoryAll').addEventListener('click', async ()=>{ await openHistoryFor(); });
    $('#btnHistoryClose').addEventListener('click', closeHistory);
    $('#histFavsOnly').addEventListener('click', ()=>{ const on = !($('#histFavsOnly').getAttribute('aria-pressed')==='true'); $('#histFavsOnly').setAttribute('aria-pressed', String(on)); $('#histFavsOnly').classList.toggle('active', on); refreshHistoryLast(); });

    $('#parkTDL').addEventListener('click',()=>switchPark(274));
    $('#parkTDS').addEventListener('click',()=>switchPark(275));
    $('#viewCards').addEventListener('click',()=>switchView('cards'));
    $('#viewTable').addEventListener('click',()=>switchView('table'));
    $('#searchInput').addEventListener('input', e=>{ state.filters.q = e.target.value; applyAndRender(); });

    $('#fltFast').addEventListener('click', e=>toggleBtn(e,'fast'));
    $('#fltDPA').addEventListener('click', e=>toggleBtn(e,'dpa'));
    $('#fltPP').addEventListener('click',  e=>toggleBtn(e,'pp'));
    $('#fltDown').addEventListener('click',e=>toggleBtn(e,'down'));
    $('#fltFavs').addEventListener('click',e=>toggleBtn(e,'favs'));
    $('#btnClear').addEventListener('click',()=>{ state.filters={fast:false,dpa:false,pp:false,down:false,favs:false,q:''}; $$('#controls .btn').forEach(b=>b.classList.remove('active')); $('#searchInput').value=''; applyAndRender(); });

    $('#btnFavExport').addEventListener('click',()=>{ const txt = Array.from(state.favs).join('
'); navigator.clipboard?.writeText(txt); alert('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏Êõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü'); });
    $('#btnFavImport').addEventListener('click',()=>{ const txt = prompt('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÇíÊîπË°åÂå∫Âàá„Çä„ÅßË≤º„Çä‰ªò„Åë'); if (!txt) return; txt.split(/
?
/).map(s=>s.trim()).filter(Boolean).forEach(n=>state.favs.add(n)); localStorage.setItem('favs', JSON.stringify(Array.from(state.favs))); renderFavQuick(); renderFavList(); applyAndRender(); });

    $('#schAdd').addEventListener('click',()=>{ const v = $('#schInput').value.trim(); if(!v) return; state.schedule.push(v); $('#schInput').value=''; saveSchedule(); renderSchedule(); });
    $('#schClear').addEventListener('click',()=>{ if(confirm('‰∫àÂÆö„ÇíÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü')){ state.schedule=[]; saveSchedule(); renderSchedule(); }});

    $('#btnTestNotify').addEventListener('click', sendTestNotify);
    $('#btnFetchNotifs').addEventListener('click', fetchNotifLogs);

    $$('.bottom .nav-item').forEach(btn=>btn.addEventListener('click',()=>{ const m = {qt:'#qtAnchor', dpa:'#dpaAnchor', favs:'#favsAnchor', schedule:'#scheduleAnchor', insight:'#insight'}; const el = $(m[btn.dataset.target]); if (!el) return; window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 56, behavior:'smooth' }); $$('.bottom .nav-item').forEach(b=>b.classList.toggle('active', b===btn)); }));

    $('#btnShare').addEventListener('click', shareState);

    (async function init(){ try { const h = location.hash; const m = h.match(/#S=([^&]+)/); if (m){ const json = atob(decodeURIComponent(m[1])); const obj = JSON.parse(json); restoreState(obj); } } catch{} await ensureEnv(); await refreshAll(); renderSchedule(); fetchQuietHours(); })();

    async function refreshAll(){ await Promise.all([fetchQueues(), fetchDpa()]); state.lastFetchAt = Date.now(); renderQueues(); renderDpa(); renderSummary(); renderInsights(); renderTimeline(); renderFavList(); }

    function switchPark(id){ state.park = id; $('#parkTDL').classList.toggle('active', id===274); $('#parkTDS').classList.toggle('active', id===275); refreshAll(); }
    function switchView(v){ state.view = v; $('#viewCards').classList.toggle('active', v==='cards'); $('#viewTable').classList.toggle('active', v==='table'); $('#qtCards').style.display = v==='cards'? 'grid':'none'; $('#qtTableWrap').style.display = v==='table'? 'block':'none'; }
    function toggleBtn(e,key){ const b = e.currentTarget; const on = !b.classList.contains('active'); b.classList.toggle('active', on); state.filters[key]=on; applyAndRender(); }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function fmtTime(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getHours()}:${p(d.getMinutes())}`; }
    function indexByName(list){ const m={}; for(const it of list){ m[it.name]=it; } return m; }
    function withDelta(list, prevMap, valFn){ return list.map(it=>{ const prev = prevMap[it.name]; let delta=null, changed=false; if (prev){ const a = valFn(it); const b = valFn(prev); if (a!=null && b!=null && a!=='' && b!=='' && a!==b){ if (typeof a==='number' && typeof b==='number') delta = a-b; else delta = 1; changed = true; } } return {...it, delta, changed}; }); }

    async function shareState(){ const snapshot = { park: state.park, view: state.view, filters: state.filters, favs: Array.from(state.favs), theme: state.theme, density: state.density, contrast: state.contrast, autoSec: state.autoSec }; const encoded = encodeURIComponent(btoa(JSON.stringify(snapshot))); const url = location.origin + location.pathname + '#S=' + encoded; try { if (navigator.share) await navigator.share({ title: 'TDR Now', url }); else { await navigator.clipboard.writeText(url); alert('ÂÖ±ÊúâURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'); } } catch {} }
    function restoreState(obj){ try { if (obj.park) state.park = obj.park; if (obj.view) switchView(obj.view); if (obj.filters) state.filters = {...state.filters, ...obj.filters}; if (Array.isArray(obj.favs)) state.favs = new Set(obj.favs); if (obj.theme) setTheme(obj.theme); if (obj.density) setDensity(obj.density); if (obj.contrast) setContrast(obj.contrast); if (typeof obj.autoSec==='number') setAutoSec(obj.autoSec); } catch {} if (state.filters.fast) $('#fltFast').classList.add('active'); if (state.filters.dpa) $('#fltDPA').classList.add('active'); if (state.filters.pp) $('#fltPP').classList.add('active'); if (state.filters.down) $('#fltDown').classList.add('active'); if (state.filters.favs) $('#fltFavs').classList.add('active'); }

    // === Â±•Ê≠¥ UI ===
    let lastHistory = null; let lastFilterName = null;
    async function openHistoryFor(name){ lastFilterName = name||null; $('#histScope').textContent = name? `Ôºà${name}Ôºâ` : 'ÔºàÂÖ®‰ΩìÔºâ'; $('#historySheet').style.display='flex'; await refreshHistoryLast(); }
    async function refreshHistoryLast(){ const favsOnly = $('#histFavsOnly').getAttribute('aria-pressed')==='true'; const data = await fetchHistory(lastFilterName); lastHistory = data; const list = $('#histList'); list.innerHTML=''; const items = favsOnly? data.items.filter(x=>state.favs.has(x.name)) : data.items; if (!items.length){ list.innerHTML = '<div class="mut">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'; return; } for (const ev of items){ const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.borderBottom='1px solid var(--line)'; row.style.padding='6px 0'; const desc = `„Äê${escapeHtml(ev.name)}„Äë DPA:${escapeHtml(ev.dpa)} / PP:${escapeHtml(ev.pp)}`; row.innerHTML = `<div>${desc}</div><div class="mut" style="font-size:12px">${ev.t.toLocaleString('ja-JP')}</div>`; list.appendChild(row); } }
    function closeHistory(){ $('#historySheet').style.display='none'; }

    // === ON ‰∏ÄË¶ß„Ç≥„Éî„Éº ===
    function copyCurrentOn(){ const ons = state.dpa.filter(d=>/Ë≤©Â£≤‰∏≠|Áô∫Ë°å‰∏≠|available|on/i.test(`${d.dpa}|${d.pp}`)).map(d=>`„Éª${d.name} [DPA:${d.dpa} / PP:${d.pp}]`); const txt = ons.join('
') || 'ÔºàÁèæÂú®ON„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ'; navigator.clipboard?.writeText(txt); alert('ÁèæÂú®ON„ÅÆ‰∏ÄË¶ß„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'); }

  })();
  </script>
</body>
</html>
